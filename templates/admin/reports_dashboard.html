{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="card shadow-sm border-0 rounded-3 mb-4">
        <div class="card-body">
            <div class="header-section">
                <div class="header-title">
                    <div class="icon-circle bg-primary-subtle text-primary">
                        <span class="material-icons">report</span>
                    </div>
                    <div>
                        <div class="d-flex align-items-center gap-2">
                            <h4 class="mb-0">Submitted Reports</h4>
                            <div class="badge bg-primary-subtle text-primary rounded-pill">
                                Total: {{ total_reports }}
                            </div>
                        </div>
                        <p class="text-muted mb-0 small">Manage and track user submitted reports</p>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="btn btn-primary d-flex align-items-center gap-2" id="exportCSV">
                        <span class="material-icons">file_download</span>
                        <span class="d-none d-sm-inline">Export Reports</span>
                        <span class="d-inline d-sm-none">Export</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards Row -->
    <div class="row g-4 mb-4">
        <!-- Total Reports Card -->
        <div class="col-6 col-md-6 col-xl-3">
            <div class="card stat-card h-100 shadow-sm border-0 rounded-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-uppercase mb-2 stat-label">Total Reports</p>
                            <h2 class="mb-0 stat-value">{{ total_reports }}</h2>
                        </div>
                        <div class="stat-icon bg-primary-subtle text-primary">
                            <span class="material-icons">description</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pending Reports Card -->
        <div class="col-6 col-md-6 col-xl-3">
            <div class="card stat-card h-100 shadow-sm border-0 rounded-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-uppercase mb-2 stat-label">Pending</p>
                            <h2 class="mb-0 stat-value">{{ pending_reports }}</h2>
                        </div>
                        <div class="stat-icon bg-warning-subtle text-warning">
                            <span class="material-icons">pending</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- In Progress Reports Card -->
        <div class="col-6 col-md-6 col-xl-3">
            <div class="card stat-card h-100 shadow-sm border-0 rounded-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-uppercase mb-2 stat-label">Under Review</p>
                            <h2 class="mb-0 stat-value">{{ in_progress_reports }}</h2>
                        </div>
                        <div class="stat-icon bg-info-subtle text-info">
                            <span class="material-icons">hourglass_top</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Resolved Reports Card -->
        <div class="col-6 col-md-6 col-xl-3">
            <div class="card stat-card h-100 shadow-sm border-0 rounded-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-uppercase mb-2 stat-label">Resolved</p>
                            <h2 class="mb-0 stat-value">{{ resolved_reports }}</h2>
                        </div>
                        <div class="stat-icon bg-success-subtle text-success">
                            <span class="material-icons">task_alt</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="card mb-4 shadow-sm border-0 rounded-3">
        <div class="card-header bg-transparent py-3 border-0">
            <div class="d-flex align-items-center">
                <span class="material-icons text-primary me-2">filter_list</span>
                <h5 class="mb-0">Filter Reports</h5>
            </div>
        </div>
        <div class="card-body">
            <form id="reportsFilterForm" method="get" class="row g-3">
                <!-- Date Range Filter -->
                <div class="col-12 col-sm-6 col-lg-3">
                    <div class="form-floating">
                        <input type="date" class="form-control" id="dateFrom" name="date_from" value="{{ date_from }}">
                        <label for="dateFrom">Date From</label>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-lg-3">
                    <div class="form-floating">
                        <input type="date" class="form-control" id="dateTo" name="date_to" value="{{ date_to }}">
                        <label for="dateTo">Date To</label>
                    </div>
                </div>
                
                <!-- User ID Filter -->
                <div class="col-12 col-sm-6 col-lg-2">
                    <div class="form-floating">
                        <input type="text" class="form-control" id="userId" name="user_id" value="{{ user_id }}" placeholder="Enter user ID">
                        <label for="userId">User ID</label>
                    </div>
                </div>
                
                <!-- Status Filter -->
                <div class="col-12 col-sm-6 col-lg-2">
                    <div class="form-floating">
                        <select class="form-select" id="status" name="status">
                            <option value="">All Statuses</option>
                            {% for code, label in status_choices %}
                            <option value="{{ code }}" {% if selected_status == code %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                        <label for="status">Status</label>
                    </div>
                </div>
                
                <!-- Report Type Filter -->
                <div class="col-12 col-sm-6 col-lg-2">
                    <div class="form-floating">
                        <select class="form-select" id="type" name="type">
                            <option value="">All Types</option>
                            {% for code, label in report_types %}
                            <option value="{{ code }}" {% if selected_type == code %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                        <label for="type">Report Type</label>
                    </div>
                </div>
                
                <!-- Button Group -->
                <div class="col-12 d-flex gap-2 justify-content-end mt-4">
                    <button type="reset" class="btn btn-light" id="resetFilterBtn">
                        <span class="material-icons align-middle me-1">restart_alt</span>Reset
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <span class="material-icons align-middle me-1">filter_alt</span>Apply Filters
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Reports Table/Cards -->
    <div class="card shadow-sm border-0 rounded-3">
        <div class="card-header bg-transparent py-3 d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Submitted Reports</h5>
            <div class="export-options">
                <button class="btn btn-sm btn-outline-secondary" id="exportCSV">
                    <span class="material-icons align-middle me-1">file_download</span>Export
                </button>
            </div>
        </div>
        <div class="card-body p-0">
            <!-- Desktop Table View -->
            <div class="table-responsive d-none d-md-block">
                <table class="table table-hover align-middle mb-0" id="reportsTable">
                    <thead>
                        <tr>
                            <th scope="col" class="sortable" data-sort="id">Report ID</th>
                            <th scope="col" class="sortable" data-sort="user">Submitted By</th>
                            <th scope="col" class="sortable" data-sort="type">Type</th>
                            <th scope="col" class="sortable" data-sort="created_at">Date Submitted</th>
                            <th scope="col" class="sortable" data-sort="status">Status</th>
                            <th scope="col">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if reports %}
                            {% for report in reports %}
                            <tr>
                                <td>#{{ report.id }}</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="avatar-container me-2">
                                            {% if report.user.userprofile.avatar %}
                                                <img src="{{ report.user.userprofile.avatar.url }}" alt="User avatar" class="avatar rounded-circle">
                                            {% else %}
                                                <div class="avatar-placeholder rounded-circle d-flex align-items-center justify-content-center bg-light">
                                                    <span class="material-icons text-secondary">person</span>
                                                </div>
                                            {% endif %}
                                        </div>
                                        <div class="user-info">
                                            <div class="fw-semibold">{{ report.user.get_full_name|default:report.user.username }}</div>
                                            <small class="text-muted">#{{ report.user.id }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td>{{ report.get_type_display }}</td>
                                <td>{{ report.created_at|date:"M d, Y H:i" }}</td>
                                <td>
                                    {% if report.status == 'PENDING' %}
                                    <span class="badge rounded-pill text-bg-warning">Pending</span>
                                    {% elif report.status == 'IN_PROGRESS' %}
                                    <span class="badge rounded-pill text-bg-primary">Under Review</span>
                                    {% elif report.status == 'RESOLVED' %}
                                    <span class="badge rounded-pill text-bg-success">Resolved</span>
                                    {% elif report.status == 'CLOSED' %}
                                    <span class="badge rounded-pill text-bg-danger">Rejected</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button type="button" class="btn btn-action btn-view view-report-btn" 
                                                data-report-id="{{ report.id }}" 
                                                title="View Details">
                                            <span class="material-icons">visibility</span>
                                        </button>
                                        {% if report.status == 'PENDING' %}
                                        <button type="button" class="btn btn-action btn-review review-report-btn" 
                                                data-report-id="{{ report.id }}" 
                                                title="Review Report">
                                            <span class="material-icons">rate_review</span>
                                        </button>
                                        {% endif %}
                                        {% if report.status == 'IN_PROGRESS' %}
                                        <button type="button" class="btn btn-action btn-resolve resolve-report-btn" 
                                                data-report-id="{{ report.id }}" 
                                                title="Resolve Report">
                                            <span class="material-icons">check_circle</span>
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="6" class="text-center py-4">
                                    <div class="empty-state">
                                        <span class="material-icons empty-icon mb-2" style="font-size: 3rem; color: #e5e7eb;">report_off</span>
                                        <p class="mb-0 text-muted">No reports found matching your filters</p>
                                    </div>
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>

            <!-- Mobile Card View -->
            <div class="d-md-none">
                {% if reports %}
                <div class="mobile-reports">
                    {% for report in reports %}
                    <div class="mobile-report-card p-3 border-bottom">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <div class="fw-bold">#{{ report.id }}</div>
                                <div class="text-muted small">{{ report.created_at|date:"M d, Y H:i" }}</div>
                            </div>
                            {% if report.status == 'PENDING' %}
                            <span class="badge rounded-pill text-bg-warning">Pending</span>
                            {% elif report.status == 'IN_PROGRESS' %}
                            <span class="badge rounded-pill text-bg-primary">Under Review</span>
                            {% elif report.status == 'RESOLVED' %}
                            <span class="badge rounded-pill text-bg-success">Resolved</span>
                            {% elif report.status == 'CLOSED' %}
                            <span class="badge rounded-pill text-bg-danger">Rejected</span>
                            {% endif %}
                        </div>

                        <div class="d-flex align-items-center mb-3">
                            <div class="avatar-container me-2">
                                {% if report.user.userprofile.avatar %}
                                <img src="{{ report.user.userprofile.avatar.url }}" alt="User avatar" class="avatar rounded-circle">
                                {% else %}
                                <div class="avatar-placeholder rounded-circle d-flex align-items-center justify-content-center bg-light">
                                    <span class="material-icons text-secondary">person</span>
                                </div>
                                {% endif %}
                            </div>
                            <div class="user-info">
                                <div class="fw-semibold">{{ report.user.get_full_name|default:report.user.username }}</div>
                                <small class="text-muted">#{{ report.user.id }}</small>
                            </div>
                        </div>

                        <div class="report-details mb-3">
                            <div class="mb-2">
                                <span class="text-muted">Type:</span>
                                <span class="ms-1">{{ report.get_type_display }}</span>
                            </div>
                        </div>

                        <div class="action-buttons d-flex gap-2">
                            <button type="button" class="btn btn-action btn-view flex-grow-1 view-report-btn" 
                                    data-report-id="{{ report.id }}" 
                                    title="View Details">
                                <span class="material-icons me-2">visibility</span>
                                <span>View Details</span>
                            </button>
                            {% if report.status == 'PENDING' %}
                            <button type="button" class="btn btn-action btn-review flex-grow-1 review-report-btn" 
                                    data-report-id="{{ report.id }}" 
                                    title="Review Report">
                                <span class="material-icons me-2">rate_review</span>
                                <span>Review</span>
                            </button>
                            {% endif %}
                            {% if report.status == 'IN_PROGRESS' %}
                            <button type="button" class="btn btn-action btn-resolve flex-grow-1 resolve-report-btn" 
                                    data-report-id="{{ report.id }}" 
                                    title="Resolve Report">
                                <span class="material-icons me-2">check_circle</span>
                                <span>Resolve</span>
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-4">
                    <div class="empty-state">
                        <span class="material-icons empty-icon mb-2" style="font-size: 3rem; color: #e5e7eb;">report_off</span>
                        <p class="mb-0 text-muted">No reports found matching your filters</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Report Details Modal -->
    <div class="modal fade" id="reportDetailsModal" tabindex="-1" aria-labelledby="reportDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content rounded-3 border-0 shadow">
                <div class="modal-header">
                    <h5 class="modal-title" id="reportDetailsModalLabel">Report Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="report-loading d-flex justify-content-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    <div id="reportContent" class="d-none">
                        <!-- User Information Section -->
                        <div class="mb-4">
                            <h6 class="text-uppercase fw-bold mb-3 border-bottom pb-2">User Information</h6>
                            <div class="row g-3" id="userInfoSection">
                                <div class="col-md-6">
                                    <div class="mb-2">
                                        <span class="fw-semibold d-block">Full Name:</span>
                                        <span id="userName">John Doe</span>
                                    </div>
                                    <div class="mb-2">
                                        <span class="fw-semibold d-block">Email:</span>
                                        <span id="userEmail">john@example.com</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-2">
                                        <span class="fw-semibold d-block">License Number:</span>
                                        <span id="userLicense">ABC123456</span>
                                    </div>
                                    <div class="mb-2">
                                        <span class="fw-semibold d-block">Contact Number:</span>
                                        <span id="userContact">(123) 456-7890</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Report Details Section -->
                        <div class="mb-4">
                            <h6 class="text-uppercase fw-bold mb-3 border-bottom pb-2">Report Details</h6>
                            <div class="row g-3" id="reportDetailsSection">
                                <div class="col-md-6">
                                    <div class="mb-2">
                                        <span class="fw-semibold d-block">Report Type:</span>
                                        <span id="reportType">Traffic Complaint</span>
                                    </div>
                                    <div class="mb-2">
                                        <span class="fw-semibold d-block">Subject:</span>
                                        <span id="reportSubject">Broken Traffic Light</span>
                                    </div>
                                    <div class="mb-2">
                                        <span class="fw-semibold d-block">Status:</span>
                                        <span id="reportStatus" class="badge rounded-pill text-bg-warning">Pending</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-2">
                                        <span class="fw-semibold d-block">Date Submitted:</span>
                                        <span id="reportDate">Jan 15, 2023</span>
                                    </div>
                                    <div class="mb-2">
                                        <span class="fw-semibold d-block">Location:</span>
                                        <span id="reportLocation">Main Street & 5th Avenue</span>
                                    </div>
                                    <div class="mb-2">
                                        <span class="fw-semibold d-block">Incident Date:</span>
                                        <span id="incidentDate">Jan 14, 2023</span>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="mb-2">
                                        <span class="fw-semibold d-block">Description:</span>
                                        <p id="reportDescription" class="mt-2 bg-light p-3 rounded">
                                            Report description will appear here.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Attachment Section -->
                        <div class="mb-4" id="attachmentSection">
                            <h6 class="text-uppercase fw-bold mb-3 border-bottom pb-2">Attachments & Evidence</h6>
                            <div id="attachmentList" class="p-3 bg-light rounded">
                                <div class="attachment-item d-none">
                                    <a href="#" class="d-flex align-items-center p-2 text-decoration-none text-dark hover-bg-light rounded">
                                        <span class="material-icons me-2 text-primary">insert_drive_file</span>
                                        <span class="attachment-name">document.pdf</span>
                                    </a>
                                </div>
                                <div class="no-attachments text-center py-2 text-muted">
                                    <span class="material-icons d-block mb-2">folder_off</span>
                                    No attachments provided
                                </div>
                            </div>
                        </div>
                        
                        <!-- Admin Notes Section -->
                        <div id="adminNotesSection">
                            <h6 class="text-uppercase fw-bold mb-3 border-bottom pb-2">Admin Notes & Decision</h6>
                            <div class="admin-notes bg-light p-3 rounded mb-3">
                                <div id="existingNotes">
                                    <p class="mb-1"><strong>Status:</strong> <span id="currentStatus">Pending</span></p>
                                    <p class="mb-1"><strong>Assigned To:</strong> <span id="assignedTo">Not assigned</span></p>
                                    <p class="mb-0"><strong>Notes:</strong></p>
                                    <p id="resolutionNotes" class="mb-0 mt-2">No notes yet.</p>
                                </div>
                            </div>
                            
                            <div id="actionForm" class="mt-3">
                                <form id="reportActionForm">
                                    <input type="hidden" id="reportIdField" name="report_id">
                                    <div class="mb-3">
                                        <label for="statusChange" class="form-label">Update Status</label>
                                        <select class="form-select" id="statusChange" name="status" required>
                                            <option value="">Select status</option>
                                            <option value="IN_PROGRESS">Mark as Under Review</option>
                                            <option value="RESOLVED">Mark as Resolved</option>
                                            <option value="CLOSED">Reject Report</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="adminNotes" class="form-label">Admin Notes</label>
                                        <textarea class="form-control" id="adminNotes" name="notes" rows="3" placeholder="Add your notes or decision details here..."></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="notifyUser" name="notify_user" checked>
                                            <label class="form-check-label" for="notifyUser">
                                                Notify user about this update
                                            </label>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="submitActionBtn">
                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Enhanced Header Section Styles */
    .header-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
    }

    .header-title {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .icon-circle {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.2s ease;
    }

    .icon-circle:hover {
        transform: scale(1.05);
    }

    .icon-circle .material-icons {
        font-size: 24px;
    }

    /* Stats Card Styling */
    .stat-card {
        transition: all 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.1) !important;
    }

    .stat-label {
        font-size: 0.75rem;
        font-weight: 600;
        letter-spacing: 0.5px;
        color: var(--bs-gray-600);
        margin-bottom: 0.5rem;
    }

    .stat-value {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--bs-gray-900);
        line-height: 1;
    }

    .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .stat-icon .material-icons {
        font-size: 24px;
    }

    /* Skeleton Loader Styles */
    .skeleton-loader {
        animation: skeleton-loading 1s infinite alternate;
    }

    .skeleton-title {
        height: 12px;
        background-color: #e9ecef;
        border-radius: 4px;
        margin-bottom: 8px;
        width: 60%;
    }

    .skeleton-value {
        height: 24px;
        background-color: #e9ecef;
        border-radius: 4px;
        width: 40%;
    }

    .skeleton-text {
        height: 16px;
        background-color: #e9ecef;
        border-radius: 4px;
        width: 100%;
    }

    @keyframes skeleton-loading {
        0% {
            opacity: 0.6;
        }
        100% {
            opacity: 1;
        }
    }

    /* Responsive Adjustments */
    @media (max-width: 767.98px) {
        .header-section {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }

        .header-actions {
            width: 100%;
        }

        .header-actions .btn {
            width: 100%;
            justify-content: center;
        }

        .stat-card {
            margin-bottom: 1rem;
        }

        .stat-value {
            font-size: 1.5rem;
        }

        .stat-icon {
            width: 40px;
            height: 40px;
        }

        .stat-icon .material-icons {
            font-size: 20px;
        }
    }

    /* Form Floating Label Enhancements */
    .form-floating > .form-control,
    .form-floating > .form-select {
        height: calc(3.5rem + 2px);
        line-height: 1.25;
    }

    .form-floating > label {
        padding: 1rem 0.75rem;
    }

    /* Table Enhancements */
    .table th {
        font-size: 0.875rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        background-color: var(--bs-gray-100);
        padding: 1rem;
    }

    .table td {
        padding: 1rem;
        vertical-align: middle;
    }

    /* Action Button Enhancements */
    .btn-action {
        width: 36px;
        height: 36px;
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        transition: all 0.2s ease;
    }

    .btn-action:hover {
        transform: translateY(-2px);
    }

    .btn-action .material-icons {
        font-size: 20px;
    }

    /* Mobile Card View Styles */
    .mobile-report-card {
        background-color: #fff;
        transition: background-color 0.2s ease;
    }

    .mobile-report-card:hover {
        background-color: var(--bs-gray-100);
    }

    .mobile-report-card .btn-action {
        width: auto;
        height: auto;
        padding: 0.5rem 1rem;
        border: 1px solid var(--bs-gray-200);
        background-color: #fff;
        color: var(--bs-gray-700);
    }

    .mobile-report-card .btn-view {
        background-color: var(--bs-primary-subtle);
        color: var(--bs-primary);
        border-color: var(--bs-primary-subtle);
    }

    .mobile-report-card .btn-review {
        background-color: var(--bs-warning-subtle);
        color: var(--bs-warning);
        border-color: var(--bs-warning-subtle);
    }

    .mobile-report-card .btn-resolve {
        background-color: var(--bs-success-subtle);
        color: var(--bs-success);
        border-color: var(--bs-success-subtle);
    }

    .mobile-report-card .btn-action:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .mobile-report-card .avatar,
    .mobile-report-card .avatar-placeholder {
        width: 40px;
        height: 40px;
    }

    .mobile-report-card .badge {
        font-size: 0.75rem;
        padding: 0.5em 0.75em;
    }

    /* Loading Skeleton for Mobile Cards */
    .mobile-skeleton-card {
        padding: 1rem;
        border-bottom: 1px solid var(--bs-gray-200);
    }

    .mobile-skeleton-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 1rem;
    }

    .mobile-skeleton-id {
        width: 60px;
        height: 20px;
    }

    .mobile-skeleton-badge {
        width: 80px;
        height: 24px;
        border-radius: 12px;
    }

    .mobile-skeleton-user {
        display: flex;
        align-items: center;
        margin-bottom: 1rem;
    }

    .mobile-skeleton-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 1rem;
    }

    .mobile-skeleton-details {
        flex-grow: 1;
    }

    .mobile-skeleton-name {
        width: 120px;
        height: 16px;
        margin-bottom: 0.5rem;
    }

    .mobile-skeleton-info {
        width: 80px;
        height: 14px;
    }

    /* Update Loading Skeleton */
    #loading-skeleton .mobile-reports {
        display: none;
    }

    @media (max-width: 767.98px) {
        #loading-skeleton .table-responsive {
            display: none !important;
        }

        #loading-skeleton .mobile-reports {
            display: block;
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize filter form
        const filterForm = document.getElementById('reportsFilterForm');
        const resetBtn = document.getElementById('resetFilterBtn');
        
        // Reset button functionality
        resetBtn.addEventListener('click', function() {
            filterForm.reset();
            // Reset the URL to remove query parameters
            window.location.href = window.location.pathname;
        });
        
        // Table sorting functionality
        const table = document.getElementById('reportsTable');
        const headers = table.querySelectorAll('th.sortable');
        
        headers.forEach(header => {
            header.addEventListener('click', () => {
                const sortColumn = header.dataset.sort;
                const currentSort = header.classList.contains('sort-asc') ? 'desc' : 'asc';
                
                // Reset sort indicators
                headers.forEach(h => {
                    h.classList.remove('sort-asc', 'sort-desc');
                });
                
                // Set new sort indicator
                header.classList.add(`sort-${currentSort}`);
                
                // Actual sorting would be implemented with backend pagination
                // Here we're preparing the URL for server-side sorting
                const url = new URL(window.location);
                url.searchParams.set('sort', sortColumn);
                url.searchParams.set('order', currentSort);
                
                // In a real application, you'd reload with the new URL
                // window.location = url;
                console.log(`Sorting by ${sortColumn} in ${currentSort} order`);
            });
        });
        
        // View Report Button Functionality
        const viewButtons = document.querySelectorAll('.view-report-btn');
        const reportDetailsModal = new bootstrap.Modal(document.getElementById('reportDetailsModal'));
        const reportContent = document.getElementById('reportContent');
        const reportLoading = document.querySelector('.report-loading');
        
        viewButtons.forEach(button => {
            button.addEventListener('click', () => {
                const reportId = button.dataset.reportId;
                
                // Show modal with loading state
                reportContent.classList.add('d-none');
                reportLoading.classList.remove('d-none');
                reportDetailsModal.show();
                
                // In a real application, you'd fetch the report details
                // For demo, simulate loading with timeout
                setTimeout(() => {
                    // Hide loading, show content
                    reportLoading.classList.add('d-none');
                    reportContent.classList.remove('d-none');
                    
                    // Populate modal with actual report data (would be AJAX in real app)
                    document.getElementById('reportIdField').value = reportId;
                    
                    // Example visualization - in real app this would come from AJAX
                    populateReportDetails(reportId);
                }, 800);
            });
        });
        
        // Review and Resolve button handlers
        const reviewButtons = document.querySelectorAll('.review-report-btn');
        const resolveButtons = document.querySelectorAll('.resolve-report-btn');
        
        reviewButtons.forEach(button => {
            button.addEventListener('click', () => {
                const reportId = button.dataset.reportId;
                
                // Show modal with loading state
                reportContent.classList.add('d-none');
                reportLoading.classList.remove('d-none');
                reportDetailsModal.show();
                
                // In a real application, you'd fetch the report details
                setTimeout(() => {
                    // Hide loading, show content
                    reportLoading.classList.add('d-none');
                    reportContent.classList.remove('d-none');
                    
                    // Populate modal with actual report data
                    document.getElementById('reportIdField').value = reportId;
                    populateReportDetails(reportId);
                    
                    // Pre-select "Under Review" in the status dropdown
                    document.getElementById('statusChange').value = 'IN_PROGRESS';
                }, 800);
            });
        });
        
        resolveButtons.forEach(button => {
            button.addEventListener('click', () => {
                const reportId = button.dataset.reportId;
                
                // Show modal with loading state
                reportContent.classList.add('d-none');
                reportLoading.classList.remove('d-none');
                reportDetailsModal.show();
                
                // In a real application, you'd fetch the report details
                setTimeout(() => {
                    // Hide loading, show content
                    reportLoading.classList.add('d-none');
                    reportContent.classList.remove('d-none');
                    
                    // Populate modal with actual report data
                    document.getElementById('reportIdField').value = reportId;
                    populateReportDetails(reportId);
                    
                    // Pre-select "Resolved" in the status dropdown
                    document.getElementById('statusChange').value = 'RESOLVED';
                }, 800);
            });
        });
        
        // Save Changes Button
        const saveButton = document.getElementById('submitActionBtn');
        saveButton.addEventListener('click', function() {
            // Show loading spinner
            const spinner = saveButton.querySelector('.spinner-border');
            spinner.classList.remove('d-none');
            saveButton.disabled = true;
            
            // Get form data
            const form = document.getElementById('reportActionForm');
            const reportId = document.getElementById('reportIdField').value;
            const status = document.getElementById('statusChange').value;
            const notes = document.getElementById('adminNotes').value;
            const notifyUser = document.getElementById('notifyUser').checked;
            
            // Validate form
            if (!status) {
                alert('Please select a status');
                spinner.classList.add('d-none');
                saveButton.disabled = false;
                return;
            }
            
            // Create form data for submission
            const formData = new FormData();
            formData.append('status', status);
            formData.append('notes', notes);
            formData.append('notify_user', notifyUser);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
            
            // Submit form via AJAX
            fetch(`/reports/update/${reportId}/`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // Hide spinner
                spinner.classList.add('d-none');
                saveButton.disabled = false;
                
                if (data.status === 'success') {
                    // Close modal
                    reportDetailsModal.hide();
                    
                    // Show success message
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success alert-dismissible fade show';
                    alertDiv.setAttribute('role', 'alert');
                    alertDiv.innerHTML = `
                        ${data.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    `;
                    document.querySelector('.container-fluid').prepend(alertDiv);
                    
                    // Reload page after delay
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                } else {
                    // Show error message
                    alert(data.message || 'An error occurred');
                }
            })
            .catch(error => {
                // Hide spinner
                spinner.classList.add('d-none');
                saveButton.disabled = false;
                
                console.error('Error:', error);
                alert('An error occurred while updating the report. Please try again.');
            });
        });
        
        // Function to populate report details (would be replaced with AJAX in real app)
        function populateReportDetails(reportId) {
            // Fetch report details from the API
            fetch(`/reports/detail/${reportId}/`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    const report = data.report;
                    const user = report.user;
                    
                    // Populate user information
                    document.getElementById('userName').textContent = user.full_name || user.username;
                    document.getElementById('userEmail').textContent = user.email;
                    document.getElementById('userLicense').textContent = user.license_number || 'Not provided';
                    document.getElementById('userContact').textContent = user.phone_number || 'Not provided';
                    
                    // Populate report details
                    document.getElementById('reportType').textContent = report.type_display;
                    document.getElementById('reportSubject').textContent = report.subject;
                    
                    // Update status badge
                    const statusBadge = document.getElementById('reportStatus');
                    statusBadge.textContent = report.status_display;
                    
                    // Set appropriate badge color based on status
                    statusBadge.className = 'badge rounded-pill';
                    if (report.status === 'PENDING') {
                        statusBadge.classList.add('text-bg-warning');
                    } else if (report.status === 'IN_PROGRESS') {
                        statusBadge.classList.add('text-bg-primary');
                    } else if (report.status === 'RESOLVED') {
                        statusBadge.classList.add('text-bg-success');
                    } else if (report.status === 'CLOSED') {
                        statusBadge.classList.add('text-bg-danger');
                    }
                    
                    document.getElementById('reportDate').textContent = report.created_at;
                    document.getElementById('reportLocation').textContent = report.location || 'Not specified';
                    document.getElementById('incidentDate').textContent = report.incident_date || 'Not specified';
                    document.getElementById('reportDescription').textContent = report.description;
                    
                    // Update admin notes section
                    document.getElementById('currentStatus').textContent = report.status_display;
                    document.getElementById('assignedTo').textContent = report.assigned_to || 'Not assigned';
                    document.getElementById('resolutionNotes').textContent = report.resolution_notes || 'No notes yet.';
                    
                    // Handle attachments
                    const attachmentList = document.getElementById('attachmentList');
                    const noAttachments = attachmentList.querySelector('.no-attachments');
                    const attachmentTemplate = attachmentList.querySelector('.attachment-item');
                    
                    // Clear existing attachments
                    Array.from(attachmentList.querySelectorAll('.attachment-item:not(.d-none)')).forEach(el => el.remove());
                    
                    if (report.attachment) {
                        // Clone the template and update it
                        const attachmentItem = attachmentTemplate.cloneNode(true);
                        attachmentItem.classList.remove('d-none');
                        
                        const attachmentLink = attachmentItem.querySelector('a');
                        attachmentLink.href = report.attachment.url;
                        
                        const attachmentName = attachmentItem.querySelector('.attachment-name');
                        attachmentName.textContent = report.attachment.filename;
                        
                        // Add to the list
                        attachmentList.appendChild(attachmentItem);
                        
                        // Hide the "no attachments" message
                        noAttachments.classList.add('d-none');
                    } else {
                        // Show the "no attachments" message
                        noAttachments.classList.remove('d-none');
                    }
                    
                    // Pre-select the current status in the dropdown
                    const statusDropdown = document.getElementById('statusChange');
                    statusDropdown.value = report.status;
                } else {
                    alert('Error fetching report details: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while fetching report details. Please try again.');
            });
        }
        
        // Export to CSV functionality
        document.getElementById('exportCSV').addEventListener('click', function() {
            alert('Export functionality would be implemented in a real application.');
        });
    });
</script>
{% endblock %} 