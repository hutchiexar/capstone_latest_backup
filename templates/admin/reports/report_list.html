{% extends 'admin/base_admin.html' %}
{% load static %}

{% block title %}Manage User Reports{% endblock %}

<!-- Add MicroModal.js with defer to ensure it loads completely -->
<script src="https://unpkg.com/micromodal/dist/micromodal.min.js" defer></script>

{% block content %}
<div class="container-fluid py-4 px-3">
    <!-- Header Section -->
    <div class="card shadow-sm border-0 rounded-3 mb-4">
        <div class="card-body p-3 p-md-4">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
                <div class="d-flex align-items-center">
                    <div class="icon-circle bg-primary text-white me-3">
                        <span class="material-icons">report_problem</span>
                    </div>
                    <div>
                        <h4 class="mb-0 fs-5 fs-md-4">User Reports Management</h4>
                        <p class="text-muted mb-0 small">Total Reports: {{ reports.paginator.count }}</p>
                    </div>
                </div>
                <div>
                    <a href="{% url 'admin_report_export' %}{% if request.GET %}?{{ request.GET.urlencode }}{% endif %}" class="btn btn-success d-flex align-items-center justify-content-center px-3 py-2">
                        <span class="material-icons me-1 me-md-2" style="font-size: 18px;">download</span>
                        <span>Export to Excel</span>
                    </a>
                </div>
            </div>

            <!-- Search Form -->
            <form method="get" class="mt-4">
                <div class="row g-3">
                    <div class="col-12 col-md-9">
                        <div class="search-input">
                            <span class="material-icons">search</span>
                            <input type="text" 
                                   name="q" 
                                   class="form-control py-2 search-box" 
                                   placeholder="Search by subject, description or user..."
                                   value="{{ current_filters.q|default:'' }}">
                        </div>
                    </div>
                    <div class="col-12 col-md-3">
                        <button type="submit" class="btn btn-primary w-100 py-2 d-flex align-items-center justify-content-center">
                            <span class="material-icons me-2">search</span>
                            Search
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Filters -->
    <div class="card shadow-sm mb-4 filter-section" id="filterSection">
        <div class="card-header py-3 d-flex justify-content-between align-items-center filter-toggle" onclick="toggleFilters()">
            <div class="d-flex align-items-center">
                <span class="material-icons text-primary me-2">filter_list</span>
                <h6 class="m-0 font-weight-bold">Advanced Filters</h6>
            </div>
            <span class="material-icons" id="filterIcon">expand_more</span>
        </div>
        <div class="card-body filter-body p-3 p-md-4">
            <form id="filter-form" method="get">
                <input type="hidden" name="q" value="{{ current_filters.q|default:'' }}">
                <div class="row g-3">
                    <div class="col-12 col-md-4 col-sm-6">
                        <label for="status-filter" class="form-label small text-muted">Status</label>
                        <select class="form-select py-2" name="status" id="status-filter">
                            <option value="">All Statuses</option>
                            {% for status_code, status_name in status_choices %}
                            <option value="{{ status_code }}" {% if current_filters.status == status_code %}selected{% endif %}>
                                {{ status_name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-12 col-md-4 col-sm-6">
                        <label for="type-filter" class="form-label small text-muted">Report Type</label>
                        <select class="form-select py-2" name="type" id="type-filter">
                            <option value="">All Report Types</option>
                            {% for type_code, type_name in report_types %}
                            <option value="{{ type_code }}" {% if current_filters.type == type_code %}selected{% endif %}>
                                {{ type_name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-12 col-md-4">
                        <label for="date-from" class="form-label small text-muted">Date Range</label>
                        <div class="input-group flex-nowrap date-range-group">
                            <span class="input-group-text bg-light">From</span>
                            <input type="date" class="form-control py-2" id="date-from" name="date_from" 
                                   value="{{ current_filters.date_from|date:'Y-m-d' }}">
                            <span class="input-group-text bg-light">To</span>
                            <input type="date" class="form-control py-2" id="date-to" name="date_to"
                                   value="{{ current_filters.date_to|date:'Y-m-d' }}">
                        </div>
                    </div>
                    <div class="col-12 d-flex flex-wrap gap-2 mt-3">
                        <button type="submit" class="btn btn-primary d-inline-flex align-items-center px-3 py-2">
                            <span class="material-icons me-1">filter_alt</span> Apply Filters
                        </button>
                        <a href="{% url 'admin_report_list' %}" class="btn btn-outline-secondary d-inline-flex align-items-center px-3 py-2">
                            <span class="material-icons me-1">clear</span> Clear Filters
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Reports Table and Mobile Cards -->
    <div class="card border-0 shadow-sm">
        <!-- Desktop Table View -->
        <div class="table-responsive d-none d-md-block">
            <table class="table table-hover align-middle mb-0" id="reportsTable">
                <thead class="table-light">
                    <tr>
                        <th class="text-center">ID</th>
                        <th class="text-center">User</th>
                        <th class="text-center">Type</th>
                        <th class="text-center">Subject</th>
                        <th class="text-center">Status</th>
                        <th class="text-center">Date Submitted</th>
                        <th class="text-center" style="width: 140px;">Actions</th>
                    </tr>
                </thead>
                <tbody id="reports-table-body">
                    {% include 'admin/reports/report_list_partial.html' %}
                </tbody>
            </table>
        </div>
        
        <!-- Mobile Card View -->
        <div class="d-md-none" id="reports-mobile-view">
            {% for report in reports %}
            <div class="report-card p-3 border-bottom mobile-card">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <span class="badge bg-secondary">#{{ report.id }}</span>
                    <span class="badge rounded-pill {% if report.type == 'COMPLAINT' %}text-bg-danger
                            {% elif report.type == 'SUGGESTION' %}text-bg-info
                            {% elif report.type == 'INQUIRY' %}text-bg-primary
                            {% elif report.type == 'DISPUTE' %}text-bg-warning
                            {% endif %} d-inline-flex align-items-center">
                        <span class="material-icons me-1" style="font-size: 14px;">
                            {% if report.type == 'COMPLAINT' %}report_problem
                            {% elif report.type == 'SUGGESTION' %}lightbulb
                            {% elif report.type == 'INQUIRY' %}help_outline
                            {% elif report.type == 'DISPUTE' %}gavel
                            {% endif %}
                        </span>
                        {{ report.get_type_display }}
                    </span>
                </div>
                
                <h5 class="fw-medium fs-6 mb-1">{{ report.subject }}</h5>
                <p class="text-muted small mb-2">{{ report.description|truncatechars:60 }}</p>
                
                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <div class="d-flex flex-column">
                            <span class="small text-muted">Submitted by</span>
                            <span class="mobile-info-text">{{ report.user.get_full_name }}</span>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="d-flex flex-column">
                            <span class="small text-muted">Date</span>
                            <span class="mobile-info-text">{{ report.created_at|date:"M d, Y" }}</span>
                        </div>
                    </div>
                </div>
                
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <span class="material-icons me-2 {% if report.status == 'PENDING' %}text-warning
                                {% elif report.status == 'IN_PROGRESS' %}text-primary
                                {% elif report.status == 'RESOLVED' %}text-success
                                {% elif report.status == 'CLOSED' %}text-secondary
                                {% endif %}">
                            {% if report.status == 'PENDING' %}schedule
                            {% elif report.status == 'IN_PROGRESS' %}sync
                            {% elif report.status == 'RESOLVED' %}check_circle
                            {% elif report.status == 'CLOSED' %}cancel
                            {% endif %}
                        </span>
                        <span class="{% if report.status == 'PENDING' %}text-warning
                                {% elif report.status == 'IN_PROGRESS' %}text-primary
                                {% elif report.status == 'RESOLVED' %}text-success
                                {% elif report.status == 'CLOSED' %}text-secondary
                                {% endif %} mobile-info-text">
                            {{ report.get_status_display }}
                        </span>
                    </div>
                    
                    <div class="action-buttons">
                        <button type="button" class="btn btn-primary action-btn" onclick="openViewModal('{{ report.id }}')" title="View Details">
                            <span class="material-icons">visibility</span>
                        </button>
                        <button type="button" class="btn btn-info text-white action-btn" onclick="openStatusModal('{{ report.id }}')" title="Update Status">
                            <span class="material-icons">update</span>
                        </button>
                        {% if report.status == 'PENDING' or report.status == 'IN_PROGRESS' %}
                        <button type="button" class="btn btn-warning text-white action-btn" onclick="openDisputeModal('{{ report.id }}')" title="Dispute Report">
                            <span class="material-icons">gavel</span>
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="text-center py-5">
                <span class="material-icons d-block mb-2" style="font-size: 3rem; opacity: 0.5;">search_off</span>
                <p class="text-muted">No reports found matching your criteria</p>
            </div>
            {% endfor %}
        </div>
        
        <!-- Pagination -->
        {% if reports.paginator.num_pages > 1 %}
        <div class="card-footer bg-white py-3">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-center">
                <div class="small text-muted mb-3 mb-md-0 text-center text-md-start">
                    Showing {{ reports.start_index }} to {{ reports.end_index }} of {{ reports.paginator.count }} entries
                </div>
                <nav aria-label="Report pagination">
                    <ul class="pagination mb-0 pagination-sm flex-wrap justify-content-center justify-content-md-end mobile-pagination">
                        {% if reports.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1{% for key, value in current_filters.items %}{% if value and key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" aria-label="First">
                                <span class="material-icons" style="font-size: 1rem;">first_page</span>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ reports.previous_page_number }}{% for key, value in current_filters.items %}{% if value and key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" aria-label="Previous">
                                <span class="material-icons" style="font-size: 1rem;">chevron_left</span>
                            </a>
                        </li>
                        {% endif %}
                        
                        {% for i in reports.paginator.page_range %}
                            {% if reports.number == i %}
                                <li class="page-item active"><a class="page-link" href="#">{{ i }}</a></li>
                            {% elif i > reports.number|add:'-3' and i < reports.number|add:'3' %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ i }}{% for key, value in current_filters.items %}{% if value and key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ i }}</a>
                                </li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if reports.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ reports.next_page_number }}{% for key, value in current_filters.items %}{% if value and key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" aria-label="Next">
                                <span class="material-icons" style="font-size: 1rem;">chevron_right</span>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ reports.paginator.num_pages }}{% for key, value in current_filters.items %}{% if value and key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" aria-label="Last">
                                <span class="material-icons" style="font-size: 1rem;">last_page</span>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<style>
/* Enhanced mobile styling */
@media (max-width: 767.98px) {
    .mobile-card {
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        margin-bottom: 12px;
        border: 1px solid rgba(0,0,0,0.1) !important;
    }
    
    .mobile-btn {
        width: 38px;
        height: 38px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        border-radius: 6px;
    }
    
    .mobile-btn .material-icons {
        font-size: 20px !important;
    }
    
    .mobile-info-text {
        font-size: 14px;
        font-weight: 500;
    }
    
    .mobile-pagination .page-link {
        min-width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
    }
    
    .search-box {
        height: 45px;
    }
    
    /* Prevent zooming on iOS */
    input[type="text"], 
    input[type="date"],
    select, 
    textarea {
        font-size: 16px !important;
    }
    
    .date-range-group {
        flex-direction: column;
    }
    
    .date-range-group .input-group-text {
        border-radius: 4px 4px 0 0;
        width: 100%;
        justify-content: start;
    }
    
    .date-range-group input:first-of-type {
        border-radius: 0;
        margin-bottom: 8px;
    }
    
    .date-range-group input:last-of-type {
        border-radius: 0 0 4px 4px;
    }
    
    /* Modal improvements for mobile */
    .modal__container,
    .modal-container {
        padding: 0 !important;
        max-width: 95% !important;
        width: 95% !important;
        margin: 0 auto;
    }
    
    .modal__content,
    .modal-content {
        padding: 12px !important;
    }
    
    .modal__footer,
    .modal-footer {
        padding: 12px !important;
    }
    
    .modal__header,
    .modal-header {
        padding: 12px !important;
    }
}

/* Filter and UI elements */
.filter-toggle {
    cursor: pointer;
}

.filter-toggle:hover {
    background-color: rgba(0,0,0,0.03);
}

/* Transitions for smooth experience */
.filter-body {
    transition: max-height 0.3s ease-in-out;
}

.report-card {
    transition: transform 0.15s ease-in-out;
}

.report-card:active {
    transform: scale(0.98);
}

/* Modal buttons styling */
.modal__btn-primary {
    background-color: var(--bs-primary);
    color: white;
    border: none;
    border-radius: 4px;
    padding: 8px 16px;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    min-height: 38px;
}

.modal__btn-secondary {
    background-color: var(--bs-light);
    color: var(--bs-dark);
    border: 1px solid var(--bs-gray-300);
    border-radius: 4px;
    padding: 8px 16px;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    min-height: 38px;
}

/* Modal styling - landscape orientation without scrolling */
.modal__overlay,
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.modal__container,
.modal-container {
    background-color: #fff;
    border-radius: 8px;
    max-width: 950px !important; /* Wider width for landscape */
    width: 90% !important;
    max-height: 600px !important; /* Lower height to fit content */
    display: flex;
    flex-direction: column;
    box-shadow: 0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23);
    margin: 0 auto;
    position: relative;
    overflow: hidden; /* Hide scrollbars */
}

/* Modal close button */
.modal__close,
.modal-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: transparent;
    border: 0;
    cursor: pointer;
    width: 24px;
    height: 24px;
}

.modal__close:before,
.modal__close:after,
.modal-close:before,
.modal-close:after {
    content: '';
    position: absolute;
    width: 2px;
    height: 24px;
    background-color: #333;
    top: 0;
    left: 50%;
}

.modal__close:before,
.modal-close:before {
    transform: rotate(45deg);
}

.modal__close:after,
.modal-close:after {
    transform: rotate(-45deg);
}

/* Ensure Close buttons aren't floating outside modals */
body > button.close, 
body > button[aria-label="Close"],
body > button[data-micromodal-close] {
    display: none !important;
}

/* Modal structure styling */
.modal__header,
.modal-header {
    position: relative;
    padding: 0.75rem 1rem !important;
    border-bottom: 1px solid #e0e0e0;
    background-color: #fff;
}

.modal__title,
.modal-title {
    margin: 0;
    font-size: 1.25rem;
    padding-right: 30px; /* Make room for close button */
    color: #333;
}

/* Modal content in landscape layout */
.modal__content,
.modal-content {
    padding: 0.75rem;
    background-color: #fff;
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    flex: 1;
    overflow: hidden;
}

/* Two-column layout for landscape orientation */
.modal-section {
    padding: 10px;
    flex: 1;
    min-width: 300px;
}

.modal-section-full {
    width: 100%;
    padding: 10px;
}

.modal__footer,
.modal-footer {
    padding: 0.75rem 1rem !important;
    border-top: 1px solid #e0e0e0;
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
    background-color: #fff;
}

/* Specific modal sizing for Report Details */
#modal-view-report .modal__container {
    width: 95% !important;
    max-width: 1200px !important;
    max-height: 90vh !important;
}

/* Fix for report modal details to ensure no scrolling */
#modal-view-report .modal__content {
    padding: 0.5rem;
    overflow-y: auto;
    max-height: calc(90vh - 80px); /* Account for header height */
}

/* Fix for modal content */
#modal-view-report-content {
    max-height: none;
    overflow-y: visible;
    padding-bottom: 0;
}

/* Adjust modal description height */
.modal-description-container {
    max-height: 180px;
    overflow-y: auto;
}

@media (max-width: 768px) {
    .modal__container,
    .modal-container {
        flex-direction: column;
        max-width: 95% !important;
        width: 95% !important;
        max-height: 95vh !important;
    }
    
    .modal__content,
    .modal-content {
        flex-direction: column;
        overflow-y: auto;
    }
    
    .modal-section,
    .modal-section-full {
        width: 100%;
    }
}

/* Add additional styling for modal action buttons */
.report-detail-actions {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    padding: 16px;
    margin-top: 24px;
    border-top: 1px solid #eee;
    background-color: #f8f9fa;
    border-radius: 0 0 8px 8px;
}

.report-detail-actions .btn {
    min-width: 120px;
    padding: 10px 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 500;
    transition: all 0.2s ease;
}

.report-detail-actions .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.report-detail-actions .btn .material-icons {
    font-size: 18px;
    margin-right: 8px;
}

.report-detail-actions .btn-primary {
    background-color: #2563eb;
    border-color: #2563eb;
}

.report-detail-actions .btn-outline-secondary {
    border: 1px solid #d1d5db;
    color: #4b5563;
}

.report-detail-actions .btn-outline-secondary:hover {
    background-color: #f3f4f6;
    color: #1f2937;
}

/* Hide duplicate close buttons */
.modal__footer button[onclick="closeViewModal()"] {
    display: none;
}

/* Center table alignment */
#reportsTable th {
    text-align: center;
}

/* Table action buttons - new approach */
.action-buttons {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 4px;
}

/* Fixed-width container for action buttons */
td .action-buttons {
    width: 100%;
    max-width: 140px;
    margin: 0 auto;
}

/* Equal-sized action buttons */
.action-btn {
    width: 40px !important;
    height: 40px !important;
    min-width: 40px !important;
    max-width: 40px !important;
    padding: 0 !important;
    border-radius: 4px !important;
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
    flex: 0 0 40px !important;
}

/* Icon sizing */
.action-btn .material-icons {
    font-size: 18px !important;
    margin: 0 !important;
}

/* Center the action buttons container */
.action-buttons {
    display: flex !important;
    justify-content: center !important;
    align-items: center !important;
    gap: 5px !important;
    width: 100% !important;
}

/* Center all table cell content */
#reportsTable td, #reportsTable th {
    text-align: center;
    vertical-align: middle;
}

/* Fix responsive behavior */
@media (max-width: 767.98px) {
    .action-btn {
        width: 40px;
        height: 40px;
    }
}
</style>

<!-- View Report Modal (MicroModal) -->
<div class="modal micromodal-slide" id="modal-view-report" aria-hidden="true">
    <div class="modal__overlay" tabindex="-1" data-micromodal-close>
        <div class="modal__container" role="dialog" aria-modal="true" aria-labelledby="modal-view-report-title">
            <header class="modal__header bg-white">
                <h5 class="modal__title" id="modal-view-report-title">
                    <span class="material-icons me-2 text-primary">visibility</span>
                    Report Details
                </h5>
                <button class="modal__close" aria-label="Close modal" data-micromodal-close></button>
            </header>
            <div class="modal__content" id="modal-view-report-content">
                <!-- Content will be loaded via AJAX -->
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div class="mt-3">Loading report details...</div>
                </div>
            </div>
            <!-- No footer with close button needed - actions will be in the modal content -->
        </div>
    </div>
</div>

<!-- Update Status Modal (MicroModal) -->
<div class="modal micromodal-slide" id="modal-update-status" aria-hidden="true">
    <div class="modal__overlay" tabindex="-1" data-micromodal-close>
        <div class="modal__container" role="dialog" aria-modal="true" aria-labelledby="modal-update-status-title">
            <header class="modal__header bg-white">
                <h5 class="modal__title" id="modal-update-status-title">
                    <span class="material-icons me-2 text-primary">update</span>
                    Update Report Status
                </h5>
                <button class="modal__close" aria-label="Close modal" onclick="closeStatusModal()"></button>
            </header>
            <div class="modal__content" id="modal-update-status-content">
                <!-- Content will be loaded via AJAX -->
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div class="mt-3">Loading status form...</div>
                </div>
            </div>
            <footer class="modal__footer">
                <button class="btn btn-secondary" onclick="closeStatusModal()">Cancel</button>
                <button class="btn btn-primary" id="update-status-submit">
                    <span class="material-icons me-1 align-middle" style="font-size: 18px;">save</span>
                    Update Status
                </button>
            </footer>
        </div>
    </div>
</div>

<!-- Dispute Report Modal (MicroModal) -->
<div class="modal micromodal-slide" id="modal-dispute-report" aria-hidden="true">
    <div class="modal__overlay" tabindex="-1" data-micromodal-close>
        <div class="modal__container" role="dialog" aria-modal="true" aria-labelledby="modal-dispute-report-title">
            <header class="modal__header bg-white">
                <h5 class="modal__title" id="modal-dispute-report-title">
                    <span class="material-icons me-2 text-danger">gavel</span>
                    Dispute Report
                </h5>
                <button class="modal__close" aria-label="Close modal" onclick="closeDisputeModal()"></button>
            </header>
            <div class="modal__content" id="modal-dispute-report-content">
                <!-- Content will be loaded via AJAX -->
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div class="mt-3">Loading dispute form...</div>
                </div>
            </div>
            <footer class="modal__footer">
                <button class="btn btn-secondary" onclick="closeDisputeModal()">Cancel</button>
                <button class="btn btn-danger" id="dispute-report-submit">
                    <span class="material-icons me-1 align-middle" style="font-size: 18px;">gavel</span>
                    Dispute Report
                </button>
            </footer>
        </div>
    </div>
</div>

<script>
// Initialize MicroModal when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, setting up MicroModal...');
    
    // More aggressive cleanup for any standalone Close buttons
    function removeFloatingCloseButtons() {
        // Find and remove any standalone "Close" button outside modals
        document.querySelectorAll('button').forEach(button => {
            // Handle buttons with "Close" text
            const text = button.textContent.trim();
            if (text === 'Close' && 
                !button.closest('.modal') && 
                !button.closest('.modal__container') && 
                !button.closest('.modal__content') && 
                !button.closest('.modal-content') &&
                !button.closest('.modal__footer') && 
                !button.closest('.modal-footer') &&
                !button.closest('.card-body')) {
                console.log('Removing stray close button:', button);
                button.remove();
            }
            
            // Also look for buttons matching the one in the screenshot (outside modal with blue background)
            if (button.classList.contains('btn-primary') && 
                text === 'Close' && 
                !button.closest('.modal__content') && 
                !button.closest('.card-body')) {
                console.log('Removing floating primary close button:', button);
                button.remove();
            }
        });
        
        // Remove any stray Close buttons outside of modals
        const standaloneCloseButtons = document.querySelectorAll('body > button.close, body > button[aria-label="Close"], body > button[data-micromodal-close], body > .btn');
        standaloneCloseButtons.forEach(button => {
            if (!button.closest('.modal, .modal-container, .modal-content, .modal__container, .modal__content')) {
                console.log('Removing floating button:', button);
                button.remove();
            }
        });
    }
    
    // Run cleanup immediately, after load, and after a short delay
    removeFloatingCloseButtons();
    window.addEventListener('load', removeFloatingCloseButtons);
    setTimeout(removeFloatingCloseButtons, 500);
    setTimeout(removeFloatingCloseButtons, 1000); // Run again after everything has settled
    
    // Initialize Micromodal
    MicroModal.init({
        onShow: modal => console.info(`${modal.id} is shown`),
        onClose: modal => console.info(`${modal.id} is hidden`),
        openTrigger: 'data-micromodal-trigger',
        closeTrigger: 'data-micromodal-close',
        disableScroll: true,
        disableFocus: false,
        awaitOpenAnimation: true,
        awaitCloseAnimation: true
    });
    
    // Toggle filter section
    window.toggleFilters = function() {
        const filterSection = document.getElementById('filterSection');
        const filterIcon = document.getElementById('filterIcon');
        
        filterSection.classList.toggle('collapsed');
        
        if (filterSection.classList.contains('collapsed')) {
            filterIcon.textContent = 'expand_more';
        } else {
            filterIcon.textContent = 'expand_less';
        }
    };
    
    // Initialize as collapsed by default
    toggleFilters();
    
    // Function to open the view modal
    window.openViewModal = function(reportId) {
        console.log('Opening view modal for report ID:', reportId);
        // Show loading spinner
        document.getElementById('modal-view-report-content').innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div class="mt-3">Loading details for report #${reportId}...</div>
            </div>
        `;
        
        // Open the modal safely with MicroModal
        if (typeof MicroModal !== 'undefined') {
            console.log('Opening modal with MicroModal');
            MicroModal.show('modal-view-report');
        } else {
            // Fallback if MicroModal isn't available
            console.warn('MicroModal not available, using fallback');
            const modal = document.getElementById('modal-view-report');
            modal.classList.add('is-open');
            modal.setAttribute('aria-hidden', 'false');
        }
        
        // Add a timestamp to prevent caching
        const timestamp = new Date().getTime();
        const url = `/management/reports/${reportId}/view/?t=${timestamp}`;
        
        console.log('Fetching URL:', url);
        
        fetch(url, {
            method: 'GET',
            headers: {
                'Cache-Control': 'no-cache',
                'X-Requested-With': 'XMLHttpRequest'
            },
        })
        .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
                throw new Error(`Server returned ${response.status}: ${response.statusText}`);
            }
            return response.text();
        })
        .then(html => {
            console.log('Response received, length:', html.length);
            document.getElementById('modal-view-report-content').innerHTML = html;
        })
        .catch(error => {
            console.error('Error fetching report details:', error);
            document.getElementById('modal-view-report-content').innerHTML = `
                <div class="alert alert-danger m-3">
                    <span class="material-icons me-2">error_outline</span>
                    <div>Error loading report details: ${error.message}</div>
                    <div class="mt-2">Requested Report ID: ${reportId}</div>
                    <div class="mt-3">
                        <button class="btn btn-outline-secondary" onclick="closeViewModal()">
                            <span class="material-icons me-1">close</span> Close
                        </button>
                    </div>
                </div>
            `;
        });
    };
    
    // Function to close the view modal
    window.closeViewModal = function() {
        console.log('Closing view modal');
        try {
            if (typeof MicroModal !== 'undefined') {
                MicroModal.close('modal-view-report');
                console.log('Closed modal with MicroModal');
            } else {
                // Fallback
                const modal = document.getElementById('modal-view-report');
                modal.classList.remove('is-open');
                modal.setAttribute('aria-hidden', 'true');
                console.log('Closed modal with fallback method');
            }
        } catch (error) {
            console.error('Error closing modal:', error);
            // Additional fallback
            const modal = document.getElementById('modal-view-report');
            if (modal) {
                modal.style.display = 'none';
                document.body.classList.remove('modal-open');
                console.log('Closed modal with additional fallback');
            }
        }
    };
    
    // Function to open the status update modal
    window.openStatusModal = function(reportId) {
        console.log('Opening status update modal for report ID:', reportId);
        // Show loading spinner
        document.getElementById('modal-update-status-content').innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div class="mt-3">Loading status form for report #${reportId}...</div>
            </div>
        `;
        
        // Open the modal safely with MicroModal
        try {
            if (typeof MicroModal !== 'undefined') {
                console.log('Opening status modal with MicroModal');
                MicroModal.show('modal-update-status');
            } else {
                // Fallback if MicroModal isn't available
                console.warn('MicroModal not available, using fallback');
                const modal = document.getElementById('modal-update-status');
                modal.classList.add('is-open');
                modal.setAttribute('aria-hidden', 'false');
                document.body.classList.add('modal-open');
            }
        } catch (error) {
            console.error('Error opening status modal:', error);
            // Additional fallback
            const modal = document.getElementById('modal-update-status');
            if (modal) {
                modal.style.display = 'block';
                modal.classList.add('is-open');
                document.body.classList.add('modal-open');
                console.log('Opened status modal with additional fallback');
            }
        }
        
        // Add a timestamp to prevent caching
        const timestamp = new Date().getTime();
        const url = `/management/reports/${reportId}/update-status/?t=${timestamp}`;
        
        console.log('Fetching URL:', url);
        
        // Fetch status update form
        fetch(url, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Cache-Control': 'no-cache'
            }
        })
        .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
                throw new Error(`Server returned ${response.status}: ${response.statusText}`);
            }
            return response.text();
        })
        .then(html => {
            console.log('Response received, length:', html.length);
            document.getElementById('modal-update-status-content').innerHTML = html;
            
            // Store the report ID for submission
            document.getElementById('update-status-submit').dataset.reportId = reportId;
            
            // Make sure the form has a CSRF token
            const form = document.getElementById('status-update-form');
            if (form) {
                // Check if the form already has a CSRF token field
                let hasCsrfToken = false;
                const inputs = form.querySelectorAll('input');
                for (let i = 0; i < inputs.length; i++) {
                    if (inputs[i].name === 'csrfmiddlewaretoken') {
                        hasCsrfToken = true;
                        break;
                    }
                }
                
                // If no CSRF token field, add one
                if (!hasCsrfToken) {
                    console.log('Adding CSRF token to status update form');
                    const csrfInput = document.createElement('input');
                    csrfInput.type = 'hidden';
                    csrfInput.name = 'csrfmiddlewaretoken';
                    csrfInput.value = getCSRFToken();
                    form.appendChild(csrfInput);
                }
            } else {
                console.error('Status update form not found after loading content');
            }
            
            // Add prevention for accidental modal closing when clicking inside content
            const modalContent = document.getElementById('modal-update-status-content');
            modalContent.addEventListener('click', function(e) {
                e.stopPropagation();
            });
            
            // Prevent Enter key from submitting forms in inputs
            modalContent.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') {
                    e.preventDefault();
                }
            });
            
            // Prevent textarea clicks from bubbling up and closing the modal
            const textareas = modalContent.querySelectorAll('textarea');
            textareas.forEach(textarea => {
                textarea.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            });
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('modal-update-status-content').innerHTML = `
                <div class="alert alert-danger m-3">
                    <span class="material-icons me-2">error_outline</span>
                    <div>Error loading status update form: ${error.message}</div>
                    <div class="mt-2">Requested Report ID: ${reportId}</div>
                    <div class="mt-3">
                        <button class="btn btn-outline-secondary" onclick="closeStatusModal()">
                            <span class="material-icons me-1">close</span> Close
                        </button>
                    </div>
                </div>
            `;
        });
    };
    
    // Function to open the dispute report modal
    window.openDisputeModal = function(reportId) {
        console.log('Opening dispute modal for report ID:', reportId);
        // Show loading spinner
        document.getElementById('modal-dispute-report-content').innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div class="mt-3">Loading dispute form for report #${reportId}...</div>
            </div>
        `;
        
        // Open the modal safely with MicroModal
        try {
            if (typeof MicroModal !== 'undefined') {
                console.log('Opening dispute modal with MicroModal');
                MicroModal.show('modal-dispute-report');
            } else {
                // Fallback if MicroModal isn't available
                console.warn('MicroModal not available, using fallback');
                const modal = document.getElementById('modal-dispute-report');
                modal.classList.add('is-open');
                modal.setAttribute('aria-hidden', 'false');
                document.body.classList.add('modal-open');
            }
        } catch (error) {
            console.error('Error opening dispute modal:', error);
            // Additional fallback
            const modal = document.getElementById('modal-dispute-report');
            if (modal) {
                modal.style.display = 'block';
                modal.classList.add('is-open');
                document.body.classList.add('modal-open');
                console.log('Opened dispute modal with additional fallback');
            }
        }
        
        // Add a timestamp to prevent caching
        const timestamp = new Date().getTime();
        const url = `/management/reports/${reportId}/dispute/?t=${timestamp}`;
        
        console.log('Fetching URL:', url);
        
        // Fetch dispute form
        fetch(url, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Cache-Control': 'no-cache'
            }
        })
        .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
                throw new Error(`Server returned ${response.status}: ${response.statusText}`);
            }
            return response.text();
        })
        .then(html => {
            console.log('Response received, length:', html.length);
            document.getElementById('modal-dispute-report-content').innerHTML = html;
            
            // Store the report ID for submission
            document.getElementById('dispute-report-submit').dataset.reportId = reportId;
            
            // Make sure the form has a CSRF token
            const form = document.getElementById('dispute-form');
            if (form) {
                // Check if the form already has a CSRF token field
                let hasCsrfToken = false;
                const inputs = form.querySelectorAll('input');
                for (let i = 0; i < inputs.length; i++) {
                    if (inputs[i].name === 'csrfmiddlewaretoken') {
                        hasCsrfToken = true;
                        break;
                    }
                }
                
                // If no CSRF token field, add one
                if (!hasCsrfToken) {
                    console.log('Adding CSRF token to dispute form');
                    const csrfInput = document.createElement('input');
                    csrfInput.type = 'hidden';
                    csrfInput.name = 'csrfmiddlewaretoken';
                    csrfInput.value = getCSRFToken();
                    form.appendChild(csrfInput);
                }
            } else {
                console.error('Dispute form not found after loading content');
            }
            
            // Add prevention for accidental modal closing when clicking inside content
            const modalContent = document.getElementById('modal-dispute-report-content');
            modalContent.addEventListener('click', function(e) {
                e.stopPropagation();
            });
            
            // Prevent Enter key from submitting forms in inputs
            modalContent.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') {
                    e.preventDefault();
                }
            });
            
            // Prevent textarea clicks from bubbling up and closing the modal
            const textareas = modalContent.querySelectorAll('textarea');
            textareas.forEach(textarea => {
                textarea.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            });
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('modal-dispute-report-content').innerHTML = `
                <div class="alert alert-danger m-3">
                    <span class="material-icons me-2">error_outline</span>
                    <div>Error loading dispute form: ${error.message}</div>
                    <div class="mt-2">Requested Report ID: ${reportId}</div>
                    <div class="mt-3">
                        <button class="btn btn-outline-secondary" onclick="closeDisputeModal()">
                            <span class="material-icons me-1">close</span> Close
                        </button>
                    </div>
                </div>
            `;
        });
    };
    
    // Handle clicks on view, update, and dispute buttons
    document.addEventListener('click', function(e) {
        // View button click
        if (e.target.closest('.btn-view-report')) {
            const btn = e.target.closest('.btn-view-report');
            const reportId = btn.dataset.reportId;
            openViewModal(reportId);
        }
        
        // Update status button click
        if (e.target.closest('.btn-update-status')) {
            const btn = e.target.closest('.btn-update-status');
            const reportId = btn.dataset.reportId;
            openStatusModal(reportId);
        }
        
        // Dispute button click
        if (e.target.closest('.btn-dispute-report')) {
            const btn = e.target.closest('.btn-dispute-report');
            const reportId = btn.dataset.reportId;
            openDisputeModal(reportId);
        }
    });
    
    // Define CSRF token function outside event handlers
    function getCSRFToken() {
        const name = 'csrftoken';
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Handle update status form submission
    document.getElementById('update-status-submit').addEventListener('click', function() {
        const reportId = this.dataset.reportId;
        const form = document.getElementById('status-update-form');
        
        if (!form) {
            console.error('Status update form not found');
            return;
        }
        
        const formData = new FormData(form);
        const statusValue = formData.get('status');
        const statusText = document.querySelector(`#status-update-form select[name="status"] option[value="${statusValue}"]`)?.textContent || statusValue;
        
        // Show confirmation dialog before submission
        Swal.fire({
            icon: 'question',
            title: 'Confirm Status Update',
            text: `Are you sure you want to update this report's status to "${statusText}"?`,
            showCancelButton: true,
            confirmButtonText: 'Yes, Update Status',
            cancelButtonText: 'Cancel',
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33'
        }).then((result) => {
            if (result.isConfirmed) {
                // User confirmed, proceed with submission
                submitStatusUpdate(this, reportId, formData);
            }
        });
    });
    
    // Function to handle the actual status update submission
    function submitStatusUpdate(button, reportId, formData) {
        // Debug CSRF token (only showing that it exists, not the value for security)
        const csrfToken = getCSRFToken();
        console.log('CSRF Token for status update:', csrfToken ? `${csrfToken.substring(0, 4)}...${csrfToken.substring(csrfToken.length - 4)}` : 'Not found');
        
        // Show loading state
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Updating...';
        
        // Submit the form via AJAX
        fetch(`/management/reports/${reportId}/update-status/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => {
            console.log('Status update response:', response.status, response.statusText);
            
            // Check response content type to determine how to parse it
            const contentType = response.headers.get('content-type');
            const isJson = contentType && contentType.includes('application/json');
            
            return response.text().then(text => {
                console.log('Response text length:', text.length);
                
                // Try to parse as JSON if the content type suggests it's JSON
                // or if it looks like JSON
                let data;
                try {
                    if (text.trim().startsWith('{') || text.trim().startsWith('[') || isJson) {
                        data = JSON.parse(text);
                    } else {
                        console.log('Response is not JSON:', text.substring(0, 100) + '...');
                        // Create a structured object for non-JSON responses
                        data = {
                            success: response.ok,
                            message: response.ok ? 'Status updated successfully' : 
                                    `Server error (${response.status}): ${response.statusText}`,
                            html: text
                        };
                    }
                } catch (e) {
                    console.error('Error parsing response:', e);
                    console.log('Raw response text:', text.substring(0, 200) + '...');
                    data = {
                        success: false,
                        message: `Error parsing server response: ${e.message}`,
                        html: text
                    };
                }
                
                // Combine the parsed data with response information
                return {
                    ok: response.ok,
                    status: response.status,
                    statusText: response.statusText,
                    data: data
                };
            });
        })
        .then(result => {
            if (result.ok) {
                // Close the modal
                closeStatusModal();
                
                // Show success alert (updated to match login.html style)
                Swal.fire({
                    icon: 'success',
                    title: 'Success',
                    text: result.data.message || 'Status updated successfully',
                    confirmButtonText: 'OK'
                });
                
                // Refresh the page to show updated data
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                // Extract error message from the response
                let errorMessage = 'Failed to update status';
                
                if (result.data && result.data.message) {
                    errorMessage = result.data.message;
                } else if (result.statusText) {
                    errorMessage = `Server error (${result.status}): ${result.statusText}`;
                }
                
                console.error('Status update failed:', errorMessage);
                
                // Show detailed error alert
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: errorMessage,
                    confirmButtonText: 'OK'
                });
            }
        })
        .catch(error => {
            console.error('Update status error:', error);
            
            // Show detailed error alert
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: `Network error: ${error.message}`,
                confirmButtonText: 'OK'
            });
        })
        .finally(() => {
            // Reset button state
            button.disabled = false;
            button.innerHTML = '<span class="material-icons me-1 align-middle" style="font-size: 18px;">save</span> Update Status';
        });
    }
    
    // Handle dispute form submission
    document.getElementById('dispute-report-submit').addEventListener('click', function() {
        const reportId = this.dataset.reportId;
        const form = document.getElementById('dispute-form');
        
        if (!form) {
            console.error('Dispute form not found');
            return;
        }
        
        const formData = new FormData(form);
        
        // Check if reason field is filled
        const reason = formData.get('reason');
        if (!reason || reason.trim() === '') {
            Swal.fire({
                icon: 'warning',
                title: 'Missing Information',
                text: 'Please provide a reason for disputing this report.',
                confirmButtonText: 'OK'
            });
            return;
        }
        
        // Show confirmation dialog before submission
        Swal.fire({
            icon: 'warning',
            title: 'Confirm Dispute',
            text: 'Are you sure you want to dispute this report? This action will notify the user and cannot be undone.',
            showCancelButton: true,
            confirmButtonText: 'Yes, Dispute Report',
            cancelButtonText: 'Cancel',
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6'
        }).then((result) => {
            if (result.isConfirmed) {
                // User confirmed, proceed with submission
                submitDisputeReport(this, reportId, formData);
            }
        });
    });
    
    // Function to handle the actual dispute submission
    function submitDisputeReport(button, reportId, formData) {
        // Debug CSRF token (only showing that it exists, not the value for security)
        const csrfToken = getCSRFToken();
        console.log('CSRF Token for dispute:', csrfToken ? `${csrfToken.substring(0, 4)}...${csrfToken.substring(csrfToken.length - 4)}` : 'Not found');
        
        // Show loading state
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Processing...';
        
        // Submit the form via AJAX
        fetch(`/management/reports/${reportId}/dispute/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => {
            console.log('Dispute response:', response.status, response.statusText);
            
            // Check response content type to determine how to parse it
            const contentType = response.headers.get('content-type');
            const isJson = contentType && contentType.includes('application/json');
            
            return response.text().then(text => {
                console.log('Response text length:', text.length);
                
                // Try to parse as JSON if the content type suggests it's JSON
                // or if it looks like JSON
                let data;
                try {
                    if (text.trim().startsWith('{') || text.trim().startsWith('[') || isJson) {
                        data = JSON.parse(text);
                    } else {
                        console.log('Response is not JSON:', text.substring(0, 100) + '...');
                        // Create a structured object for non-JSON responses
                        data = {
                            success: response.ok,
                            message: response.ok ? 'Report disputed successfully' : 
                                    `Server error (${response.status}): ${response.statusText}`,
                            html: text
                        };
                    }
                } catch (e) {
                    console.error('Error parsing response:', e);
                    console.log('Raw response text:', text.substring(0, 200) + '...');
                    data = {
                        success: false,
                        message: `Error parsing server response: ${e.message}`,
                        html: text
                    };
                }
                
                // Combine the parsed data with response information
                return {
                    ok: response.ok,
                    status: response.status,
                    statusText: response.statusText,
                    data: data
                };
            });
        })
        .then(result => {
            if (result.ok) {
                // Close the modal
                closeDisputeModal();
                
                // Show success alert (updated to match login.html style)
                Swal.fire({
                    icon: 'success',
                    title: 'Success',
                    text: result.data.message || 'Report disputed successfully',
                    confirmButtonText: 'OK'
                });
                
                // Refresh the page to show updated data
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                // Extract error message from the response
                let errorMessage = 'Failed to dispute report';
                
                if (result.data && result.data.message) {
                    errorMessage = result.data.message;
                } else if (result.statusText) {
                    errorMessage = `Server error (${result.status}): ${result.statusText}`;
                }
                
                console.error('Dispute failed:', errorMessage);
                
                // Show detailed error alert
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: errorMessage,
                    confirmButtonText: 'OK'
                });
            }
        })
        .catch(error => {
            console.error('Dispute error:', error);
            
            // Show detailed error alert
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: `Network error: ${error.message}`,
                confirmButtonText: 'OK'
            });
        })
        .finally(() => {
            // Reset button state
            button.disabled = false;
            button.innerHTML = '<span class="material-icons me-1 align-middle" style="font-size: 18px;">gavel</span> Dispute Report';
        });
    }

    // Function to close the status update modal
    window.closeStatusModal = function() {
        console.log('Closing status update modal');
        try {
            if (typeof MicroModal !== 'undefined') {
                MicroModal.close('modal-update-status');
                console.log('Closed status modal with MicroModal');
            } else {
                // Fallback
                const modal = document.getElementById('modal-update-status');
                modal.classList.remove('is-open');
                modal.setAttribute('aria-hidden', 'true');
                console.log('Closed status modal with fallback method');
            }
        } catch (error) {
            console.error('Error closing status modal:', error);
            // Additional fallback
            const modal = document.getElementById('modal-update-status');
            if (modal) {
                modal.style.display = 'none';
                document.body.classList.remove('modal-open');
                console.log('Closed status modal with additional fallback');
            }
        }
    };

    // Function to close the dispute report modal
    window.closeDisputeModal = function() {
        console.log('Closing dispute modal');
        try {
            if (typeof MicroModal !== 'undefined') {
                MicroModal.close('modal-dispute-report');
                console.log('Closed dispute modal with MicroModal');
            } else {
                // Fallback
                const modal = document.getElementById('modal-dispute-report');
                modal.classList.remove('is-open');
                modal.setAttribute('aria-hidden', 'true');
                console.log('Closed dispute modal with fallback method');
            }
        } catch (error) {
            console.error('Error closing dispute modal:', error);
            // Additional fallback
            const modal = document.getElementById('modal-dispute-report');
            if (modal) {
                modal.style.display = 'none';
                document.body.classList.remove('modal-open');
                console.log('Closed dispute modal with additional fallback');
            }
        }
    };

    // Add overlay click handlers that only close when clicking outside the modal
    document.querySelectorAll('.modal__overlay').forEach(overlay => {
        overlay.addEventListener('click', function(e) {
            // Only close if the click was directly on the overlay (not bubbled up)
            if (e.target === overlay) {
                const modalId = this.closest('.modal').id;
                console.log(`Overlay clicked, closing ${modalId}`);
                if (typeof MicroModal !== 'undefined') {
                    MicroModal.close(modalId);
                } else {
                    const modal = document.getElementById(modalId);
                    modal.classList.remove('is-open');
                    modal.setAttribute('aria-hidden', 'true');
                }
            }
        });
    });

    // Fix report modal buttons layout
    function fixReportModalButtons() {
        // Get the report modal content
        const modalContent = document.querySelector('#modal-view-report-content > div');
        if (!modalContent) {
            console.log('Modal content not found');
            return;
        }

        // First check if actions wrapper already exists and has buttons
        const existingActionsWrapper = modalContent.querySelector('.report-detail-actions');
        if (existingActionsWrapper && existingActionsWrapper.querySelectorAll('button').length > 0) {
            console.log('Report actions wrapper already exists with buttons, no need to create duplicates');
            return; // Actions already exist, no need to duplicate
        }
        
        // Check if buttons exist
        const closeButton = modalContent.querySelector('.btn-close-report');
        const updateButton = modalContent.querySelector('.btn-update-report');
        
        if (!closeButton && !updateButton) {
            console.log('No buttons found to organize');
            return;
        }

        // Create actions wrapper if it doesn't exist
        let actionsWrapper = modalContent.querySelector('.report-detail-actions');
        if (!actionsWrapper) {
            actionsWrapper = document.createElement('div');
            actionsWrapper.className = 'report-detail-actions';
            modalContent.appendChild(actionsWrapper);
        } else {
            // Clear existing actions
            actionsWrapper.innerHTML = '';
        }

        // Update and append buttons
        if (updateButton) {
            updateButton.parentNode.removeChild(updateButton);
            updateButton.classList.add('btn-primary');
            updateButton.innerHTML = '<i class="material-icons">update</i> Update Status';
            actionsWrapper.appendChild(updateButton);
        }

        if (closeButton) {
            closeButton.parentNode.removeChild(closeButton);
            closeButton.classList.add('btn-outline-secondary');
            closeButton.innerHTML = '<i class="material-icons">close</i> Close';
            actionsWrapper.appendChild(closeButton);
        }
    }
    
    // Fix buttons when the modal is shown
    document.addEventListener('modal-open', function(e) {
        if (e.detail && e.detail.id === 'modal-view-report') {
            setTimeout(fixReportModalButtons, 100);
        }
    });
    
    // Also try to fix buttons on first load
    setTimeout(fixReportModalButtons, 500);
});
</script>
{% endblock %} 