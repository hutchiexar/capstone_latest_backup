{% extends 'base.html' %}

{% block content %}
<!-- Add SweetAlert2 library -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>

<div class="container-fluid py-4">
    <!-- Create Announcement Form -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-body p-4 p-sm-3">
                    <!-- Header Section -->
                    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
                        <div class="d-flex align-items-center mb-2 mb-md-0">
                            <span class="material-icons me-2" style="color: var(--primary-color); font-size: 2rem;">campaign</span>
                            <div>
                                <h4 class="mb-0">Create Announcement</h4>
                                <p class="text-muted mb-0 small">Create a new announcement to share with users</p>
                            </div>
                        </div>
                        <a href="{% url 'announcements_list' %}" class="btn btn-outline-secondary rounded-3">
                            <i class="material-icons me-2">arrow_back</i><span class="d-none d-sm-inline">Back to List</span><span class="d-inline d-sm-none">Back</span>
                        </a>
                    </div>

                    <!-- Form Instructions -->
                    <div class="alert alert-info mb-4">
                        <div class="d-flex align-items-start">
                            <span class="material-icons me-2 mt-1">info</span>
                            <div>
                                <strong>How to create an announcement:</strong>
                                <ul class="mb-0 mt-1 ps-3 form-instructions">
                                    <li>Fill in the basic information in the "Basic Details" section</li>
                                    <li>Configure how the announcement will be displayed in the "Display Settings" section</li>
                                    <li>Set when the announcement will be visible in the "Scheduling" section</li>
                                    <li>Enter the announcement content in the "Content" section</li>
                                    <li>Required fields are marked with an asterisk (*)</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <form method="post" id="announcementForm">
                        {% csrf_token %}
                        
                        <!-- Basic Details Section -->
                        <div class="form-section mb-4">
                            <h5 class="form-section-title">
                                <span class="material-icons">description</span>
                                Basic Details
                            </h5>
                            <div class="form-section-content">
                                <div class="row">
                                    <div class="col-lg-8 mb-4">
                                        <label for="title" class="form-label">
                                            Title <span class="text-danger">*</span>
                                            <i class="material-icons tooltip-icon" data-bs-toggle="tooltip" title="A short, descriptive title that clearly indicates what the announcement is about">help_outline</i>
                                        </label>
                                        <input type="text" class="form-control form-control-lg" id="title" name="title" required
                                            placeholder="E.g., 'System Maintenance on July 15'" aria-describedby="titleHelp">
                                        <div id="titleHelp" class="form-text">Choose a clear, concise title that users will immediately understand</div>
                                    </div>
                                    <div class="col-lg-4 mb-4">
                                        <label for="priority" class="form-label">
                                            Priority Level
                                            <i class="material-icons tooltip-icon" data-bs-toggle="tooltip" title="Sets the importance level of this announcement - affects visual indicators">help_outline</i>
                                        </label>
                                        <div class="priority-select-wrapper">
                                            <select class="form-select form-select-lg" id="priority" name="priority">
                                                <option value="LOW" data-icon="low_priority">Low Priority</option>
                                                <option value="MEDIUM" selected data-icon="upcoming">Medium Priority</option>
                                                <option value="HIGH" data-icon="priority_high">High Priority</option>
                                            </select>
                                            <div class="priority-indicator"></div>
                                        </div>
                                        <div class="form-text">Higher priority announcements are more prominently displayed</div>
                                    </div>
                                </div>

                                <div class="row mb-4">
                                    <div class="col-lg-4 mb-3 mb-lg-0">
                                        <label for="category" class="form-label">
                                            Category
                                            <i class="material-icons tooltip-icon" data-bs-toggle="tooltip" title="Helps organize announcements by type - users may filter by category">help_outline</i>
                                        </label>
                                        <select class="form-select" id="category" name="category">
                                            <option value="GENERAL" selected>General Information</option>
                                            <option value="SYSTEM">System Updates</option>
                                            <option value="POLICY">Policy Changes</option>
                                            <option value="URGENT">Urgent Notices</option>
                                            <option value="EVENT">Events</option>
                                            <option value="TRAINING">Training</option>
                                            <option value="OTHER">Other</option>
                                        </select>
                                        <div class="form-text">Select the most appropriate category for this announcement</div>
                                    </div>
                                    <div class="col-lg-4 mb-3 mb-lg-0">
                                        <label for="target_audience" class="form-label">
                                            Target Audience
                                            <i class="material-icons tooltip-icon" data-bs-toggle="tooltip" title="Controls which user groups will see this announcement">help_outline</i>
                                        </label>
                                        <select class="form-select" id="target_audience" name="target_audience">
                                            <option value="ALL" selected>All Users</option>
                                            <option value="ADMIN">Administrators Only</option>
                                            <option value="ENFORCER">Enforcers Only</option>
                                            <option value="SUPERVISOR">Supervisors Only</option>
                                            <option value="USER">Regular Users Only</option>
                                        </select>
                                        <div class="form-text">Only users in the selected group will see this announcement</div>
                                    </div>
                                    <div class="col-lg-4">
                                        <label for="geographic_area" class="form-label">
                                            Geographic Area (Optional)
                                            <i class="material-icons tooltip-icon" data-bs-toggle="tooltip" title="For location-specific announcements - can be left blank for system-wide announcements">help_outline</i>
                                        </label>
                                        <input type="text" class="form-control" id="geographic_area" name="geographic_area" 
                                            placeholder="E.g., 'Downtown' or 'North District'">
                                        <div class="form-text">Leave blank if this announcement applies to all areas</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Scheduling Section -->
                        <div class="form-section mb-4">
                            <h5 class="form-section-title">
                                <span class="material-icons">schedule</span>
                                Scheduling
                            </h5>
                            <div class="form-section-content">
                                <div class="row mb-4">
                                    <div class="col-lg-6 mb-3 mb-lg-0">
                                        <label for="publish_date" class="form-label">
                                            Publish Date (Optional)
                                            <i class="material-icons tooltip-icon" data-bs-toggle="tooltip" title="When this announcement should become visible - leave blank to publish immediately">help_outline</i>
                                        </label>
                                        <input type="datetime-local" class="form-control" id="publish_date" name="publish_date">
                                        <div class="form-text">If left blank, the announcement will be published immediately</div>
                                    </div>
                                    <div class="col-lg-6">
                                        <label for="expiration_date" class="form-label">
                                            Expiration Date (Optional)
                                            <i class="material-icons tooltip-icon" data-bs-toggle="tooltip" title="When this announcement should no longer be displayed - leave blank for no expiration">help_outline</i>
                                        </label>
                                        <input type="datetime-local" class="form-control" id="expiration_date" name="expiration_date">
                                        <div class="form-text">If left blank, the announcement will not expire automatically</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Display Settings Section -->
                        <div class="form-section mb-4">
                            <h5 class="form-section-title">
                                <span class="material-icons">settings</span>
                                Display Settings
                            </h5>
                            <div class="form-section-content">
                                <div class="row mb-4">
                                    <div class="col-lg-6 mb-3 mb-lg-0">
                                        <div class="setting-card">
                                            <div class="setting-header">
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" id="is_popup" name="is_popup">
                                                    <label class="form-check-label fw-medium" for="is_popup">
                                                        Show as popup announcement
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="setting-description">
                                                <span class="material-icons">fullscreen</span>
                                                <div class="form-text">If enabled, this announcement will appear as a modal popup on users' screens</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-6">
                                        <div class="setting-card">
                                            <div class="setting-header">
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" id="requires_acknowledgment" name="requires_acknowledgment">
                                                    <label class="form-check-label fw-medium" for="requires_acknowledgment">
                                                        Require acknowledgment
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="setting-description">
                                                <span class="material-icons">check_circle</span>
                                                <div class="form-text">If enabled, users must confirm they've read this announcement</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mb-4">
                                    <div class="col-lg-6 mb-3 mb-lg-0">
                                        <div class="setting-card">
                                            <div class="setting-header">
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" id="send_as_notification" name="send_as_notification">
                                                    <label class="form-check-label fw-medium" for="send_as_notification">
                                                        Send as notification
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="setting-description">
                                                <span class="material-icons">notifications</span>
                                                <div class="form-text">If enabled, users will receive this as a notification</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-6">
                                        <div class="setting-card">
                                            <div class="setting-header">
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" id="is_active" name="is_active" checked>
                                                    <label class="form-check-label fw-medium" for="is_active">
                                                        Set as active
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="setting-description">
                                                <span class="material-icons">toggle_on</span>
                                                <div class="form-text">If enabled, this announcement will be immediately active for real-time display</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Content Section -->
                        <div class="form-section mb-4">
                            <h5 class="form-section-title">
                                <span class="material-icons">article</span>
                                Content
                            </h5>
                            <div class="form-section-content">
                                <div class="mb-4">
                                    <label for="content" class="form-label">
                                        Main Content <span class="text-danger">*</span>
                                        <i class="material-icons tooltip-icon" data-bs-toggle="tooltip" title="The main text of your announcement - this is required">help_outline</i>
                                    </label>
                                    
                                    <!-- Rich Text Editor Toolbar -->
                                    <div class="rich-text-toolbar border rounded-top p-2 bg-light" id="formatting-toolbar">
                                        <div class="btn-group me-2">
                                            <button type="button" class="btn btn-sm btn-outline-secondary" data-command="bold" title="Bold">
                                                <span class="material-icons fs-6">format_bold</span>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary" data-command="italic" title="Italic">
                                                <span class="material-icons fs-6">format_italic</span>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary" data-command="underline" title="Underline">
                                                <span class="material-icons fs-6">format_underlined</span>
                                            </button>
                                </div>
                                        
                                        <div class="btn-group me-2">
                                            <button type="button" class="btn btn-sm btn-outline-secondary" data-command="insertUnorderedList" title="Bullet List">
                                                <span class="material-icons fs-6">format_list_bulleted</span>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary" data-command="insertOrderedList" title="Numbered List">
                                                <span class="material-icons fs-6">format_list_numbered</span>
                                            </button>
                                        </div>
                                        
                                        <div class="btn-group me-2">
                                            <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                                <span class="material-icons fs-6">title</span>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item" href="#" data-command="formatBlock" data-value="h2">Heading 1</a></li>
                                                <li><a class="dropdown-item" href="#" data-command="formatBlock" data-value="h3">Heading 2</a></li>
                                                <li><a class="dropdown-item" href="#" data-command="formatBlock" data-value="h4">Heading 3</a></li>
                                                <li><a class="dropdown-item" href="#" data-command="formatBlock" data-value="p">Normal</a></li>
                                            </ul>
                                        </div>
                                        
                                        <div class="btn-group">
                                            <button type="button" class="btn btn-sm btn-outline-secondary" data-command="createLink" title="Insert Link">
                                                <span class="material-icons fs-6">link</span>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary" data-command="removeFormat" title="Clear Formatting">
                                                <span class="material-icons fs-6">format_clear</span>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Rich Text Editor Content Area -->
                                    <div class="rich-text-editor border border-top-0 rounded-bottom p-2" id="editor" contenteditable="true" style="min-height: 250px; overflow-y: auto;"></div>
                                    
                                    <!-- Hidden input that will hold the HTML content for form submission -->
                                    <input type="hidden" id="content" name="content" required>
                                    
                                    <div class="form-text mt-2">Provide clear and detailed information about your announcement</div>
                                </div>
                            </div>
                        </div>

                        <!-- Conditional Fields -->
                        <div class="conditional-fields" id="popupAcknowledgeFields" style="display: none;">
                            <div class="form-section mb-4">
                                <h5 class="form-section-title">
                                    <span class="material-icons">open_in_new</span>
                                    Popup Settings
                                </h5>
                                <div class="form-section-content">
                            <div class="alert alert-info mb-4">
                                <span class="material-icons me-2">info</span>
                                <strong>Popup Announcements:</strong> When an announcement is shown as a popup, it appears over the main content of the page, ensuring users see it immediately.
                                    </div>
                                    
                                    <div class="row mb-4">
                                        <div class="col-lg-6 mb-3 mb-lg-0">
                                            <label for="popup_width" class="form-label">
                                                Popup Width
                                                <i class="material-icons tooltip-icon" data-bs-toggle="tooltip" title="Control how wide the popup should be on screen">help_outline</i>
                                            </label>
                                            <select class="form-select" id="popup_width" name="popup_width">
                                                <option value="small">Small (400px)</option>
                                                <option value="medium" selected>Medium (600px)</option>
                                                <option value="large">Large (800px)</option>
                                                <option value="xlarge">Extra Large (1000px)</option>
                                            </select>
                                            <div class="form-text">Choose the best size for your content length</div>
                                        </div>
                                        <div class="col-lg-6">
                                            <label for="popup_position" class="form-label">
                                                Popup Position
                                                <i class="material-icons tooltip-icon" data-bs-toggle="tooltip" title="Where the popup should appear on screen">help_outline</i>
                                            </label>
                                            <select class="form-select" id="popup_position" name="popup_position">
                                                <option value="center" selected>Center (Default)</option>
                                                <option value="top">Top</option>
                                                <option value="top-right">Top Right</option>
                                                <option value="top-left">Top Left</option>
                                                <option value="bottom">Bottom</option>
                                            </select>
                                            <div class="form-text">Position affects how the popup appears in the user's viewport</div>
                                        </div>
                                    </div>
                                    
                                    <div class="row mb-4">
                                        <div class="col-lg-6 mb-3 mb-lg-0">
                                            <div class="setting-card">
                                                <div class="setting-header">
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox" id="allow_close" name="allow_close" checked>
                                                        <label class="form-check-label fw-medium" for="allow_close">
                                                            Allow Close Button
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="setting-description">
                                                    <span class="material-icons">close</span>
                                                    <div class="form-text">If enabled, users can dismiss the popup with a close button</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-6">
                                            <div class="setting-card" id="auto_dismiss_card">
                                                <div class="setting-header">
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox" id="auto_dismiss" name="auto_dismiss">
                                                        <label class="form-check-label fw-medium" for="auto_dismiss">
                                                            Auto Dismiss
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="setting-description">
                                                    <span class="material-icons">timer</span>
                                                    <div class="form-text">If enabled, popup will automatically close after specified time</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div id="auto_dismiss_time_container" class="mb-4" style="display: none;">
                                        <label for="auto_dismiss_time" class="form-label">Auto Dismiss After (seconds)</label>
                                        <input type="number" class="form-control" id="auto_dismiss_time" name="auto_dismiss_time" min="3" max="60" value="10">
                                        <div class="form-text">How long the popup will display before automatically closing (3-60 seconds)</div>
                                    </div>
                                    
                                    <!-- Popup Preview -->
                                    <div class="mb-2">
                                        <label class="form-label d-flex align-items-center">
                                            <span>Preview</span>
                                            <button type="button" id="show_preview" class="btn btn-sm btn-outline-primary ms-3">
                                                <span class="material-icons fs-6 me-1">visibility</span> Show Preview
                                            </button>
                                        </label>
                                        <div class="form-text mb-2">Click the button above to see how your popup will appear to users</div>
                                    </div>
                                    
                                    <div class="popup-preview border rounded p-3 bg-light">
                                        <div class="d-flex align-items-center justify-content-between mb-2">
                                            <div class="text-muted small"><span class="badge bg-secondary">Preview</span> How users will see your popup</div>
                                            <div>
                                                <div class="dropdown">
                                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                                        <span class="material-icons fs-6">devices</span> Preview As
                                                    </button>
                                                    <ul class="dropdown-menu">
                                                        <li><a class="dropdown-item active" href="#" data-device="desktop">Desktop</a></li>
                                                        <li><a class="dropdown-item" href="#" data-device="tablet">Tablet</a></li>
                                                        <li><a class="dropdown-item" href="#" data-device="mobile">Mobile</a></li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="popup-preview-frame border rounded bg-white" style="height: 300px; position: relative; overflow: hidden;">
                                            <div class="text-center text-muted d-flex align-items-center justify-content-center h-100 popup-placeholder">
                                                <div>
                                                    <span class="material-icons d-block mb-2" style="font-size: 3rem;">open_in_new</span>
                                                    <p>Click "Show Preview" to see how your popup will appear</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between align-items-center flex-wrap">
                            <div class="text-muted small mb-3 mb-md-0">
                                <span class="text-danger">*</span> Required fields
                            </div>
                            <div class="d-flex gap-2 w-100 w-md-auto">
                                <a href="{% url 'announcements_list' %}" class="btn btn-light rounded-3 px-4 flex-fill">
                                    <i class="material-icons me-2">close</i><span class="d-none d-sm-inline">Cancel</span>
                                </a>
                                <button type="submit" class="btn btn-primary rounded-3 px-4 flex-fill">
                                    <i class="material-icons me-2">send</i><span class="d-none d-sm-inline">Publish</span><span class="d-inline d-sm-none">Send</span>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    :root {
        --primary-color: #3b7ddd;
        --focus-ring-color: rgba(59, 125, 221, 0.25);
        --error-color: #dc3545;
        --error-focus-color: rgba(220, 53, 69, 0.25);
    }

    .form-section {
        transition: all 0.2s;
    }

    .form-section:focus-within {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.25rem var(--focus-ring-color);
    }

    .rich-text-editor {
        min-height: 200px;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        padding: 0.75rem;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        overflow-y: auto;
    }

    .rich-text-editor:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.25rem var(--focus-ring-color);
    }

    .rich-text-editor.focused {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.25rem var(--focus-ring-color);
    }

    .rich-text-editor.is-invalid {
        border-color: var(--error-color);
    }

    .rich-text-editor.is-invalid:focus {
        box-shadow: 0 0 0 0.25rem var(--error-focus-color);
    }

    .rich-text-editor[data-placeholder]:empty:before {
        content: attr(data-placeholder);
        color: #6c757d;
        font-style: italic;
    }

    .rich-text-toolbar {
        padding: 0.5rem;
        background-color: #f8f9fa;
        border: 1px solid #ced4da;
        border-bottom: none;
        border-radius: 0.25rem 0.25rem 0 0;
        display: flex;
        flex-wrap: wrap;
        gap: 0.25rem;
    }

    .rich-text-toolbar button {
        background-color: transparent;
        border: 1px solid transparent;
        border-radius: 0.25rem;
        padding: 0.375rem;
        cursor: pointer;
        transition: all 0.15s ease-in-out;
    }

    .rich-text-toolbar button:hover {
        background-color: rgba(0, 0, 0, 0.05);
        border-color: #ced4da;
    }

    .rich-text-toolbar button:focus {
        outline: none;
        box-shadow: 0 0 0 0.25rem var(--focus-ring-color);
    }

    .rich-text-toolbar .dropdown-menu {
        padding: 0.5rem;
    }

    .rich-text-toolbar .dropdown-item {
        border-radius: 0.25rem;
        transition: all 0.15s ease-in-out;
    }

    .rich-text-toolbar .dropdown-item:focus {
        background-color: rgba(59, 125, 221, 0.1);
        color: #212529;
    }

    .form-control:focus, .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.25rem var(--focus-ring-color);
    }

    .form-control.is-invalid:focus, .form-select.is-invalid:focus {
        box-shadow: 0 0 0 0.25rem var(--error-focus-color);
    }

    .input-group > .form-control:focus,
    .input-group > .form-select:focus {
        z-index: 3;
    }

    .input-group-text {
        transition: border-color 0.15s ease-in-out;
    }

    .input-group:focus-within .input-group-text {
        border-color: var(--primary-color);
    }

    .form-check-input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.25rem var(--focus-ring-color);
    }

    .btn:focus {
        box-shadow: 0 0 0 0.25rem var(--focus-ring-color);
    }

    .settings-card {
        border: 1px solid rgba(0,0,0,.125);
        border-radius: 0.25rem;
        transition: all 0.2s;
    }

    .settings-card:focus-within {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.25rem var(--focus-ring-color);
    }
    
    .form-switch .form-check-input:focus {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='%233b7ddd'/%3e%3c/svg%3e");
    }

.form-control, .form-select {
    border-color: #e9ecef;
    padding: 0.75rem 1rem;
    font-size: 0.95rem;
    transition: all 0.2s ease;
        background-color: #fff;
        pointer-events: auto;
}

.form-control-lg {
    font-size: 1.1rem;
}

.form-label {
    font-weight: 500;
    margin-bottom: 0.5rem;
    color: var(--text-dark);
    display: flex;
    align-items: center;
    gap: 0.3rem;
}

.form-text {
    color: var(--text-muted);
    font-size: 0.85rem;
    margin-top: 0.5rem;
}

textarea {
    resize: vertical;
    min-height: 120px;
}

.btn {
    padding: 0.6rem 1.2rem;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    border-radius: 8px;
    transition: all 0.2s ease;
}

.btn-light {
    background-color: #f8f9fa;
    border-color: #e9ecef;
}

.btn-light:hover {
    background-color: #e9ecef;
    border-color: #dde0e3;
}

.material-icons {
    font-size: 1.1rem;
}

/* Form validation styles */
.form-control:invalid:not(:placeholder-shown),
.form-select:invalid:not(:placeholder-shown) {
    border-color: var(--danger);
}

.form-control:invalid:not(:placeholder-shown):focus,
.form-select:invalid:not(:placeholder-shown):focus {
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
}

/* Priority select custom styles */
#priority {
    padding-right: 2rem;
}

#priority option[value="HIGH"] {
    color: var(--danger);
}

#priority option[value="MEDIUM"] {
    color: var(--warning);
}

#priority option[value="LOW"] {
    color: var(--success);
}

.form-select-lg {
    font-size: 1.1rem;
    padding: 0.75rem 1rem;
    height: calc(3.5rem + 2px);
}

.btn-primary {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
}

.btn-primary:hover {
    background-color: #1d4ed8;
    border-color: #1d4ed8;
}

.btn-outline-secondary {
    border-color: #e9ecef;
    color: var(--text-dark);
}

.btn-outline-secondary:hover {
    background-color: #f8f9fa;
    border-color: #e9ecef;
    color: var(--text-dark);
}

    /* Main form styles */
.form-section {
        position: relative;
        border: 1px solid var(--light);
        border-radius: 0.5rem;
        padding: 1.25rem;
        margin-bottom: 1rem;
        transition: all 0.2s ease-in-out;
    }

    .form-section:focus-within {
        border-color: var(--primary);
        box-shadow: 0 0 0 0.2rem rgba(var(--bs-primary-rgb), 0.25);
    }

    /* Rich text editor styles */
    .rich-text-editor {
        min-height: 200px;
        padding: 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 0.375rem;
        overflow-y: auto;
        transition: all 0.2s ease-in-out;
    }

    .rich-text-editor:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 0.2rem rgba(var(--bs-primary-rgb), 0.25);
    }

    .rich-text-editor.is-invalid {
        border-color: var(--danger);
    }

    .rich-text-editor[data-placeholder]:empty:before {
        content: attr(data-placeholder);
        color: var(--secondary);
        pointer-events: none;
    }

    .rich-text-toolbar {
        border: 1px solid var(--border-color);
        border-bottom: none;
        border-top-left-radius: 0.375rem;
        border-top-right-radius: 0.375rem;
        background-color: var(--light-bg);
        padding: 0.5rem;
    }

    .rich-text-toolbar button {
        background: transparent;
        border: 1px solid transparent;
        border-radius: 0.25rem;
        padding: 0.25rem 0.5rem;
        margin-right: 0.125rem;
        color: var(--dark);
        cursor: pointer;
}

    .rich-text-toolbar button:hover {
        background-color: rgba(var(--bs-primary-rgb), 0.1);
    }

    .rich-text-toolbar button:focus {
        outline: none;
        box-shadow: 0 0 0 0.2rem rgba(var(--bs-primary-rgb), 0.25);
    }

    /* Form controls with better accessibility */
    .form-control:focus, .form-select:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 0.2rem rgba(var(--bs-primary-rgb), 0.25);
    }

    .form-control.is-invalid, .form-select.is-invalid, .rich-text-editor.is-invalid {
        border-color: var(--danger);
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right calc(0.375em + 0.1875rem) center;
        background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
    }

    .rich-text-editor.is-invalid {
        background-position: right 0.75rem top 0.75rem;
    }

    /* Dropdown accessibility improvements */
    .dropdown-item {
        cursor: pointer;
    }

    .dropdown-item:focus {
        outline: none;
        background-color: rgba(var(--bs-primary-rgb), 0.1);
    }

    /* Settings card styles */
    .setting-card {
        border: 1px solid var(--light);
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1rem;
        transition: all 0.2s ease-in-out;
    }

    .setting-card.border-primary {
        border-color: var(--primary);
    }

    .setting-description {
        border-left: 3px solid var(--light);
        padding-left: 1rem;
        margin: 0.5rem 0;
        transition: all 0.2s ease-in-out;
    }

    .setting-description.border-primary {
        border-left-color: var(--primary);
    }

    /* Switch toggle styles */
    .form-check-input[type="checkbox"] {
        cursor: pointer;
    }

    .form-check-input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 0.2rem rgba(var(--bs-primary-rgb), 0.25);
}

    /* New styling for enhanced form */
.form-section-title {
    background-color: #f8f9fa;
    padding: 0.75rem 1rem;
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-dark);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.form-section-title .material-icons {
    color: var(--primary-color);
}

.form-section-content {
    padding: 1.5rem;
}

.tooltip-icon {
    font-size: 1rem;
    color: #adb5bd;
    cursor: help;
}

.alert-info {
    background-color: #e6f3ff;
    border-color: #cce5ff;
    color: #004085;
}

.setting-card {
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
    height: 100%;
    transition: all 0.2s ease;
    border: 1px solid transparent;
}

.setting-card:hover {
    background-color: #f0f4f8;
    border-color: #e9ecef;
}

.setting-header {
    display: flex;
    align-items: center;
    margin-bottom: 0.25rem;
}

.setting-description {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    margin-top: 0.25rem;
    padding-left: 0.5rem;
}

.setting-description .material-icons {
    color: #6c757d;
    font-size: 1.2rem;
    min-width: 24px;
}

.setting-description .form-text {
    margin-top: 0;
    line-height: 1.4;
}

.form-check-input {
    cursor: pointer;
}

.form-check-label {
    cursor: pointer;
}

.form-switch .form-check-input {
    width: 2.5em;
    height: 1.25em;
}

/* Improved toggle switch styling */
.form-check.form-switch {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding-left: 0;
    position: relative;
}

.form-check.form-switch .form-check-input {
    margin-left: 0;
    float: none;
    height: 1.8rem;
    width: 3.6rem;
    border-width: 2px;
    box-shadow: none;
    background-color: #e9ecef;
    border-color: #ced4da;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='%23fff'/%3e%3c/svg%3e");
    transition: all 0.3s ease;
}

.form-check.form-switch .form-check-input:checked {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
    background-position: right center;
}

.form-check.form-switch .form-check-input:focus {
    box-shadow: 0 0 0 0.25rem rgba(37, 99, 235, 0.25);
}

.form-check.form-switch .form-check-label {
    margin-top: 0;
    font-size: 1.1rem;
    font-weight: 500;
}

/* Status indicator for toggle */
.form-check.form-switch::after {
    content: "OFF";
    position: absolute;
    right: -40px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 0.8rem;
    font-weight: 600;
    color: #6c757d;
    background-color: #e9ecef;
    padding: 2px 6px;
    border-radius: 4px;
    transition: all 0.3s ease;
}

.form-check.form-switch:has(.form-check-input:checked)::after {
    content: "ON";
    color: white;
    background-color: var(--primary-color);
}

/* Setting card styling */
.setting-card {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    padding: 1.5rem;
    border: 1px solid #e9ecef;
    border-radius: 10px;
    transition: all 0.2s ease;
    background-color: white;
}

.setting-card:hover {
    background-color: #f8f9fa;
    border-color: #dee2e6;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.setting-header {
    display: flex;
    align-items: center;
    margin-bottom: 0.5rem;
    padding-right: 3rem; /* Make room for the ON/OFF indicator */
    position: relative;
}

.setting-description {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    margin-top: 0.5rem;
    padding-left: 0.75rem;
    border-left: 3px solid #e9ecef;
}

.setting-description .material-icons {
    color: #6c757d;
    font-size: 1.2rem;
    min-width: 24px;
}

.setting-description .form-text {
    margin-top: 0;
    line-height: 1.4;
    color: #6c757d;
}

/* Additional spacing for better visibility */
.row.mb-4 {
    margin-bottom: 2rem !important;
}

.priority-select-wrapper {
    position: relative;
}

.priority-indicator {
    position: absolute;
    top: 50%;
    right: 2.5rem;
    transform: translateY(-50%);
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background-color: var(--warning);
}

#priority[value="HIGH"] ~ .priority-indicator {
    background-color: var(--danger);
}

#priority[value="MEDIUM"] ~ .priority-indicator {
    background-color: var(--warning);
}

#priority[value="LOW"] ~ .priority-indicator {
    background-color: var(--success);
}

/* Mobile Responsiveness */
@media (max-width: 768px) {
    .form-section-content {
        padding: 1rem;
    }
    
    .form-label {
        font-size: 0.9rem;
    }
    
    .form-control, .form-select {
        font-size: 0.9rem;
        padding: 0.6rem 0.75rem;
    }
    
    .form-control-lg {
        font-size: 1rem;
        padding: 0.6rem 0.75rem;
    }
    
    .form-select-lg {
        height: calc(2.8rem + 2px);
    }
    
    .setting-card {
        padding: 1rem;
    }
    
    .setting-description {
        font-size: 0.8rem;
    }
    
    .form-check.form-switch .form-check-label {
        font-size: 0.9rem;
    }
    
    .form-check.form-switch .form-check-input {
        height: 1.5rem;
        width: 3rem;
    }
    
    .form-check.form-switch::after {
        display: none;
    }
    
    .tooltip-icon {
        font-size: 0.9rem;
    }
    
    .btn {
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
    }
    
    .material-icons {
        font-size: 1rem;
    }
    
    textarea {
        min-height: 100px;
    }
    
    .form-instructions li {
        font-size: 0.8rem;
        margin-bottom: 0.25rem;
    }
    
    .alert-info {
        padding: 0.75rem;
    }
    
    .form-section-title {
        font-size: 0.9rem;
        padding: 0.6rem 0.75rem;
    }
    
    .flex-fill {
        width: 100%;
    }
}

@media (max-width: 576px) {
    .card-body {
        padding: 1rem !important;
    }
    
    .form-section {
        margin-bottom: 1rem !important;
    }
    
    .form-section-content {
        padding: 0.75rem;
    }
    
    .setting-description {
        padding-left: 0.5rem;
    }
    
    h4 {
        font-size: 1.25rem;
    }
}
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get elements
        const form = document.getElementById('announcementForm');
        const titleInput = document.getElementById('title');
        const categorySelect = document.getElementById('category');
        const editor = document.getElementById('editor');
        const contentInput = document.getElementById('content');
        const submitButton = document.getElementById('submit-button');
        const isPopupCheckbox = document.getElementById('is_popup');
        const requiresAcknowledgmentCheckbox = document.getElementById('requires_acknowledgment');
        const requiresAcknowledgmentCard = requiresAcknowledgmentCheckbox.closest('.setting-card');
        const popupAcknowledgeFields = document.getElementById('popupAcknowledgeFields');
        
        // New popup related elements
        const autoDismissCheckbox = document.getElementById('auto_dismiss');
        const autoDismissTimeContainer = document.getElementById('auto_dismiss_time_container');
        const popupWidthSelect = document.getElementById('popup_width');
        const popupPositionSelect = document.getElementById('popup_position');
        const allowCloseCheckbox = document.getElementById('allow_close');
        const showPreviewButton = document.getElementById('show_preview');
        
        // Initialize popup fields visibility
        updatePopupRelatedFields();
        
        // Toggle popup fields when checkbox changes
        isPopupCheckbox.addEventListener('change', updatePopupRelatedFields);
        
        function updatePopupRelatedFields() {
            const isPopupEnabled = isPopupCheckbox.checked;
            
            // Show/hide additional popup info
            popupAcknowledgeFields.style.display = isPopupEnabled ? 'block' : 'none';
            
            // Enable/disable acknowledgment checkbox based on popup status
            if (!isPopupEnabled) {
                requiresAcknowledgmentCheckbox.checked = false;
                requiresAcknowledgmentCheckbox.disabled = true;
                requiresAcknowledgmentCard.classList.add('opacity-50');
            } else {
                requiresAcknowledgmentCheckbox.disabled = false;
                requiresAcknowledgmentCard.classList.remove('opacity-50');
}
        }
        
        // Toggle auto dismiss time input based on checkbox
        autoDismissCheckbox.addEventListener('change', function() {
            autoDismissTimeContainer.style.display = this.checked ? 'block' : 'none';
        });
        
        // Preview functionality
        showPreviewButton.addEventListener('click', function() {
            const title = titleInput.value.trim() || 'Announcement Title';
            const content = editor.innerHTML || '<p>Announcement content will appear here...</p>';
            
            // Create the preview modal using SweetAlert2
            Swal.fire({
                title: title,
                html: content,
                width: getPopupWidth(),
                position: getPopupPosition(),
                showConfirmButton: requiresAcknowledgmentCheckbox.checked,
                showCloseButton: allowCloseCheckbox.checked,
                confirmButtonText: 'Acknowledge',
                confirmButtonColor: '#3b7ddd',
                allowOutsideClick: !requiresAcknowledgmentCheckbox.checked,
                allowEscapeKey: !requiresAcknowledgmentCheckbox.checked,
                backdrop: true,
                customClass: {
                    container: 'popup-preview-container',
                    popup: 'popup-preview-popup',
                    header: 'popup-preview-header',
                    title: 'popup-preview-title',
                    content: 'popup-preview-content'
                }
    });
    
            // If auto dismiss is enabled, close the preview after the specified time
            if (autoDismissCheckbox.checked && !requiresAcknowledgmentCheckbox.checked) {
                const dismissTime = parseInt(document.getElementById('auto_dismiss_time').value) * 1000;
                setTimeout(() => {
                    Swal.close();
                }, dismissTime);
            }
        });
        
        // Helper functions for preview
        function getPopupWidth() {
            const width = popupWidthSelect.value;
            switch(width) {
                case 'small': return '400px';
                case 'large': return '800px';
                case 'xlarge': return '1000px';
                default: return '600px'; // medium
            }
        }
        
        function getPopupPosition() {
            return popupPositionSelect.value;
        }
    
        // Set focus on title input when page loads
        titleInput.focus();
        
        // Rich text editor toolbar buttons
        const toolbar = document.querySelector('.rich-text-toolbar');
        const toolbarButtons = toolbar.querySelectorAll('button:not(.dropdown-toggle)');
        const dropdownItems = document.querySelectorAll('.dropdown-item[data-command]');
        
        // Function to check if editor has content
        function editorHasContent() {
            const text = editor.innerText || '';
            return text.trim().length > 0;
        }
        
        // Form validation
        function validateForm() {
            let isValid = true;
            
            // Check title
            if (!titleInput.value.trim()) {
                titleInput.classList.add('is-invalid');
                isValid = false;
            } else {
                titleInput.classList.remove('is-invalid');
            }
            
            // Check category
            if (!categorySelect.value) {
                categorySelect.classList.add('is-invalid');
                isValid = false;
            } else {
                categorySelect.classList.remove('is-invalid');
            }
            
            // Check editor content
            if (!editorHasContent()) {
                editor.classList.add('is-invalid');
                isValid = false;
    } else {
                editor.classList.remove('is-invalid');
            }
            
            return isValid;
    }
    
        // Handle form submission
        form.addEventListener('submit', function(e) {
            if (!validateForm()) {
            e.preventDefault();
            
                // Focus on the first invalid field
                const firstInvalid = form.querySelector('.is-invalid');
                if (firstInvalid) {
                    if (firstInvalid === editor) {
                        editor.focus();
        } else {
                        firstInvalid.focus();
        }
                }
                return;
            }
            
            // Update hidden content input with editor HTML
            contentInput.value = editor.innerHTML;
        });
        
        // Editor focus and blur events
        editor.addEventListener('focus', function() {
            editor.classList.add('focused');
        });
        
        editor.addEventListener('blur', function() {
            editor.classList.remove('focused');
        });
    
        // Make editor work with execCommand
        toolbarButtons.forEach(function(button) {
            button.addEventListener('click', function(e) {
        e.preventDefault();
                const command = this.dataset.command;
                
                if (command) {
                    document.execCommand(command, false, null);
                    editor.focus();
                }
            });
    });
    
        // Handle dropdown items (headings, font size, etc.)
        dropdownItems.forEach(function(item) {
            item.addEventListener('click', function(e) {
        e.preventDefault();
                const command = this.dataset.command;
                const value = this.dataset.value;
        
                if (command && value) {
                    document.execCommand(command, false, value);
                    editor.focus();
        }
            });
        });
    
        // Remove invalid state when content is entered
        titleInput.addEventListener('input', function() {
            if (this.value.trim()) {
                this.classList.remove('is-invalid');
            }
        });
        
        categorySelect.addEventListener('input', function() {
            if (this.value) {
                this.classList.remove('is-invalid');
            }
        });
        
        editor.addEventListener('input', function() {
            if (editorHasContent()) {
                this.classList.remove('is-invalid');
            }
    });
    
        // Device preview switcher
        const devicePreviewButtons = document.querySelectorAll('.dropdown-item[data-device]');
        const previewFrame = document.querySelector('.popup-preview-frame');
        
        devicePreviewButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Remove active class from all buttons
                devicePreviewButtons.forEach(btn => btn.classList.remove('active'));
                
                // Add active class to clicked button
                this.classList.add('active');
                
                // Update preview frame dimensions
                const device = this.dataset.device;
                switch(device) {
                    case 'mobile':
                        previewFrame.style.maxWidth = '375px';
                        previewFrame.style.margin = '0 auto';
                        break;
                    case 'tablet':
                        previewFrame.style.maxWidth = '768px';
                        previewFrame.style.margin = '0 auto';
                        break;
                    default: // desktop
                        previewFrame.style.maxWidth = '100%';
                        previewFrame.style.margin = '0';
                }
            });
        });
});
</script>
{% endblock %} 