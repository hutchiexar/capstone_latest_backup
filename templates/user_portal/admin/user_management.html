{% extends 'base.html' %}

<!-- SweetAlert2 Library (if not already included in base.html) -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.min.css">
<!-- Add MicroModal.js with defer to ensure it loads completely -->
<script src="https://unpkg.com/micromodal/dist/micromodal.min.js" defer></script>

<script>
// Check for success parameter in URL
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const success = urlParams.get('success');
    
    if (success === 'created') {
        Swal.fire({
            icon: 'success',
            title: 'Success!',
            text: 'User has been created successfully',
            confirmButtonText: 'OK'
        });
        
        // Clean up the URL to remove the success parameter
        const url = new URL(window.location.href);
        url.searchParams.delete('success');
        window.history.replaceState({}, document.title, url);
    }
    
    // Initialize MicroModal with specific options for closing
    if (typeof MicroModal !== 'undefined') {
        console.log('Initializing MicroModal...');
        MicroModal.init({
            openTrigger: 'data-micromodal-trigger',
            closeTrigger: 'data-micromodal-close',
            disableScroll: true,
            disableFocus: false,
            awaitOpenAnimation: true,
            awaitCloseAnimation: true,
            debugMode: true,
            onShow: modal => console.log(`${modal.id} is shown`),
            onClose: modal => console.log(`${modal.id} is hidden`)
        });
        
        // Add keyboard event listener for ESC key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const openModals = document.querySelectorAll('.modal.is-open');
                openModals.forEach(modal => {
                    MicroModal.close(modal.id);
                });
            }
        });
        
        // Add manual close handlers to all close buttons and overlays
        document.querySelectorAll('[data-micromodal-close]').forEach(element => {
            element.addEventListener('click', function() {
                const modalId = this.closest('.modal').id;
                console.log(`Manual close requested for ${modalId}`);
                MicroModal.close(modalId);
            });
        });
    } else {
        console.error('MicroModal is not loaded! Falling back to standard functionality.');
    }
});
</script>

{% block content %}
<!-- Check for Django messages and display them as SweetAlert -->
{% if messages %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        {% for message in messages %}
            {% if message.tags == 'success' %}
                Swal.fire({
                    icon: 'success',
                    title: 'Success!',
                    text: "{{ message|escapejs }}",
                    confirmButtonText: 'OK'
                });
            {% elif message.tags == 'error' %}
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: "{{ message|escapejs }}",
                    confirmButtonText: 'OK'
                });
            {% else %}
                Swal.fire({
                    icon: 'info',
                    title: 'Information',
                    text: "{{ message|escapejs }}",
                    confirmButtonText: 'OK'
                });
            {% endif %}
        {% endfor %}
    });
</script>
{% endif %}

<div class="container-fluid py-4 px-3">
    <!-- Header Section -->
    <div class="card shadow-sm border-0 rounded-3 mb-4">
        <div class="card-body p-4">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
                <div class="d-flex align-items-center gap-3">
                    <div class="icon-circle bg-primary text-white d-flex align-items-center justify-content-center">
                        <span class="material-icons">people</span>
                    </div>
                    <div>
                        <h4 class="mb-0 fw-bold">Regular User Management</h4>
                        <p class="text-muted mb-0">Total Regular Users: {{ total_users }}</p>
                    </div>
                </div>
                
                <!-- Search Form -->
                <form method="get" class="w-100 mt-3 mt-md-0">
                    <div class="row g-2">
                        <div class="col-12 col-sm-6 col-md-4">
                            <div class="search-input d-flex align-items-center bg-light rounded px-3 py-2">
                                <span class="material-icons me-2 text-muted">search</span>
                                <input type="text" 
                                    name="search" 
                                    id="userSearch"
                                    class="form-control border-0 bg-transparent shadow-none" 
                                    placeholder="Search by name, email, or license..."
                                    value="{{ request.GET.search|default:'' }}">
                            </div>
                        </div>
                        <div class="col-6 col-sm-6 col-md-3">
                            <div class="search-input d-flex align-items-center bg-light rounded px-3 py-2">
                                <span class="material-icons me-2 text-muted">directions_car</span>
                                <select name="has_vehicles" class="form-select border-0 bg-transparent shadow-none">
                                    <option value="">All Users</option>
                                    <option value="yes" {% if request.GET.has_vehicles == 'yes' %}selected{% endif %}>With Vehicles</option>
                                    <option value="no" {% if request.GET.has_vehicles == 'no' %}selected{% endif %}>Without Vehicles</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-6 col-sm-6 col-md-3">
                            <div class="search-input d-flex align-items-center bg-light rounded px-3 py-2">
                                <span class="material-icons me-2 text-muted">check_circle</span>
                                <select name="status" class="form-select border-0 bg-transparent shadow-none">
                                    <option value="">All Status</option>
                                    <option value="active" {% if request.GET.status == 'active' %}selected{% endif %}>Active</option>
                                    <option value="inactive" {% if request.GET.status == 'inactive' %}selected{% endif %}>Inactive</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-12 col-sm-6 col-md-2">
                            <button type="submit" class="btn btn-primary d-flex align-items-center justify-content-center w-100 px-3 py-2">
                                <span class="material-icons me-2">search</span>
                                <span>Search</span>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row g-3 mb-4">
        <div class="col-6 col-md-3">
            <div class="card bg-light shadow-sm h-100">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1 small">Total Regular Users</h6>
                            <h4 class="mb-0 fs-4">{{ total_users }}</h4>
                        </div>
                        <div class="stat-icon text-primary d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; border-radius: 8px; background-color: rgba(13, 110, 253, 0.1);">
                            <span class="material-icons">people</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card bg-light shadow-sm h-100">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1 small">Registered Vehicles</h6>
                            <h4 class="mb-0 fs-4">{{ total_vehicles }}</h4>
                        </div>
                        <div class="stat-icon text-success d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; border-radius: 8px; background-color: rgba(25, 135, 84, 0.1);">
                            <span class="material-icons">directions_car</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card bg-light shadow-sm h-100">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1 small">With License</h6>
                            <h4 class="mb-0 fs-4">{{ users_with_license }}</h4>
                        </div>
                        <div class="stat-icon text-warning d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; border-radius: 8px; background-color: rgba(255, 193, 7, 0.1);">
                            <span class="material-icons">badge</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card bg-light shadow-sm h-100">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1 small">Violations Issued</h6>
                            <h4 class="mb-0 fs-4">{{ total_violations }}</h4>
                        </div>
                        <div class="stat-icon text-danger d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; border-radius: 8px; background-color: rgba(220, 53, 69, 0.1);">
                            <span class="material-icons">gavel</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Card -->
    <div class="card shadow-sm border-0 rounded-3">
        <div class="card-body p-0">
            <!-- Table Container for desktop -->
            <div class="table-responsive d-none d-md-block">
                <table class="table table-system table-hover align-middle mb-0" id="usersTable">
                    <thead class="bg-light">
                        <tr>
                            <th class="border-0 ps-4">User</th>
                            <th class="border-0">License</th>
                            <th class="border-0">Vehicles</th>
                            <th class="border-0">Joined</th>
                            <th class="border-0 text-end pe-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user_data in user_data %}
                        <tr class="parent-row" data-user-id="{{ user_data.user.id }}">
                            <td class="ps-4">
                                <div class="table-profile">
                                    <div class="avatar-container">
                                        {% if user_data.user.userprofile.avatar %}
                                        <img src="{{ user_data.user.userprofile.avatar.url }}" alt="{{ user_data.user.get_full_name }}" class="rounded-circle">
                                        {% else %}
                                        <div class="avatar-placeholder">
                                            {{ user_data.user.first_name|slice:":1" }}{{ user_data.user.last_name|slice:":1" }}
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="user-info-container">
                                        <h6 class="mb-0">{{ user_data.user.get_full_name }}</h6>
                                        <div class="small text-muted">
                                            {{ user_data.user.email }}
                                        </div>
                                        <div class="small text-muted">
                                            {% if user_data.user.userprofile.phone_number %}
                                            <span class="material-icons" style="font-size: 0.9rem;">phone</span> {{ user_data.user.userprofile.phone_number }}
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                {% if user_data.user.userprofile.license_number %}
                                <span class="badge bg-success">{{ user_data.user.userprofile.license_number }}</span>
                                {% else %}
                                <span class="badge bg-secondary">No License</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if user_data.vehicle_count > 0 %}
                                <button class="btn-vehicle-toggle" data-user-id="{{ user_data.user.id }}">
                                    <span class="badge bg-info vehicle-count">{{ user_data.vehicle_count }}</span>
                                    <span class="vehicle-text">vehicle{{ user_data.vehicle_count|pluralize }}</span>
                                    <span class="toggle-icon material-icons">expand_more</span>
                                </button>
                                {% else %}
                                <span class="badge bg-secondary">No Vehicles</span>
                                {% endif %}
                            </td>
                            <td>
                                <div>{{ user_data.user.date_joined|date:"M d, Y" }}</div>
                                <div class="small text-muted">{{ user_data.joined_days_ago }} days ago</div>
                            </td>
                            <td class="text-end pe-4">
                                <div class="action-buttons">
                                    <button type="button" 
                                            class="btn btn-primary action-btn"
                                            data-micromodal-trigger="modal-user-detail"
                                            data-user-id="{{ user_data.user.id }}"
                                            title="View Details">
                                        <span class="material-icons">visibility</span>
                                    </button>
                                    {% if user_data.user.username != request.user.username %}
                                    <button type="button"
                                            class="btn {{ user_data.user.is_active|yesno:'btn-danger,btn-success' }} action-btn"
                                            data-user-id="{{ user_data.user.id }}"
                                            data-action="{{ user_data.user.is_active|yesno:'deactivate,activate' }}"
                                            title="{{ user_data.user.is_active|yesno:'Deactivate,Activate' }} User">
                                        <span class="material-icons">{{ user_data.user.is_active|yesno:'block,check_circle' }}</span>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% if user_data.vehicle_count > 0 %}
                        <tr class="vehicles-row" id="vehicles-{{ user_data.user.id }}" style="display: none;">
                            <td colspan="5" class="p-0">
                                <div class="vehicles-section">
                                    <div class="vehicle-list p-3">
                                        <div class="d-flex justify-content-between align-items-center mb-3 px-2">
                                            <h6 class="mb-0 d-flex align-items-center">
                                                <span class="material-icons me-2 text-primary">directions_car</span>
                                                Registered Vehicles
                                            </h6>
                                            <span class="vehicle-count-badge">{{ user_data.vehicle_count }} vehicle{{ user_data.vehicle_count|pluralize }}</span>
                                        </div>
                                        <div class="vehicle-grid">
                                            {% for vehicle in user_data.vehicles %}
                                            <div class="vehicle-card">
                                                <div class="vehicle-card-header">
                                                    <div class="vehicle-icon-container">
                                                        <span class="material-icons vehicle-icon">{{ vehicle.vehicle_type|lower|slice:":3" }}directions_car</span>
                                                    </div>
                                                    <div class="vehicle-title">
                                                        <h6 class="mb-0">{{ vehicle.vehicle_type }} {{ vehicle.model }}</h6>
                                                        <div class="plate-number">{{ vehicle.plate_number }}</div>
                                                    </div>
                                                    <span class="badge {{ vehicle.is_active|yesno:'bg-success,bg-danger' }} status-badge">
                                                        {{ vehicle.is_active|yesno:'Active,Inactive' }}
                                                    </span>
                                                </div>
                                                <div class="vehicle-card-content">
                                                    <div class="vehicle-detail">
                                                        <span class="detail-label">OR Number</span>
                                                        <span class="detail-value">{{ vehicle.or_number }}</span>
                                                    </div>
                                                    <div class="vehicle-detail">
                                                        <span class="detail-label">CR Number</span>
                                                        <span class="detail-value">{{ vehicle.cr_number }}</span>
                                                    </div>
                                                    <div class="vehicle-detail">
                                                        <span class="detail-label">Expires</span>
                                                        <span class="detail-value">{{ vehicle.registration_expiry|date:"M d, Y" }}</span>
                                                    </div>
                                                </div>
                                                <div class="vehicle-card-footer">
                                                    {% if vehicle.or_cr_image %}
                                                    <a href="#" 
                                                       class="btn-view-registration"
                                                       data-micromodal-trigger="modal-registration"
                                                       data-vehicle-id="{{ vehicle.id }}"
                                                       data-plate="{{ vehicle.plate_number }}"
                                                       data-or="{{ vehicle.or_number }}"
                                                       data-cr="{{ vehicle.cr_number }}"
                                                       data-type="{{ vehicle.vehicle_type }}"
                                                       data-make="{{ vehicle.make }}"
                                                       data-model="{{ vehicle.model }}"
                                                       data-year="{{ vehicle.year_model }}"
                                                       data-color="{{ vehicle.color }}"
                                                       data-classification="{{ vehicle.get_classification_display }}"
                                                       data-registration="{{ vehicle.registration_date|date:'M d, Y' }}"
                                                       data-expiry="{{ vehicle.registration_expiry|date:'M d, Y' }}"
                                                       data-image="{{ vehicle.or_cr_image.url }}">
                                                        <span class="material-icons me-1">description</span> View Registration
                                                    </a>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endif %}
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center py-5">
                                <div class="text-muted">
                                    <span class="material-icons d-block mb-3" style="font-size: 3rem; opacity: 0.5;">person_search</span>
                                    <h6 class="mb-1">No Regular Users Found</h6>
                                    <p class="mb-0 small">Try adjusting your search criteria</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Mobile card view for users -->
            <div class="user-cards d-block d-md-none">
                {% for user_data in user_data %}
                <div class="card mx-3 my-3 shadow-sm border-0 rounded-3">
                    <div class="card-header py-3 px-3 bg-white border-0 d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            {% if user_data.user.userprofile.avatar %}
                            <img src="{{ user_data.user.userprofile.avatar.url }}" alt="{{ user_data.user.get_full_name }}" class="rounded-circle me-2" style="width: 40px; height: 40px; object-fit: cover;">
                            {% else %}
                            <div class="avatar-placeholder me-2" style="width: 40px; height: 40px;">
                                {{ user_data.user.first_name|slice:":1" }}{{ user_data.user.last_name|slice:":1" }}
                            </div>
                            {% endif %}
                            <div>
                                <h6 class="mb-0 fw-bold">{{ user_data.user.get_full_name }}</h6>
                                <small class="text-muted">{{ user_data.user.email }}</small>
                            </div>
                        </div>
                        
                        {% if user_data.user.userprofile.license_number %}
                        <span class="badge bg-success">{{ user_data.user.userprofile.license_number }}</span>
                        {% else %}
                        <span class="badge bg-secondary">No License</span>
                        {% endif %}
                    </div>
                    
                    <div class="card-body p-3">
                        <div class="user-card-details">
                            <div class="row mb-2">
                                <div class="col-5 text-muted">Joined:</div>
                                <div class="col-7">{{ user_data.user.date_joined|date:"M d, Y" }} ({{ user_data.joined_days_ago }} days ago)</div>
                            </div>
                            
                            {% if user_data.user.userprofile.phone_number %}
                            <div class="row mb-2">
                                <div class="col-5 text-muted">Phone:</div>
                                <div class="col-7">{{ user_data.user.userprofile.phone_number }}</div>
                            </div>
                            {% endif %}
                            
                            <div class="row mb-2">
                                <div class="col-5 text-muted">Vehicles:</div>
                                <div class="col-7">
                                    {% if user_data.vehicle_count > 0 %}
                                    <span class="badge bg-info vehicle-count">{{ user_data.vehicle_count }}</span>
                                    <span class="vehicle-text">vehicle{{ user_data.vehicle_count|pluralize }}</span>
                                    {% else %}
                                    <span class="badge bg-secondary">No Vehicles</span>
                                    {% endif %}
                                </div>
                            </div>
                            
                            {% if user_data.vehicle_count > 0 %}
                            <div class="mt-3 user-vehicles-container" id="mobile-vehicles-{{ user_data.user.id }}" style="display: none;">
                                <div class="vehicles-section p-3 bg-light rounded-3">
                                    <h6 class="mb-3 d-flex align-items-center fw-bold">
                                        <span class="material-icons me-2 text-primary">directions_car</span>
                                        Registered Vehicles
                                    </h6>
                                    
                                    {% for vehicle in user_data.vehicles %}
                                    <div class="vehicle-card mb-3">
                                        <div class="vehicle-card-header">
                                            <div class="d-flex align-items-center">
                                                <div class="vehicle-icon-container me-2">
                                                    <span class="material-icons vehicle-icon">directions_car</span>
                                                </div>
                                                <div>
                                                    <h6 class="mb-0 fw-bold">{{ vehicle.vehicle_type }} {{ vehicle.model }}</h6>
                                                    <div class="plate-number">{{ vehicle.plate_number }}</div>
                                                </div>
                                            </div>
                                            <span class="badge {{ vehicle.is_active|yesno:'bg-success,bg-danger' }} status-badge mt-2">
                                                {{ vehicle.is_active|yesno:'Active,Inactive' }}
                                            </span>
                                        </div>
                                        <div class="vehicle-card-content mt-2">
                                            <div class="row g-2">
                                                <div class="col-6">
                                                    <span class="detail-label d-block">OR Number</span>
                                                    <span class="detail-value">{{ vehicle.or_number }}</span>
                                                </div>
                                                <div class="col-6">
                                                    <span class="detail-label d-block">CR Number</span>
                                                    <span class="detail-value">{{ vehicle.cr_number }}</span>
                                                </div>
                                                <div class="col-12">
                                                    <span class="detail-label d-block">Expires</span>
                                                    <span class="detail-value">{{ vehicle.registration_expiry|date:"M d, Y" }}</span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {% if vehicle.or_cr_image %}
                                        <div class="text-end mt-2">
                                            <a href="#" 
                                               class="btn btn-sm btn-outline-primary d-inline-flex align-items-center"
                                               data-micromodal-trigger="modal-registration"
                                               data-vehicle-id="{{ vehicle.id }}"
                                               data-plate="{{ vehicle.plate_number }}"
                                               data-or="{{ vehicle.or_number }}"
                                               data-cr="{{ vehicle.cr_number }}"
                                               data-type="{{ vehicle.vehicle_type }}"
                                               data-make="{{ vehicle.make }}"
                                               data-model="{{ vehicle.model }}"
                                               data-year="{{ vehicle.year_model }}"
                                               data-color="{{ vehicle.color }}"
                                               data-classification="{{ vehicle.get_classification_display }}"
                                               data-registration="{{ vehicle.registration_date|date:'M d, Y' }}"
                                               data-expiry="{{ vehicle.registration_expiry|date:'M d, Y' }}"
                                               data-image="{{ vehicle.or_cr_image.url }}">
                                                <span class="material-icons small me-1">description</span> View Registration
                                            </a>
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            
                            <div class="my-3 text-center">
                                <button type="button" class="btn btn-sm btn-outline-secondary mobile-vehicle-toggle" data-user-id="{{ user_data.user.id }}">
                                    <span class="toggle-text">Show Vehicles</span>
                                    <span class="material-icons align-middle ms-1 toggle-icon">expand_more</span>
                                </button>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="card-footer bg-light p-3 d-flex justify-content-end gap-2">
                        <button type="button" 
                                class="btn btn-primary action-btn"
                                data-micromodal-trigger="modal-user-detail"
                                data-user-id="{{ user_data.user.id }}"
                                title="View Details">
                            <span class="material-icons">visibility</span>
                            <span class="view-text">Details</span>
                        </button>
                        {% if user_data.user.username != request.user.username %}
                        <button type="button"
                                class="btn {{ user_data.user.is_active|yesno:'btn-danger,btn-success' }} action-btn"
                                data-user-id="{{ user_data.user.id }}"
                                data-action="{{ user_data.user.is_active|yesno:'deactivate,activate' }}"
                                title="{{ user_data.user.is_active|yesno:'Deactivate,Activate' }} User">
                            <span class="material-icons">{{ user_data.user.is_active|yesno:'block,check_circle' }}</span>
                            <span class="view-text">{{ user_data.user.is_active|yesno:'Deactivate,Activate' }}</span>
                        </button>
                        {% endif %}
                    </div>
                </div>
                {% empty %}
                <div class="text-center py-5">
                    <span class="material-icons d-block mb-3" style="font-size: 48px; opacity: 0.5;">person_search</span>
                    <h6 class="mb-1">No Regular Users Found</h6>
                    <p class="mb-0 small">Try adjusting your search criteria</p>
                </div>
                {% endfor %}
            </div>
            
            {% if user_data %}
            <div class="pagination-container">
                {% include 'includes/pagination.html' %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- User Detail Modal (MicroModal) -->
<div class="modal micromodal-slide" id="modal-user-detail" aria-hidden="true">
    <div class="modal__overlay" tabindex="-1" data-micromodal-close>
        <div class="modal__container modal-lg" role="dialog" aria-modal="true" aria-labelledby="modal-user-detail-title">
            <header class="modal__header">
                <h5 class="modal__title" id="modal-user-detail-title">
                    <span class="material-icons me-2 align-middle">person</span>
                    User Details
                </h5>
                <button class="modal__close" aria-label="Close modal" data-micromodal-close></button>
            </header>
            <div class="modal__content" id="modal-user-detail-content">
                <!-- Content will be loaded via AJAX -->
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div class="mt-3">Loading user details...</div>
                </div>
            </div>
            <footer class="modal__footer">
                <button class="btn btn-primary" data-micromodal-close>
                    <span class="material-icons me-1 align-middle" style="font-size: 18px;">close</span>
                    Close
                </button>
            </footer>
        </div>
    </div>
</div>

<!-- Registration Details Modal (MicroModal) -->
<div class="modal micromodal-slide" id="modal-registration" aria-hidden="true">
    <div class="modal__overlay" tabindex="-1" data-micromodal-close>
        <div class="modal__container modal-lg" role="dialog" aria-modal="true" aria-labelledby="modal-registration-title">
            <header class="modal__header">
                <h5 class="modal__title" id="modal-registration-title">
                    <span class="material-icons me-2 align-middle">description</span>
                    Vehicle Registration Details
                </h5>
                <button class="modal__close" aria-label="Close modal" data-micromodal-close></button>
            </header>
            <div class="modal__content" id="modal-registration-content">
                <div class="registration-details p-3">
                    <div class="row g-4">
                        <div class="col-md-5">
                            <div class="text-center mb-3 card shadow-sm p-3 bg-light">
                                <div id="registration-plate" class="fs-5 fw-bold mb-3 badge bg-primary p-2 d-inline-block mx-auto"></div>
                                <div class="image-container bg-white p-2 border rounded">
                                    <img id="registration-image" src="" class="img-fluid rounded" style="max-height: 350px; width: 100%; object-fit: contain;">
                                </div>
                                <div class="text-muted small mt-3 fst-italic">Official Registration Document</div>
                            </div>
                        </div>
                        <div class="col-md-7">
                            <div class="card shadow-sm mb-4">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">
                                        <span class="material-icons me-1 align-middle text-primary" style="font-size: 18px;">info</span>
                                        Registration Information
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <div class="registration-item">
                                                <label class="text-muted small d-block">OR Number</label>
                                                <div id="registration-or" class="fw-medium fs-6 border-bottom pb-1"></div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="registration-item">
                                                <label class="text-muted small d-block">CR Number</label>
                                                <div id="registration-cr" class="fw-medium fs-6 border-bottom pb-1"></div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="registration-item">
                                                <label class="text-muted small d-block">Registration Date</label>
                                                <div id="registration-date" class="fw-medium fs-6 border-bottom pb-1"></div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="registration-item">
                                                <label class="text-muted small d-block">Registration Expiry</label>
                                                <div id="registration-expiry" class="fw-medium fs-6 border-bottom pb-1 text-danger"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card shadow-sm">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">
                                        <span class="material-icons me-1 align-middle text-primary" style="font-size: 18px;">directions_car</span>
                                        Vehicle Information
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <div class="registration-item">
                                                <label class="text-muted small d-block">Classification</label>
                                                <div id="vehicle-classification" class="fw-medium fs-6 border-bottom pb-1"></div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="registration-item">
                                                <label class="text-muted small d-block">Vehicle Type</label>
                                                <div id="vehicle-type" class="fw-medium fs-6 border-bottom pb-1"></div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="registration-item">
                                                <label class="text-muted small d-block">Make</label>
                                                <div id="vehicle-make" class="fw-medium fs-6 border-bottom pb-1"></div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="registration-item">
                                                <label class="text-muted small d-block">Model</label>
                                                <div id="vehicle-model" class="fw-medium fs-6 border-bottom pb-1"></div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="registration-item">
                                                <label class="text-muted small d-block">Year Model</label>
                                                <div id="vehicle-year" class="fw-medium fs-6 border-bottom pb-1"></div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="registration-item">
                                                <label class="text-muted small d-block">Color</label>
                                                <div id="vehicle-color" class="fw-medium fs-6 border-bottom pb-1"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <footer class="modal__footer">
                <button class="btn btn-primary" data-micromodal-close>
                    <span class="material-icons me-1 align-middle" style="font-size: 18px;">close</span>
                    Close
                </button>
            </footer>
        </div>
    </div>
</div>

<style>
/* Enhanced Modal styles */
.modal__overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.7);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 2000;
}

.modal__container {
  background-color: #fff;
  padding: 0;
  max-width: 90%;
  width: 900px;
  max-height: 90vh;
  border-radius: 12px;
  overflow-y: auto;
  box-sizing: border-box;
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2),
    0 8px 20px rgba(0, 0, 0, 0.15);
}

.modal-lg {
  max-width: 90%;
  width: 900px;
}

.modal__header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1.25rem 1.5rem;
  border-bottom: 1px solid #eaeaea;
  background-color: #f8f9fa;
}

.modal__title {
  margin-top: 0;
  margin-bottom: 0;
  font-weight: 600;
  font-size: 1.25rem;
  line-height: 1.25;
  color: #333;
  box-sizing: border-box;
  display: flex;
  align-items: center;
}

.modal__close {
  background: transparent;
  border: 0;
  cursor: pointer;
  position: relative;
  width: 32px;
  height: 32px;
  transition: all 0.2s ease;
  border-radius: 50%;
}

.modal__close:hover {
  background-color: rgba(0,0,0,0.05);
}

.modal__close:before,
.modal__close:after {
  content: '';
  position: absolute;
  width: 2px;
  height: 18px;
  background-color: #555;
  top: 7px;
  left: 15px;
}

.modal__close:before {
  transform: rotate(45deg);
}

.modal__close:after {
  transform: rotate(-45deg);
}

.modal__content {
  padding: 0;
  line-height: 1.5;
  color: rgba(0, 0, 0, 0.8);
  max-height: 70vh;
  overflow-y: auto;
}

.modal__footer {
  display: flex;
  justify-content: flex-end;
  padding: 1.25rem 1.5rem;
  border-top: 1px solid #eaeaea;
  background-color: #f8f9fa;
}

.micromodal-slide {
  display: none;
}

.micromodal-slide.is-open {
  display: block;
}

.micromodal-slide[aria-hidden="false"] .modal__overlay {
  animation: mmfadeIn .35s cubic-bezier(0, 0, .2, 1);
}

.micromodal-slide[aria-hidden="false"] .modal__container {
  animation: mmslideIn .35s cubic-bezier(0, 0, .2, 1);
}

.micromodal-slide[aria-hidden="true"] .modal__overlay {
  animation: mmfadeOut .35s cubic-bezier(0, 0, .2, 1);
}

.micromodal-slide[aria-hidden="true"] .modal__container {
  animation: mmslideOut .35s cubic-bezier(0, 0, .2, 1);
}

.micromodal-slide .modal__container,
.micromodal-slide .modal__overlay {
  will-change: transform;
}

/* Enhanced registration items */
.registration-item {
  margin-bottom: 1rem;
}

.registration-item label {
  font-size: 0.8rem;
  margin-bottom: 0.25rem;
  color: #6c757d;
  font-weight: 500;
}

.registration-item .fw-medium {
  font-weight: 500;
  transition: all 0.2s ease;
}

.registration-item:hover .fw-medium {
  color: var(--primary-color);
}

/* Card styling */
.card {
  transition: all 0.3s ease;
  border: none;
}

.card:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 16px rgba(0,0,0,0.1) !important;
}

.card-header {
  padding: 0.75rem 1.25rem;
  border-bottom: 1px solid rgba(0,0,0,0.075);
}

/* Image container styling */
.image-container {
  transition: all 0.3s ease;
}

.image-container:hover {
  transform: scale(1.02);
  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

/* Button styling */
.btn-primary {
  display: inline-flex;
  align-items: center;
  padding: 0.5rem 1rem;
  font-weight: 500;
  transition: all 0.2s ease;
}

.btn-primary:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

@keyframes mmfadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes mmfadeOut {
  from { opacity: 1; }
  to { opacity: 0; }
}

@keyframes mmslideIn {
  from { transform: translateY(15%); }
  to { transform: translateY(0); }
}

@keyframes mmslideOut {
  from { transform: translateY(0); }
  to { transform: translateY(-10%); }
}

/* Vehicle Section Styles */
.vehicles-section {
    background-color: #f8f9fa;
    border-top: 1px solid #e5e7eb;
    border-bottom: 1px solid #e5e7eb;
    transition: all 0.3s ease;
    box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.05);
}

.vehicle-list {
    padding: 1.25rem !important;
}

.vehicle-count-badge {
    background-color: rgba(13, 110, 253, 0.1);
    color: var(--primary-color);
    font-size: 0.85rem;
    padding: 0.35rem 0.75rem;
    border-radius: 50rem;
    font-weight: 500;
}

/* Vehicle Grid Layout */
.vehicle-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1rem;
    margin-top: 0.75rem;
}

/* Vehicle Card Styling */
.vehicle-card {
    background-color: white;
    border-radius: 0.75rem;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border: 1px solid rgba(0, 0, 0, 0.05);
}

.vehicle-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
}

.vehicle-card-header {
    display: flex;
    align-items: center;
    padding: 1rem;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    background-color: rgba(13, 110, 253, 0.03);
}

.vehicle-icon-container {
    background-color: var(--primary-color);
    color: white;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 0.75rem;
    flex-shrink: 0;
}

.vehicle-icon {
    font-size: 1.25rem;
}

.vehicle-title {
    flex: 1;
    min-width: 0;
}

.vehicle-title h6 {
    font-weight: 600;
    margin-bottom: 0.125rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.plate-number {
    font-size: 0.85rem;
    color: #6c757d;
    font-weight: 500;
}

.status-badge {
    margin-left: 0.75rem;
    padding: 0.35em 0.65em;
    font-size: 0.75em;
}

.vehicle-card-content {
    padding: 1rem;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 0.75rem;
}

.vehicle-detail {
    display: flex;
    flex-direction: column;
}

.detail-label {
    font-size: 0.7rem;
    color: #6c757d;
    margin-bottom: 0.25rem;
    text-transform: uppercase;
    letter-spacing: 0.02em;
}

.detail-value {
    font-weight: 500;
    font-size: 0.875rem;
}

.vehicle-card-footer {
    padding: 0.75rem 1rem;
    background-color: #f8f9fa;
    border-top: 1px solid rgba(0, 0, 0, 0.05);
    text-align: right;
}

.btn-view-registration {
    display: inline-flex;
    align-items: center;
    font-size: 0.875rem;
    color: var(--primary-color);
    text-decoration: none;
    padding: 0.375rem 0.75rem;
    border-radius: 0.375rem;
    transition: background-color 0.2s ease;
    background-color: rgba(13, 110, 253, 0.1);
}

.btn-view-registration:hover {
    background-color: rgba(13, 110, 253, 0.15);
    color: var(--primary-color);
}

/* Vehicle Toggle Button */
.btn-vehicle-toggle {
    display: inline-flex;
    align-items: center;
    background: none;
    border: none;
    padding: 0.375rem 0.75rem;
    cursor: pointer;
    transition: all 0.2s ease;
    border-radius: 0.375rem;
}

.btn-vehicle-toggle:hover {
    background-color: rgba(13, 110, 253, 0.05);
}

.vehicle-count {
    margin-right: 0.5rem;
}

.vehicle-text {
    margin-right: 0.5rem;
    color: #6c757d;
}

.toggle-icon {
    font-size: 1.1rem;
    transition: transform 0.2s ease;
    color: #6c757d;
}

.btn-vehicle-toggle.active .toggle-icon {
    transform: rotate(180deg);
}

/* Responsive adjustments */
@media (max-width: 992px) {
    .vehicle-grid {
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    }
}

@media (max-width: 768px) {
    .vehicle-grid {
        grid-template-columns: 1fr;
    }
}

/* Mobile Card Styling for Users */
.user-cards .card {
    transition: all 0.25s ease;
    border-radius: 12px;
    overflow: hidden;
}

.user-cards .card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1) !important;
}

.avatar-placeholder {
    width: 32px;
    height: 32px;
    background-color: var(--primary-color);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 0.9rem;
}

.user-cards .card-header {
    background-color: white;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
}

.user-cards .card-footer {
    background-color: #f8f9fa;
    border-top: 1px solid rgba(0, 0, 0, 0.05);
}

.user-card-details .row {
    margin-bottom: 0.5rem;
}

.user-vehicles-container {
    background-color: #f8f9fa;
    border-radius: 8px;
    margin-top: 0.75rem;
    padding: 0.75rem;
}

.mobile-vehicle-toggle {
    transition: all 0.2s ease;
    border-radius: 50px;
    padding: 0.375rem 1rem;
}

.mobile-vehicle-toggle.active .toggle-icon {
    transform: rotate(180deg);
}

.mobile-vehicle-toggle .toggle-icon {
    transition: transform 0.2s ease;
}

/* Container for better touch on small screens */
.container-fluid {
    max-width: 1600px;
}

/* Better focus states for accessibility */
.btn:focus, .form-control:focus, .form-select:focus {
    box-shadow: 0 0 0 0.2rem rgba(var(--primary-color-rgb), 0.25);
}

/* Search form styling */
.search-input {
    border-radius: 8px;
    transition: all 0.2s ease;
}

.search-input:focus-within {
    box-shadow: 0 0 0 0.2rem rgba(var(--primary-color-rgb), 0.15);
}

/* Mobile optimizations */
@media (max-width: 768px) {
    /* Prevent iOS zoom on input focus */
    input, select, textarea {
        font-size: 16px !important;
    }

    /* Card and spacing adjustments */
    .card-body {
        padding: 1rem !important;
    }

    .card-header, .card-footer {
        padding: 0.75rem 1rem !important;
    }

    .container-fluid {
        padding-left: 0.75rem !important;
        padding-right: 0.75rem !important;
    }

    /* Better button sizes for touch */
    .btn {
        padding: 0.5rem 1rem;
    }

    .btn-sm {
        padding: 0.25rem 0.75rem;
        font-size: 0.75rem;
    }

    /* Font size adjustments */
    h4 {
        font-size: 1.35rem !important;
    }

    h5 {
        font-size: 1.1rem !important;
    }

    h6 {
        font-size: 1rem !important;
    }

    /* Better modals on mobile */
    .modal__container {
        width: 95% !important;
        max-height: 85vh !important;
    }
}

/* Ultra small screens */
@media (max-width: 360px) {
    .btn {
        padding: 0.4rem 0.75rem;
        font-size: 0.85rem;
    }

    .btn-sm {
        padding: 0.2rem 0.5rem;
        font-size: 0.7rem;
    }

    h4 {
        font-size: 1.25rem !important;
    }

    .card-body, .card-header, .card-footer {
        padding: 0.75rem !important;
    }
}

/* Add standardized action-btn styling */
.action-buttons {
    display: flex !important;
    justify-content: center !important;
    align-items: center !important;
    gap: 4px !important;
    width: 100% !important;
    max-width: 140px !important;
    margin-left: auto !important;
}

.action-btn {
    width: 40px !important;
    height: 40px !important;
    min-width: 40px !important;
    max-width: 40px !important;
    padding: 0 !important;
    border-radius: 4px !important;
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
    flex: 0 0 40px !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
    transition: all 0.2s !important;
}

.action-btn:hover {
    transform: translateY(-2px) !important;
    box-shadow: 0 4px 8px rgba(0,0,0,0.15) !important;
}

.action-btn .material-icons {
    color: white !important;
    font-size: 18px !important;
    margin: 0 !important;
    line-height: 1 !important;
}

/* Responsive styles for action buttons */
@media (max-width: 768px) {
    .action-btn {
        width: 36px !important;
        height: 36px !important;
        min-width: 36px !important;
        max-width: 36px !important;
    }
    
    .action-btn .material-icons {
        font-size: 16px !important;
    }
}

/* Add view-text class for hiding text labels */
.view-text {
    display: none;
}
</style>

<script>
// Function to show user details in modal
function showUserDetail(userId) {
    console.log('Loading user details for ID:', userId);
    
    const modalContent = document.getElementById('modal-user-detail-content');
    modalContent.innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="mt-3">Loading details for User ID: ${userId}</div>
        </div>
    `;
    
    // Open the modal safely with MicroModal
    if (typeof MicroModal !== 'undefined') {
        console.log('Opening modal with MicroModal');
        MicroModal.show('modal-user-detail', {
            onShow: modal => console.log(`${modal.id} is shown`),
            onClose: modal => console.log(`${modal.id} is hidden`),
            disableScroll: true
        });
    } else {
        // Fallback if MicroModal isn't available
        console.warn('MicroModal not available, using fallback');
        const modal = document.getElementById('modal-user-detail');
        modal.classList.add('is-open');
        modal.setAttribute('aria-hidden', 'false');
    }
    
    // Add a timestamp to prevent caching
    const timestamp = new Date().getTime();
    const url = `/users/${userId}/modal/?t=${timestamp}`;
    
    console.log('Fetching URL:', url);
    
    fetch(url, {
        method: 'GET',
        headers: {
            'Cache-Control': 'no-cache',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': '{{ csrf_token }}'
        },
    })
    .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
            throw new Error(`Server returned ${response.status}: ${response.statusText}`);
        }
        return response.text();
    })
    .then(html => {
        console.log('Response received, length:', html.length);
        // Log a small snippet of the response for debugging
        console.log('Response preview:', html.substring(0, 200));
        
        // Check if the response contains the expected user ID
        if (html.includes(`User ID: ${userId}`)) {
            console.log('Response contains correct user ID');
        } else {
            console.warn('Response may contain incorrect user ID!');
        }
        
        modalContent.innerHTML = html;
    })
    .catch(error => {
        console.error('Error fetching user details:', error);
        modalContent.innerHTML = `
            <div class="alert alert-danger m-3">
                <span class="material-icons me-2">error_outline</span>
                <div>Error loading user details: ${error.message}</div>
                <div class="mt-2">Requested User ID: ${userId}</div>
            </div>
        `;
    });
}

// Function to toggle user status
function toggleUserStatus(userId, action) {
    // Use SweetAlert for confirmation instead of native confirm
    Swal.fire({
        title: 'Are you sure?',
        text: `Do you want to ${action} this user?`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, proceed'
    }).then((result) => {
        if (result.isConfirmed) {
            const button = event.target.closest('button');
            const originalHtml = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

            fetch(`/users/${userId}/toggle-status/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Use SweetAlert instead of showToast
                    Swal.fire({
                        icon: 'success',
                        title: 'Success',
                        text: data.message,
                        timer: 1500,
                        showConfirmButton: false
                    });
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    // Use SweetAlert for errors
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.error || 'Error updating user status'
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Use SweetAlert for errors
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to update user status. Please try again.'
                });
            })
            .finally(() => {
                button.disabled = false;
                button.innerHTML = originalHtml;
            });
        }
    });
}

// Initialize modal functionality when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // MicroModal is now initialized at the top of the file

    // Toggle vehicle details for desktop
    const toggleButtons = document.querySelectorAll('.btn-vehicle-toggle');
    toggleButtons.forEach(button => {
        button.addEventListener('click', function() {
            const userId = this.getAttribute('data-user-id');
            const vehiclesRow = document.getElementById(`vehicles-${userId}`);
            
            if (vehiclesRow.style.display === 'none') {
                vehiclesRow.style.display = 'table-row';
                this.classList.add('active');
            } else {
                vehiclesRow.style.display = 'none';
                this.classList.remove('active');
            }
        });
    });
    
    // Mobile vehicle toggle
    const mobileToggleButtons = document.querySelectorAll('.mobile-vehicle-toggle');
    mobileToggleButtons.forEach(button => {
        button.addEventListener('click', function() {
            const userId = this.getAttribute('data-user-id');
            const vehiclesContainer = document.getElementById(`mobile-vehicles-${userId}`);
            const toggleText = this.querySelector('.toggle-text');
            
            if (vehiclesContainer.style.display === 'none') {
                vehiclesContainer.style.display = 'block';
                this.classList.add('active');
                toggleText.textContent = 'Hide Vehicles';
            } else {
                vehiclesContainer.style.display = 'none';
                this.classList.remove('active');
                toggleText.textContent = 'Show Vehicles';
            }
        });
    });
    
    // Setup toggle status buttons (desktop and mobile)
    const statusButtons = document.querySelectorAll('.btn-danger.action-btn, .btn-success.action-btn, [data-action]');
    statusButtons.forEach(button => {
        button.addEventListener('click', function() {
            const userId = this.getAttribute('data-user-id');
            const action = this.getAttribute('data-action');
            if (userId && action) {
                toggleUserStatus(userId, action);
            }
        });
    });

    // Setup view buttons (desktop and mobile)
    const viewButtons = document.querySelectorAll('.btn-primary.action-btn, [data-micromodal-trigger="modal-user-detail"]');
    viewButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            // Get userId from the button's data attribute
            const userId = this.getAttribute('data-user-id');
            console.log('View button clicked for user ID:', userId);
            
            // Pre-load user details right away
            showUserDetail(userId);
        });
    });

    // Remove the data-bs-toggle and data-bs-target attributes to prevent automatic modal triggering
    viewButtons.forEach(button => {
        button.removeAttribute('data-micromodal-trigger');
    });

    // Setup registration view buttons (desktop and mobile)
    const registrationButtons = document.querySelectorAll('.btn-view-registration, [data-micromodal-trigger="modal-registration"]');
    registrationButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Get data attributes
            const plateNumber = this.getAttribute('data-plate');
            const orNumber = this.getAttribute('data-or');
            const crNumber = this.getAttribute('data-cr');
            const vehicleType = this.getAttribute('data-type');
            const make = this.getAttribute('data-make');
            const model = this.getAttribute('data-model');
            const year = this.getAttribute('data-year');
            const color = this.getAttribute('data-color');
            const classification = this.getAttribute('data-classification');
            const registrationDate = this.getAttribute('data-registration');
            const expiryDate = this.getAttribute('data-expiry');
            const imageUrl = this.getAttribute('data-image');
            
            // Set modal content
            document.getElementById('registration-plate').textContent = `Plate Number: ${plateNumber}`;
            document.getElementById('registration-or').textContent = orNumber;
            document.getElementById('registration-cr').textContent = crNumber;
            document.getElementById('registration-date').textContent = registrationDate;
            document.getElementById('registration-expiry').textContent = expiryDate;
            document.getElementById('vehicle-classification').textContent = classification;
            document.getElementById('vehicle-type').textContent = vehicleType;
            document.getElementById('vehicle-make').textContent = make;
            document.getElementById('vehicle-model').textContent = model;
            document.getElementById('vehicle-year').textContent = year;
            document.getElementById('vehicle-color').textContent = color;
            document.getElementById('registration-image').src = imageUrl;
            
            // Open the modal safely with MicroModal
            if (typeof MicroModal !== 'undefined') {
                console.log('Opening registration modal with MicroModal');
                MicroModal.show('modal-registration', {
                    onShow: modal => console.log(`${modal.id} is shown`),
                    onClose: modal => console.log(`${modal.id} is hidden`),
                    disableScroll: true
                });
            } else {
                // Fallback if MicroModal isn't available
                console.warn('MicroModal not available, using fallback for registration modal');
                const modal = document.getElementById('modal-registration');
                modal.classList.add('is-open');
                modal.setAttribute('aria-hidden', 'false');
            }
        });
    });
    
    // Add manual close functionality for all modals
    const closeModalButtons = document.querySelectorAll('[data-micromodal-close]');
    closeModalButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const modalId = this.closest('.modal').id;
            console.log(`Closing modal with ID: ${modalId}`);
            
            if (typeof MicroModal !== 'undefined') {
                MicroModal.close(modalId);
            } else {
                const modal = document.getElementById(modalId);
                modal.classList.remove('is-open');
                modal.setAttribute('aria-hidden', 'true');
            }
        });
    });

    // Ensure table layout remains consistent
    const tableContainer = document.querySelector('.table-responsive');
    if (tableContainer) {
        const resizeObserver = new ResizeObserver(entries => {
            for (let entry of entries) {
                const table = entry.target.querySelector('.table');
                if (table) {
                    table.style.width = `${entry.contentRect.width}px`;
                }
            }
        });
        resizeObserver.observe(tableContainer);
    }
});

// Make toggleUserStatus available globally
window.toggleUserStatus = toggleUserStatus;
</script>
{% endblock %} 