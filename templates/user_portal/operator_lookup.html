{% extends 'user_portal/base_user.html' %}
{% load static %}

{% block title %}Operator Lookup - CTTMO Portal{% endblock %}

{% block extra_css %}
<style>
    /* Enhanced styles for operator lookup */
    .search-container {
        background-color: #f8f9fa;
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.05);
        margin: 1.5rem 0;
    }
    
    .search-header {
        margin-bottom: 1.5rem;
    }
    
    .search-title {
        font-size: 1.75rem;
        font-weight: 600;
        color: var(--primary-color);
        margin-bottom: 0.5rem;
    }
    
    .search-description {
        color: var(--text-light);
        font-size: 1rem;
        max-width: 600px;
    }
    
    .search-form {
        position: relative;
    }
    
    .search-input {
        border-radius: 0 8px 8px 0;
        height: 3.5rem;
        font-size: 1.1rem;
        transition: all 0.3s ease;
    }
    
    .search-input:focus {
        border-color: var(--secondary-color);
        box-shadow: 0 0 0 0.25rem rgba(74, 144, 226, 0.25);
    }
    
    .input-group-text {
        border-radius: 8px 0 0 8px;
        padding-left: 1.25rem;
        padding-right: 1.25rem;
    }
    
    .input-group-text .material-icons {
        color: var(--text-light);
        font-size: 1.5rem;
    }
    
    .search-button {
        height: 3.5rem;
        min-width: 120px;
        font-weight: 600;
        border-radius: 8px;
        margin-left: 10px;
        transition: all 0.3s ease;
    }
    
    .search-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    /* Result cards styling */
    .result-card {
        border-radius: 0.75rem;
        border: none;
        box-shadow: 0 0.25rem 0.5rem rgba(0,0,0,0.05);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        margin-bottom: 1.25rem;
        overflow: hidden;
    }
    
    .result-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.1);
    }
    
    .card-title {
        font-weight: 600;
        margin-bottom: 0.75rem;
    }
    
    /* Status badges */
    .status-badge {
        padding: 0.5rem 1rem;
        border-radius: 2rem;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .status-badge.good {
        background-color: rgba(25, 135, 84, 0.1);
        color: #198754;
        border: 1px solid rgba(25, 135, 84, 0.2);
    }
    
    .status-badge.warning {
        background-color: rgba(255, 193, 7, 0.1);
        color: #ffc107;
        border: 1px solid rgba(255, 193, 7, 0.2);
    }
    
    .status-badge.danger {
        background-color: rgba(220, 53, 69, 0.1);
        color: #dc3545;
        border: 1px solid rgba(220, 53, 69, 0.2);
    }
    
    /* Detail button */
    .detail-button {
        border-radius: 0.5rem;
        font-weight: 500;
        padding: 0.5rem 1rem;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.3s ease;
    }
    
    .detail-button:hover {
        background-color: var(--primary-color);
        color: white;
    }
    
    /* Recent lookups table */
    .lookups-table {
        border-collapse: separate;
        border-spacing: 0;
    }
    
    .lookups-table th {
        background-color: #f8f9fa;
        font-weight: 600;
        padding: 1rem;
        border-bottom: 2px solid #dee2e6;
    }
    
    .lookups-table td {
        padding: 1rem;
        vertical-align: middle;
    }
    
    .lookups-table tbody tr {
        transition: background-color 0.3s ease;
    }
    
    .lookups-table tbody tr:hover {
        background-color: rgba(74, 144, 226, 0.05);
    }
    
    /* Loading animation */
    .spinner-grow {
        animation-duration: 1s;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
    
    .loading-text {
        animation: pulse 1.5s infinite;
    }
    
    /* Modal enhancements */
    .detail-modal .modal-content {
        border-radius: 1rem;
        border: none;
        overflow: hidden;
    }
    
    .detail-modal .modal-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        padding: 1.25rem 1.5rem;
    }
    
    .detail-modal .modal-body {
        padding: 1.5rem;
    }
    
    .detail-modal .modal-footer {
        border-top: 1px solid #dee2e6;
        padding: 1rem 1.5rem;
    }
    
    .status-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
    }
    
    .info-list {
        border-radius: 0.5rem;
        overflow: hidden;
    }
    
    .info-list .list-group-item {
        padding: 1rem 1.25rem;
        border-color: #e9ecef;
    }
    
    .recommendation-alert {
        border-radius: 0.5rem;
        margin-top: 1.5rem;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .search-input {
            height: 3.2rem;
        }
        
        .search-button {
            height: 3.2rem;
            min-width: 100px;
        }
        
        .input-group {
            flex-direction: column;
        }
        
        .input-group > .form-control, 
        .input-group-text,
        .search-button {
            border-radius: 8px;
            margin: 0 0 10px 0;
        }
        
        .status-badge {
            padding: 0.4rem 0.75rem;
        }
    }
    
    .search-container {
        margin-bottom: 2rem;
    }
    
    .form-text {
        color: var(--text-light);
        margin-top: 0.75rem;
        font-size: 0.95rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-md-12">
            <div class="card shadow-sm">
                <div class="card-body p-4">
                    <div class="search-header">
                        <h2 class="search-title">Operator Lookup</h2>
                        <p class="search-description">Search for operators to check their violation history before leasing your vehicle to them.</p>
                    </div>
                    
                    <div class="search-container">
                        <div class="search-form">
                            <div class="input-group">
                                <span class="input-group-text bg-white border-end-0">
                                    <span class="material-icons">search</span>
                                </span>
                                <input type="text" class="form-control border-start-0 search-input" id="operatorSearchInput" 
                                       placeholder="Enter operator name, license number, or ID" 
                                       value="{{ search_query }}"
                                       aria-label="Search for operators">
                                <button class="btn btn-primary search-button" type="button" id="searchButton">
                                    Search
                                </button>
                            </div>
                            <div class="form-text mt-2">Search by name, license number, or operator ID to verify an operator's record</div>
                        </div>
                    </div>
                    
                    <div id="searchResults" class="mt-4 d-none">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h3 class="m-0">Search Results</h3>
                            <span class="badge bg-primary rounded-pill result-count"></span>
                        </div>
                        <div class="results-container" id="resultsContainer">
                            <!-- Results will be populated here by JavaScript -->
                        </div>
                    </div>
                    
                    <div id="noResults" class="mt-4 text-center d-none">
                        <div class="py-5">
                            <span class="material-icons d-block mb-3" style="font-size: 64px; color: #6c757d;">search_off</span>
                            <h4 class="mb-3">No operators found</h4>
                            <p class="text-muted mb-4">We couldn't find any operators matching your search criteria.</p>
                            <p>Try searching with a different name, license number, or operator ID.</p>
                        </div>
                    </div>
                    
                    <div id="loadingIndicator" class="text-center my-5 py-5 d-none">
                        <div class="spinner-grow text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="loading-text mb-0 fs-5">Searching operators database...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    {% if recent_lookups %}
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card shadow-sm">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3 class="card-title m-0">Recent Lookups</h3>
                        <a href="{% url 'user_portal:operator_lookup_history' %}" class="btn btn-outline-primary">
                            <span class="material-icons" style="font-size: 18px; vertical-align: text-bottom;">history</span>
                            View All History
                        </a>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table lookups-table">
                            <thead>
                                <tr>
                                    <th>Operator Name</th>
                                    <th>License Number</th>
                                    <th>Lookup Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for lookup in recent_lookups %}
                                <tr>
                                    <td class="fw-medium">{{ lookup.operator_name }}</td>
                                    <td>{% if lookup.operator_license %}{{ lookup.operator_license }}{% else %}<span class="text-muted fst-italic">Not available</span>{% endif %}</td>
                                    <td>{{ lookup.lookup_date|date:"M d, Y h:i A" }}</td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-outline-primary repeat-search" 
                                                data-search="{{ lookup.operator_name }}">
                                            <span class="material-icons" style="font-size: 16px; vertical-align: text-bottom;">refresh</span> 
                                            Search Again
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Operator Detail Modal -->
<div class="modal fade detail-modal" id="operatorDetailModal" tabindex="-1" aria-labelledby="operatorDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="operatorDetailModalLabel">Operator Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="operatorDetailContent">
                <!-- Will be populated with details -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('operatorSearchInput');
        const searchButton = document.getElementById('searchButton');
        const resultsContainer = document.getElementById('resultsContainer');
        const searchResults = document.getElementById('searchResults');
        const noResults = document.getElementById('noResults');
        const loadingIndicator = document.getElementById('loadingIndicator');
        
        // Function to perform the search
        function performSearch() {
            const searchTerm = searchInput.value.trim();
            if (!searchTerm) {
                // Provide immediate feedback if search term is empty
                searchInput.classList.add('is-invalid');
                setTimeout(() => searchInput.classList.remove('is-invalid'), 1500);
                return;
            }
            
            // Show loading indicator with animation
            loadingIndicator.classList.remove('d-none');
            searchResults.classList.add('d-none');
            noResults.classList.add('d-none');
            
            // Scroll to loading indicator
            loadingIndicator.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Make API request
            fetch(`{% url 'user_portal:operator_lookup_search' %}?q=${encodeURIComponent(searchTerm)}`)
                .then(response => response.json())
                .then(data => {
                    // Add slight delay for better UX - gives user time to perceive the loading state
                    setTimeout(() => {
                        // Hide loading indicator
                        loadingIndicator.classList.add('d-none');
                        
                        if (data.status === 'success' && data.operators && data.operators.length > 0) {
                            // Show results
                            displayResults(data.operators);
                            searchResults.classList.remove('d-none');
                            
                            // Update result count badge
                            const resultCountBadge = searchResults.querySelector('.result-count');
                            resultCountBadge.textContent = `${data.operators.length} result${data.operators.length > 1 ? 's' : ''}`;
                            
                            // Scroll to results
                            searchResults.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        } else {
                            // Show no results message
                            noResults.classList.remove('d-none');
                            
                            // Scroll to no results
                            noResults.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }, 600);
                })
                .catch(error => {
                    console.error('Error:', error);
                    // Hide loading indicator after a slight delay
                    setTimeout(() => {
                        loadingIndicator.classList.add('d-none');
                        noResults.classList.remove('d-none');
                        noResults.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 600);
                });
        }
        
        // Function to display search results
        function displayResults(operators) {
            resultsContainer.innerHTML = '';
            
            operators.forEach(operator => {
                const statusClass = operator.status === 'good' ? 'good' : 
                                   operator.status === 'warning' ? 'warning' : 'danger';
                const statusText = operator.status === 'good' ? 'Clean Record' : 
                                  operator.status === 'warning' ? 'Minor Violations' : 'Multiple Violations';
                const statusIcon = operator.status === 'good' ? 'check_circle' : 
                                  operator.status === 'warning' ? 'warning' : 'error';
                
                // Create result card with enhanced design
                const card = document.createElement('div');
                card.className = 'card result-card';
                
                // Add a subtle colored border based on status
                if (operator.status === 'good') {
                    card.style.borderLeft = '4px solid #198754';
                } else if (operator.status === 'warning') {
                    card.style.borderLeft = '4px solid #ffc107';
                } else {
                    card.style.borderLeft = '4px solid #dc3545';
                }
                
                card.innerHTML = `
                    <div class="card-body p-4">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h5 class="card-title fs-4">${operator.name}</h5>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <p class="card-text mb-2">
                                            <strong>License Number:</strong><br>
                                            <span class="text-dark">${operator.license_number ? operator.license_number : '<span class="text-muted fst-italic">Not available</span>'}</span>
                                        </p>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="card-text mb-2">
                                            <strong>Violations:</strong><br>
                                            <span class="text-dark">${operator.violation_count}</span>
                                        </p>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <p class="card-text mb-2">
                                            <strong>New PD Number:</strong><br>
                                            <span class="text-dark">${operator.pd_number ? operator.pd_number : '<span class="text-muted fst-italic">Not available</span>'}</span>
                                        </p>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="card-text mb-2">
                                            <strong>Old PD Number:</strong><br>
                                            <span class="text-dark">${operator.old_pd_number ? operator.old_pd_number : '<span class="text-muted fst-italic">Not available</span>'}</span>
                                        </p>
                                    </div>
                                </div>
                                
                                ${operator.violation_types && operator.violation_types.length > 0 ? `
                                <p class="card-text mb-2">
                                    <strong>Recent Violation Types:</strong><br>
                                    <span class="text-dark">${operator.violation_types.slice(0, 3).join(', ')}${operator.violation_types.length > 3 ? '...' : ''}</span>
                                </p>` : ''}
                                
                                ${operator.has_recent_violations ? `
                                <p class="card-text text-danger mt-3 d-flex align-items-center">
                                    <span class="material-icons me-2" style="font-size: 18px;">warning</span>
                                    Has recent violations (within 90 days)
                                </p>` : ''}
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="mb-3">
                                    <span class="status-badge ${statusClass}">
                                        <span class="material-icons" style="font-size: 18px;">${statusIcon}</span>
                                        ${statusText}
                                    </span>
                                </div>
                                <button class="btn btn-outline-primary detail-button view-details" data-operator='${JSON.stringify(operator)}'>
                                    <span class="material-icons">visibility</span> View Details
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                resultsContainer.appendChild(card);
            });
            
            // Add event listeners to view details buttons
            document.querySelectorAll('.view-details').forEach(button => {
                button.addEventListener('click', function() {
                    const operatorData = JSON.parse(this.getAttribute('data-operator'));
                    showOperatorDetails(operatorData);
                });
            });
        }
        
        // Function to show operator details in modal
        function showOperatorDetails(operator) {
            const modalTitle = document.getElementById('operatorDetailModalLabel');
            const modalContent = document.getElementById('operatorDetailContent');
            
            modalTitle.textContent = `${operator.name}`;
            
            const statusClass = operator.status === 'good' ? 'success' : 
                               operator.status === 'warning' ? 'warning' : 'danger';
            const statusText = operator.status === 'good' ? 'Clean Record' : 
                              operator.status === 'warning' ? 'Minor Violations' : 'Major Violations';
            const statusIcon = operator.status === 'good' ? 'check_circle' : 
                              operator.status === 'warning' ? 'warning' : 'error';
            
            modalContent.innerHTML = `
                <div class="text-center mb-4">
                    <span class="material-icons status-icon text-${statusClass}">${statusIcon}</span>
                    <h3 class="text-${statusClass} fw-bold">${statusText}</h3>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <h5 class="fw-bold mb-3">Operator Information</h5>
                        <ul class="list-group info-list mb-4">
                            <li class="list-group-item d-flex justify-content-between">
                                <span class="text-muted">Name:</span>
                                <strong>${operator.name}</strong>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span class="text-muted">License Number:</span>
                                <strong>${operator.license_number ? operator.license_number : '<span class="text-muted fst-italic">Not available</span>'}</strong>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span class="text-muted">New PD Number:</span>
                                <strong>${operator.pd_number ? operator.pd_number : '<span class="text-muted fst-italic">Not available</span>'}</strong>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span class="text-muted">Old PD Number:</span>
                                <strong>${operator.old_pd_number ? operator.old_pd_number : '<span class="text-muted fst-italic">Not available</span>'}</strong>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="col-md-6">
                        <h5 class="fw-bold mb-3">Violation Summary</h5>
                        <ul class="list-group info-list mb-4">
                            <li class="list-group-item d-flex justify-content-between">
                                <span class="text-muted">Total Violations:</span>
                                <strong>${operator.violation_count}</strong>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span class="text-muted">Recent Violations:</span>
                                <strong class="${operator.has_recent_violations ? 'text-danger' : ''}">${operator.has_recent_violations ? 'Yes (within 90 days)' : 'None'}</strong>
                            </li>
                        </ul>
                    </div>
                </div>
                
                ${operator.violation_types && operator.violation_types.length > 0 ? `
                <div class="row">
                    <div class="col-md-12">
                        <h5 class="fw-bold mb-3">Violation Types</h5>
                        <ul class="list-group info-list mb-4">
                            ${operator.violation_types.map(type => `
                                <li class="list-group-item">${type}</li>
                            `).join('')}
                        </ul>
                    </div>
                </div>
                ` : ''}
                
                <div class="alert alert-${statusClass} recommendation-alert">
                    <div class="d-flex">
                        <div class="me-3">
                            <span class="material-icons fs-3">${
                                operator.status === 'good' ? 'thumb_up' : 
                                operator.status === 'warning' ? 'thumbs_up_down' : 'thumb_down'
                            }</span>
                        </div>
                        <div>
                            <h5 class="alert-heading mb-2">Leasing Recommendation</h5>
                            <p class="mb-0">${
                                operator.status === 'good' 
                                    ? 'This operator has a clean record and appears to be a low-risk lessee. They have no recorded traffic violations.'
                                    : operator.status === 'warning'
                                    ? 'This operator has some minor violations. Consider additional screening or a shorter lease term to mitigate potential risks.'
                                    : 'This operator has multiple violations. Leasing to this operator carries significant risk based on their violation history.'
                            }</p>
                        </div>
                    </div>
                </div>
            `;
            
            // Show the modal with fade effect
            const modal = new bootstrap.Modal(document.getElementById('operatorDetailModal'));
            modal.show();
        }
        
        // Event listeners
        searchButton.addEventListener('click', performSearch);
        
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });
        
        // Remove invalid class when typing
        searchInput.addEventListener('input', function() {
            this.classList.remove('is-invalid');
        });
        
        // Event listeners for "Search Again" buttons in recent lookups
        document.querySelectorAll('.repeat-search').forEach(button => {
            button.addEventListener('click', function() {
                const searchTerm = this.getAttribute('data-search');
                searchInput.value = searchTerm;
                
                // Scroll to search input
                searchInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Focus the input and highlight it briefly to draw attention
                searchInput.focus();
                searchInput.classList.add('border-primary');
                setTimeout(() => {
                    searchInput.classList.remove('border-primary');
                    performSearch();
                }, 500);
            });
        });
        
        // Auto-search if there's a search term in the input field (from URL)
        if (searchInput.value.trim()) {
            // Slight delay to ensure DOM is fully loaded
            setTimeout(performSearch, 300);
        }
    });
</script>
{% endblock %} 