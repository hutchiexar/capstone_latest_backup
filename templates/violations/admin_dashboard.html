{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid dashboard-container p-3 p-md-4">
    <header class="dashboard-header mb-4">
        <h2 class="text-primary fw-bold">Administrative Dashboard</h2>
        <p class="text-muted">Overview of violations and adjudication analytics</p>
    </header>

    <!-- Main Grid Layout Container -->
    <div class="dashboard-grid">
        <!-- Summary Cards Row -->
        <div class="summary-stats">
            <!-- Violations Card -->
            <div class="stat-card">
                <div class="card-body">
                    <div class="icon-area">
                                    <span class="material-icons">gavel</span>
                                </div>
                    <div class="stat-content">
                        <h6>TOTAL VIOLATIONS</h6>
                        <h2>{{ total_violations }}</h2>
                        <div class="trend">
                                <span class="material-icons trend-up">trending_up</span>
                                <span>{{ weekly_violations }} this week</span>
                            </div>
                        </div>
                    </div>
                </div>

        <!-- Revenue Card -->
            <div class="stat-card">
                <div class="card-body">
                    <div class="icon-area">
                                    <span class="material-icons">payments</span>
                                </div>
                    <div class="stat-content">
                        <h6>TOTAL REVENUE</h6>
                        <h2>₱{{ total_revenue|floatformat:2 }}</h2>
                        <div class="trend">
                                <span class="material-icons trend-up">trending_up</span>
                                <span>₱{{ weekly_revenue|floatformat:2 }} this week</span>
                            </div>
                </div>
            </div>
        </div>

        <!-- Pending Violations Card -->
            <div class="stat-card">
                <div class="card-body">
                    <div class="icon-area warning-icon">
                                    <span class="material-icons">pending_actions</span>
                </div>
                    <div class="stat-content">
                        <h6>PENDING CASES</h6>
                        <h2>{{ pending_violations }}</h2>
                        <div class="trend">
                                <span class="material-icons warning">warning</span>
                                <span>Requires attention</span>
                            </div>
                        </div>
                    </div>
                </div>

            <!-- Overdue Violations Card -->
            <div class="stat-card">
                <div class="card-body">
                    <div class="icon-area error-icon">
                        <span class="material-icons">report_problem</span>
                    </div>
                        <div class="stat-content">
                        <h6>OVERDUE CASES</h6>
                        <h2>{{ overdue_violations }}</h2>
                        <div class="trend">
                            <span class="material-icons error">error</span>
                            <span>Past due date</span>
                                </div>
                            </div>
                            </div>
                        </div>
                    </div>

        <!-- Main Charts Area -->
        <div class="main-charts">
            <!-- Violations Chart -->
            <div class="card chart-card violations-chart">
                <div class="card-header">
                    <h5>Violations Overview</h5>
                    <div class="btn-group chart-controls">
                        <button type="button" class="btn btn-sm btn-outline-secondary" data-range="week">Week</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary active" data-range="month">Month</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" data-range="year">Year</button>
                </div>
                </div>
                <div class="card-body">
                    <canvas id="violationsChart"></canvas>
            </div>
        </div>

            <!-- Status Distribution Chart -->
            <div class="card chart-card status-chart">
                <div class="card-header">
                    <h5>Status Distribution</h5>
                </div>
                <div class="card-body">
                    <canvas id="statusDistributionChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Adjudication Analytics Container -->
        <div class="adjudication-container">
            <!-- Adjudication Summary Cards -->
            <h4 class="section-title">Adjudication Analytics</h4>
            <div class="adjudication-stats">
                <!-- Total Adjudicated Card -->
                <div class="stat-card">
                    <div class="card-body">
                        <div class="icon-area">
                            <span class="material-icons">balance</span>
                        </div>
                        <div class="stat-content">
                            <h6>TOTAL ADJUDICATED</h6>
                            <h2>{{ adjudication_summary.total_adjudications }}</h2>
                            <div class="trend">
                                <span class="material-icons trend-up">trending_up</span>
                                <span>{{ adjudication_summary.weekly_adjudications }} this week</span>
                                </div>
                            </div>
                            </div>
                        </div>

                <!-- Approved Card -->
                <div class="stat-card">
                    <div class="card-body">
                        <div class="icon-area">
                            <span class="material-icons">verified</span>
                    </div>
                        <div class="stat-content">
                            <h6>APPROVED</h6>
                            <h2>{{ adjudication_summary.approved_count }}</h2>
                            <div class="trend">
                                <span class="material-icons trend-up">check_circle</span>
                                <span>{{ adjudication_summary.approval_rate }}% approval</span>
                </div>
                </div>
            </div>
        </div>

                <!-- Rejected Card -->
                <div class="stat-card">
                    <div class="card-body">
                        <div class="icon-area error-icon">
                            <span class="material-icons">cancel</span>
                </div>
                        <div class="stat-content">
                            <h6>REJECTED</h6>
                            <h2>{{ adjudication_summary.rejected_count }}</h2>
                            <div class="trend">
                                <span class="material-icons error">error</span>
                                <span>Needs review</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pending Approval Card -->
                <div class="stat-card">
                <div class="card-body">
                        <div class="icon-area warning-icon">
                            <span class="material-icons">pending_actions</span>
                        </div>
                        <div class="stat-content">
                            <h6>PENDING APPROVAL</h6>
                            <h2>{{ adjudication_summary.pending_count }}</h2>
                            <div class="trend">
                                <span class="material-icons warning">warning</span>
                                <span>Awaiting approval</span>
                                </div>
                            </div>
                            </div>
                        </div>
                    </div>

            <!-- Adjudication Charts Area -->
            <div class="adjudication-charts">
                <!-- Adjudication Trend Chart -->
                <div class="card chart-card adj-trend-chart">
                    <div class="card-header">
                        <h5>Adjudication Trend</h5>
                        <div class="btn-group chart-controls">
                            <button type="button" class="btn btn-sm btn-outline-secondary" data-adj-range="week">Week</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary active" data-adj-range="month">Month</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" data-adj-range="year">Year</button>
                </div>
                </div>
                    <div class="card-body">
                        <canvas id="adjudicationTrendChart"></canvas>
                    </div>
                </div>

                <!-- Violation Types Chart -->
                <div class="card chart-card violation-types-chart">
                    <div class="card-header">
                        <h5>Most Adjudicated Violations</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="violationTypesChart"></canvas>
                    </div>
            </div>
        </div>
    </div>

        <!-- Performance Section Layout -->
        <div class="performance-section">
            <!-- Monthly Volume Chart -->
            <div class="card chart-card monthly-volume-chart">
                <div class="card-header">
                    <h5>Monthly Adjudication Volume</h5>
                    </div>
                <div class="card-body">
                    <canvas id="monthlyAdjudicationChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Educational Analytics Section -->
        <h4 class="section-title">Educational Analytics</h4>
        <div class="educational-stats">
            <!-- Total Categories Card -->
            <div class="stat-card">
                <div class="card-body">
                    <div class="icon-area education-icon">
                        <span class="material-icons">category</span>
                    </div>
                    <div class="stat-content">
                        <h6>TOTAL CATEGORIES</h6>
                        <h2 id="total-categories">0</h2>
                        <div class="trend">
                            <span class="material-icons trend-up">show_chart</span>
                            <span id="new-categories">0 new this month</span>
                    </div>
                </div>
            </div>
        </div>

            <!-- Total Topics Card -->
            <div class="stat-card">
                <div class="card-body">
                    <div class="icon-area education-icon">
                        <span class="material-icons">menu_book</span>
                    </div>
                    <div class="stat-content">
                        <h6>TOTAL TOPICS</h6>
                        <h2 id="total-topics">0</h2>
                        <div class="trend">
                            <span class="material-icons trend-up">show_chart</span>
                            <span id="new-topics">0 new this month</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Published Topics Card -->
            <div class="stat-card">
                <div class="card-body">
                    <div class="icon-area education-icon">
                        <span class="material-icons">publish</span>
                    </div>
                    <div class="stat-content">
                        <h6>PUBLISHED TOPICS</h6>
                        <h2 id="published-topics">0</h2>
                        <div class="trend">
                            <span class="material-icons trend-up">trending_up</span>
                            <span id="published-rate">0% of total</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Completion Rate Card -->
            <div class="stat-card">
                <div class="card-body">
                    <div class="icon-area education-icon">
                        <span class="material-icons">grading</span>
                    </div>
                    <div class="stat-content">
                        <h6>AVERAGE PASS RATE</h6>
                        <h2 id="pass-rate">0%</h2>
                        <div class="trend">
                            <span class="material-icons trend-up">trending_up</span>
                            <span id="completion-rate">0% completion rate</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Educational Charts Area -->
        <div class="educational-charts">
            <!-- Topics by Category Chart -->
            <div class="card chart-card category-chart">
                <div class="card-header">
                    <h5>Topics by Category</h5>
                </div>
                <div class="card-body">
                    <canvas id="categoryTopicsChart"></canvas>
                    </div>
                    </div>

            <!-- Passing & Failure Rates Chart -->
            <div class="card chart-card pass-fail-chart">
                <div class="card-header">
                    <h5>Passing & Failure Rates</h5>
                    <div class="btn-group chart-controls">
                        <button type="button" class="btn btn-sm btn-outline-secondary" data-edu-range="week">Week</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary active" data-edu-range="month">Month</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" data-edu-range="year">Year</button>
                    </div>
                </div>
                <div class="card-body">
                    <canvas id="passFailRateChart"></canvas>
                </div>
            </div>
        </div>
    </div>

        <!-- Recent Violations Card -->
        <div class="recent-violations">
            <div class="card">
                <div class="card-header bg-transparent py-3">
                    <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <span class="material-icons text-primary me-2">receipt_long</span>
                <h5 class="mb-0">Recent Violations</h5>
            </div>
            <a href="{% url 'violations_list' %}" class="btn btn-primary btn-sm d-flex align-items-center gap-2">
                <span class="material-icons">visibility</span>
                <span class="d-none d-sm-inline">View All</span>
            </a>
        </div>
            </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Violation</th>
                                    <th class="d-none d-md-table-cell">Location</th>
                            <th>Status</th>
                                    <th class="d-none d-sm-table-cell">Amount</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for violation in recent_violations %}
                        <tr>
                            <td>{{ violation.violation_date|date:"M d, Y" }}</td>
                            <td>{{ violation.violation_type }}</td>
                                    <td class="d-none d-md-table-cell">{{ violation.location }}</td>
                            <td>
                                <span class="badge rounded-pill {% if violation.status == 'PAID' %}text-bg-success
                                           {% elif violation.status == 'PENDING' %}text-bg-warning
                                           {% elif violation.status == 'SETTLED' %}text-bg-info
                                           {% else %}text-bg-danger{% endif %}">
                                    {{ violation.status }}
                                </span>
                            </td>
                                    <td class="d-none d-sm-table-cell">₱{{ violation.fine_amount }}</td>
                            <td>
                                <div class="action-buttons d-flex gap-2">
                                    <button type="button" class="btn btn-primary action-btn" 
                                            data-violation-id="{{ violation.id }}"
                                            title="View Details">
                                        <span class="material-icons">visibility</span>
                                    </button>
                                    {% if violation.status == 'PENDING' %}
                                    <button type="button" class="btn btn-warning action-btn" 
                                            data-violation-id="{{ violation.id }}"
                                            title="Process Violation">
                                        <span class="material-icons">task_alt</span>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                
                <!-- Pagination -->
                {% if is_paginated %}
                <div class="pagination-container py-3">
                    <nav aria-label="Violations pagination">
                        <ul class="pagination justify-content-center mb-0">
                            {% if recent_violations.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page=1" aria-label="First">
                                        <span aria-hidden="true">&laquo;&laquo;</span>
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ recent_violations.previous_page_number }}" aria-label="Previous">
                                        <span aria-hidden="true">&laquo;</span>
                                    </a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <a class="page-link" href="#" aria-label="First">
                                        <span aria-hidden="true">&laquo;&laquo;</span>
                                    </a>
                                </li>
                                <li class="page-item disabled">
                                    <a class="page-link" href="#" aria-label="Previous">
                                        <span aria-hidden="true">&laquo;</span>
                                    </a>
                                </li>
                            {% endif %}
                            
                            {% for i in recent_violations.paginator.page_range %}
                                {% if recent_violations.number == i %}
                                    <li class="page-item active">
                                        <a class="page-link" href="#">{{ i }}</a>
                                    </li>
                                {% elif i > recent_violations.number|add:'-3' and i < recent_violations.number|add:'3' %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ i }}">{{ i }}</a>
                                    </li>
                                {% endif %}
                            {% endfor %}
                            
                            {% if recent_violations.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ recent_violations.next_page_number }}" aria-label="Next">
                                        <span aria-hidden="true">&raquo;</span>
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ recent_violations.paginator.num_pages }}" aria-label="Last">
                                        <span aria-hidden="true">&raquo;&raquo;</span>
                                    </a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <a class="page-link" href="#" aria-label="Next">
                                        <span aria-hidden="true">&raquo;</span>
                                    </a>
                                </li>
                                <li class="page-item disabled">
                                    <a class="page-link" href="#" aria-label="Last">
                                        <span aria-hidden="true">&raquo;&raquo;</span>
                                    </a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
                {% endif %}
                
            </div>
                            </div>
                        </div>
        </div>
    </div>
</div>

<style>
    /* Color Palette - Dashboard Design System */
    :root {
        /* Primary colors */
        --dashboard-primary: #2563eb;
        --dashboard-primary-light: rgba(37, 99, 235, 0.1);
        --dashboard-primary-hover: #1d4ed8;
        
        /* Secondary colors */
        --dashboard-secondary: #8950fc;
        --dashboard-secondary-light: rgba(137, 80, 252, 0.1);
        
        /* Semantic colors */
        --dashboard-success: #22c55e;
        --dashboard-success-light: rgba(34, 197, 94, 0.1);
        --dashboard-warning: #eab308;
        --dashboard-warning-light: rgba(234, 179, 8, 0.1);
        --dashboard-danger: #ef4444;
        --dashboard-danger-light: rgba(239, 68, 68, 0.1);
        --dashboard-info: #0ea5e9;
        --dashboard-info-light: rgba(14, 165, 233, 0.1);
        
        /* Neutral colors */
        --dashboard-bg: #f8fafc;
        --dashboard-card-bg: #ffffff;
        --dashboard-border: rgba(0, 0, 0, 0.05);
        --dashboard-text-dark: #1e293b;
        --dashboard-text-medium: #64748b;
        --dashboard-text-light: #94a3b8;
    }

    /* Dashboard Container */
    .dashboard-container {
        background-color: var(--dashboard-bg);
        border-radius: 12px;
    }
    
    /* Dashboard Header */
    .dashboard-header h2 {
        font-size: 1.75rem;
        letter-spacing: -0.5px;
        color: var(--dashboard-text-dark);
    }
    
    .dashboard-header p {
        color: var(--dashboard-text-medium);
    }

    /* Dashboard Grid Layout */
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        grid-auto-rows: auto;
        gap: 1.25rem;
    }

    /* Section Title */
    .section-title {
        grid-column: span 12;
        margin-top: 1.5rem;
        margin-bottom: 0.75rem;
        color: var(--dashboard-primary);
        font-weight: 600;
        font-size: 1.25rem;
        padding-left: 0.5rem;
        border-left: 4px solid var(--dashboard-primary);
        display: flex;
        align-items: center;
    }
    
    .section-title::before {
        content: "";
        display: inline-block;
        width: 4px;
        height: 24px;
        background-color: var(--dashboard-primary);
        margin-right: 0.5rem;
        border-radius: 2px;
        display: none; /* Hidden as we're using border-left instead */
    }

    /* Summary Stats - 4 cards in a row */
    .summary-stats {
        grid-column: span 12;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.25rem;
    }

    /* Main Charts - Responsive layout */
    .main-charts {
        grid-column: span 12;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(min(100%, 500px), 1fr));
        gap: 1.25rem;
    }

    /* Adjudication Stats - 4 cards in a row */
    .adjudication-stats {
        grid-column: span 12;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.25rem;
    }

    /* Adjudication Charts - Responsive layout */
    .adjudication-charts {
        grid-column: span 12;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(min(100%, 500px), 1fr));
        gap: 1.25rem;
    }

    /* Performance Section - Responsive layout */
    .performance-section {
        grid-column: span 12;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(min(100%, 350px), 1fr));
        gap: 1.25rem;
    }

    /* Educational Stats - 4 cards in a row */
    .educational-stats {
        grid-column: span 12;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.25rem;
    }

    /* Educational Charts - Responsive layout */
    .educational-charts {
        grid-column: span 12;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(min(100%, 500px), 1fr));
        gap: 1.25rem;
    }

    /* Recent Violations - Full width */
    .recent-violations {
        grid-column: span 12;
    }

    /* Card Styling */
    .stat-card, .chart-card, .performance-card {
        background-color: var(--dashboard-card-bg);
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.04);
        transition: all 0.3s ease;
        border: none;
        overflow: hidden;
        height: 100%;
    }

    .stat-card:hover, .chart-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.08);
    }

    .stat-card .card-body {
        padding: 1.5rem;
        display: flex;
        align-items: center;
    }

    .chart-card .card-header {
        background-color: transparent;
        border-bottom: 1px solid var(--dashboard-border);
        padding: 1rem 1.25rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .chart-card .card-header h5 {
        font-weight: 600;
        font-size: 1rem;
        margin-bottom: 0;
        color: var(--dashboard-text-dark);
    }

    .chart-card .card-body {
        padding: 1rem;
        position: relative;
        height: 300px; /* Fixed height for charts */
    }

    /* Stat Card Content */
    .icon-area {
        width: 52px;
        height: 52px;
        border-radius: 12px;
        margin-right: 1rem;
        background-color: var(--dashboard-primary-light);
        color: var(--dashboard-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        box-shadow: 0 4px 8px rgba(37, 99, 235, 0.15);
    }

    .warning-icon {
        background-color: var(--dashboard-warning-light);
        color: var(--dashboard-warning);
        box-shadow: 0 4px 8px rgba(234, 179, 8, 0.15);
    }

    .error-icon {
        background-color: var(--dashboard-danger-light);
        color: var(--dashboard-danger);
        box-shadow: 0 4px 8px rgba(239, 68, 68, 0.15);
    }

    .education-icon {
        background-color: var(--dashboard-info-light);
        color: var(--dashboard-info);
        box-shadow: 0 4px 8px rgba(14, 165, 233, 0.15);
    }

    .stat-content {
        flex-grow: 1;
    }

    .stat-content h6 {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--dashboard-text-medium);
        margin-bottom: 0.25rem;
        letter-spacing: 0.5px;
        text-transform: uppercase;
    }

    .stat-content h2 {
        font-size: 1.75rem;
        font-weight: 700;
        margin-bottom: 0.25rem;
        color: var(--dashboard-text-dark);
    }

    .trend {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.75rem;
        color: var(--dashboard-text-medium);
    }

    .trend .material-icons {
        font-size: 1rem;
    }

    .trend-up {
        color: var(--dashboard-success);
    }

    .warning {
        color: var(--dashboard-warning);
    }

    .error {
        color: var(--dashboard-danger);
    }

    /* Performance Card */
    .performance-card .card-body {
        padding: 2rem 1.5rem;
    }

    .performance-card .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background-color: var(--bs-primary-subtle);
        color: var(--bs-primary);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .performance-card .display-4 {
        font-size: 2.5rem;
    }

    /* Chart Controls */
    .chart-controls .btn {
        padding: 0.25rem 0.75rem;
        font-size: 0.875rem;
        border-radius: 6px;
        border-color: var(--dashboard-border);
        color: var(--dashboard-text-medium);
        background-color: transparent;
        transition: all 0.2s ease;
    }

    .chart-controls .btn:hover {
        background-color: var(--dashboard-primary-light);
        color: var(--dashboard-primary);
        border-color: var(--dashboard-primary-light);
    }

    .chart-controls .btn.active {
        background-color: var(--dashboard-primary);
        color: white;
        border-color: var(--dashboard-primary);
    }

    /* Recent Violations Table */
    .recent-violations .card {
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 12px rgba(0,0,0,0.04);
        border: none;
    }

    .recent-violations .table th {
        font-weight: 600;
        color: var(--dashboard-text-medium);
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.5px;
    }

    .recent-violations .table td {
        padding: 0.75rem 1rem;
        vertical-align: middle;
        color: var(--dashboard-text-dark);
    }

    /* Action Buttons */
    .action-buttons {
        display: flex !important;
        justify-content: center !important;
        align-items: center !important;
        gap: 4px !important;
        width: 100% !important;
        max-width: 140px !important;
        margin-left: auto !important;
    }

    .action-btn {
        width: 40px !important;
        height: 40px !important;
        min-width: 40px !important;
        max-width: 40px !important;
        padding: 0 !important;
        border-radius: 4px !important;
        display: inline-flex !important;
        align-items: center !important;
        justify-content: center !important;
        flex: 0 0 40px !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
        transition: all 0.2s !important;
    }

    .action-btn:hover {
        transform: translateY(-2px) !important;
        box-shadow: 0 4px 8px rgba(0,0,0,0.15) !important;
    }

    .action-btn .material-icons {
        color: white !important;
        font-size: 18px !important;
        margin: 0 !important;
        line-height: 1 !important;
    }

    /* View Button */
    .btn-primary.action-btn {
        background-color: var(--dashboard-primary) !important;
        border-color: var(--dashboard-primary) !important;
    }

    /* Edit Button */
    .btn-info.action-btn {
        background-color: #8950fc !important;
        border-color: #8950fc !important;
    }

    /* Warning Button */
    .btn-warning.action-btn {
        background-color: #f59e0b !important;
        border-color: #f59e0b !important;
    }

    /* Success Button */
    .btn-success.action-btn {
        background-color: #22c55e !important;
        border-color: #22c55e !important;
    }

    /* Delete Button */
    .btn-danger.action-btn {
        background-color: #f64e60 !important;
        border-color: #f64e60 !important;
    }

    /* Hide text labels on buttons */
    .view-text {
        display: none;
    }

    /* Original action button styles - overridden with new styles */
    .btn-action {
        display: none !important;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .action-btn {
            width: 36px !important;
            height: 36px !important;
            min-width: 36px !important;
            max-width: 36px !important;
        }
        
        .action-btn .material-icons {
            font-size: 16px !important;
        }
    }

    /* Additional responsive adjustments */
    @media (max-width: 767.98px) {
        .dashboard-grid {
            gap: 1rem;
        }

        .stat-card .card-body {
            padding: 1rem;
        }

        .icon-area {
            width: 42px;
            height: 42px;
        }

        .stat-content h2 {
            font-size: 1.5rem;
        }

        .chart-card .card-body {
            height: 250px;
        }

        .performance-card .display-4 {
            font-size: 2rem;
        }
    }

    /* Add smooth transitions */
    .dashboard-grid > * {
        transition: all 0.3s ease;
    }

    /* Add subtle animations on hover */
    .chart-card:hover .card-header {
        background-color: rgba(0,0,0,0.01);
    }

    /* Loading indicators */
    .loading-indicator {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: rgba(255, 255, 255, 0.8);
        z-index: 10;
        backdrop-filter: blur(2px);
        border-radius: 12px;
    }
    
    /* Animations */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    .dashboard-grid > * {
        animation: fadeIn 0.5s ease-out forwards;
    }
    
        .stat-card {
        animation-delay: calc(var(--animation-order, 0) * 0.1s);
    }
    
    .chart-card {
        animation-delay: calc(var(--animation-order, 0) * 0.15s + 0.2s);
    }
    
    /* Hover effects */
    .stat-card:hover .icon-area {
        animation: pulse 0.5s ease-in-out;
    }
    
    /* Badge styling */
    .badge {
        padding: 0.35em 0.65em;
        font-weight: 600;
        letter-spacing: 0.3px;
    }
    
    .badge.text-bg-success {
        background-color: var(--dashboard-success-light) !important;
        color: var(--dashboard-success) !important;
    }
    
    .badge.text-bg-warning {
        background-color: var(--dashboard-warning-light) !important;
        color: var(--dashboard-warning) !important;
    }
    
    .badge.text-bg-danger {
        background-color: var(--dashboard-danger-light) !important;
        color: var(--dashboard-danger) !important;
    }
    
    .badge.text-bg-info {
        background-color: var(--dashboard-info-light) !important;
        color: var(--dashboard-info) !important;
    }
    
    /* Error messages */
    .error-message {
        text-align: center;
        padding: 2rem;
        color: var(--dashboard-text-medium);
        font-size: 0.875rem;
    }
    
    .error-message .material-icons {
        font-size: 2.5rem;
        margin-bottom: 1rem;
        color: var(--dashboard-text-light);
    }
    
    /* Toast notifications */
    .toast {
        border-radius: 8px;
        box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        border: none;
    }

    .toast.bg-danger {
        background-color: var(--dashboard-danger) !important;
    }
    
    /* Responsive improvements */
    @media (max-width: 767.98px) {
        .section-title {
            font-size: 1.1rem;
        }
        
        .stat-content h2 {
            font-size: 1.5rem;
        }
        
        .chart-card .card-body {
            height: 250px;
        }
    }
    
    @media (max-width: 576px) {
        .dashboard-grid {
            gap: 0.75rem;
        }
        
        .stat-card .card-body {
            padding: 1rem;
        }
        
        .chart-card .card-body {
            height: 220px;
        }
    }

    /* Adjudication Container */
    .adjudication-container {
        grid-column: span 12;
        background-color: var(--dashboard-bg);
        padding: 0;
        margin-bottom: 1rem;
    }

    .adjudication-container .section-title {
        margin-top: 0;
    }

    .adjudication-container .adjudication-stats {
        margin-bottom: 2rem;
    }

    .adjudication-container .adjudication-charts {
        margin-top: 1rem;
    }

    .adjudication-container .icon-area {
        /* Removed special background and color styles to match other icon areas */
    }

    .adjudication-container .card {
        /* Removed special box-shadow to match other cards */
    }

    /* Pagination Styling */
    .pagination-container {
        border-top: 1px solid var(--dashboard-border);
        padding: 1rem 0;
    }
    
    .pagination .page-link {
        color: var(--dashboard-primary);
        border-color: var(--dashboard-border);
        padding: 0.4rem 0.75rem;
        font-size: 0.875rem;
        background-color: white;
        margin: 0 2px;
    }
    
    .pagination .page-item.active .page-link {
        background-color: var(--dashboard-primary);
        border-color: var(--dashboard-primary);
        color: white;
    }
    
    .pagination .page-item.disabled .page-link {
        color: var(--dashboard-text-light);
    }
    
    .pagination .page-link:hover {
        background-color: var(--dashboard-primary-light);
        border-color: var(--dashboard-border);
        color: var(--dashboard-primary);
    }
    
    .pagination .page-item.active .page-link:hover {
        background-color: var(--dashboard-primary-hover);
        color: white;
    }
</style>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Define the color palette for charts
    const chartColors = {
        primary: '#2563eb',
        primaryLight: 'rgba(37, 99, 235, 0.1)',
        secondary: '#8950fc',
        secondaryLight: 'rgba(137, 80, 252, 0.1)',
        success: '#22c55e',
        successLight: 'rgba(34, 197, 94, 0.1)',
        warning: '#eab308',
        warningLight: 'rgba(234, 179, 8, 0.1)',
        danger: '#ef4444',
        dangerLight: 'rgba(239, 68, 68, 0.1)',
        info: '#0ea5e9',
        infoLight: 'rgba(14, 165, 233, 0.1)',
        textDark: '#1e293b',
        textMedium: '#64748b',
        textLight: '#94a3b8',
        gridColor: '#f1f5f9'
    };

    // Set Chart.js default options for consistent styling
    Chart.defaults.font.family = 'Plus Jakarta Sans, system-ui, sans-serif';
    Chart.defaults.font.size = 12;
    Chart.defaults.color = chartColors.textMedium;
    Chart.defaults.scale.grid.color = chartColors.gridColor;
    Chart.defaults.scale.grid.drawBorder = false;
    Chart.defaults.scale.ticks.padding = 10;
    Chart.defaults.plugins.tooltip.titleColor = '#fff';
    Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(30, 41, 59, 0.9)';
    Chart.defaults.plugins.tooltip.padding = 12;
    Chart.defaults.plugins.tooltip.cornerRadius = 8;
    Chart.defaults.plugins.tooltip.displayColors = false;
    Chart.defaults.plugins.tooltip.mode = 'index';
    Chart.defaults.plugins.tooltip.intersect = false;
    
    // Load chart data from context
    const violationsData = JSON.parse('{{ violations_data|safe }}');
    const dates = JSON.parse('{{ dates|safe }}');
    
    // Status distribution data
    const statusLabels = ['Pending', 'Paid', 'Settled', 'Overdue'];
    const statusData = [
        parseInt('{{ pending_violations }}'),
        parseInt('{{ paid_violations }}'),
        parseInt('{{ settled_violations }}'),
        parseInt('{{ overdue_violations }}')
    ];
    
    // Adjudication trend data
    const adjDates = JSON.parse('{{ adjudication_trend.dates|safe|default:"[]" }}');
    const approvedSeries = JSON.parse('{{ adjudication_trend.approved_series|safe|default:"[]" }}');
    const rejectedSeries = JSON.parse('{{ adjudication_trend.rejected_series|safe|default:"[]" }}');
    const pendingSeries = JSON.parse('{{ adjudication_trend.pending_series|safe|default:"[]" }}');
    
    // Validate adjudication trend data and provide fallbacks if needed
    let validAdjudicationData = true;
    let adjudicationErrorMessage = '';
    
    try {
        if (!Array.isArray(adjDates) || adjDates.length === 0) {
            adjudicationErrorMessage = 'Missing or empty dates array';
            validAdjudicationData = false;
        } else if (!Array.isArray(approvedSeries) || approvedSeries.length === 0) {
            adjudicationErrorMessage = 'Missing or empty approved series data';
            validAdjudicationData = false;
        } else if (!Array.isArray(rejectedSeries) || rejectedSeries.length === 0) {
            adjudicationErrorMessage = 'Missing or empty rejected series data';
            validAdjudicationData = false;
        } else if (!Array.isArray(pendingSeries) || pendingSeries.length === 0) {
            adjudicationErrorMessage = 'Missing or empty pending series data';
            validAdjudicationData = false;
        } else if (
            approvedSeries.length !== adjDates.length ||
            rejectedSeries.length !== adjDates.length ||
            pendingSeries.length !== adjDates.length
        ) {
            adjudicationErrorMessage = 'Data series length mismatch';
            validAdjudicationData = false;
        }
    } catch (error) {
        console.error('Error validating adjudication trend data:', error);
        adjudicationErrorMessage = 'Error validating chart data';
        validAdjudicationData = false;
    }
    
    // Create default data if original data is invalid
    const fallbackAdjDates = ['2023-01-01', '2023-02-01', '2023-03-01', '2023-04-01', '2023-05-01', '2023-06-01'];
    const fallbackApprovedSeries = [12, 15, 18, 14, 16, 19];
    const fallbackRejectedSeries = [5, 3, 4, 2, 3, 1];
    const fallbackPendingSeries = [8, 6, 9, 7, 10, 8];
    
    // Use fallback data if needed
    const useAdjDates = validAdjudicationData ? adjDates : fallbackAdjDates;
    const useApprovedSeries = validAdjudicationData ? approvedSeries : fallbackApprovedSeries;
    const useRejectedSeries = validAdjudicationData ? rejectedSeries : fallbackRejectedSeries;
    const usePendingSeries = validAdjudicationData ? pendingSeries : fallbackPendingSeries;
    
    // Log status for debugging
    if (!validAdjudicationData) {
        console.warn('Using fallback data for adjudication trend chart. Reason:', adjudicationErrorMessage);
    }
    
    // Violation types data
    const violationTypeLabels = JSON.parse('{{ adjudication_types.labels|safe }}');
    const violationTypeValues = JSON.parse('{{ adjudication_types.values|safe }}');
            
    // Monthly adjudication data
    const monthLabels = JSON.parse('{{ adjudication_performance.month_labels|safe }}');
    const monthValues = JSON.parse('{{ adjudication_performance.month_values|safe }}');
    
    // Format dates for Chart.js
    function formatDates(dateStrings) {
        return dateStrings.map(d => {
            const date = new Date(d);
            return date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric'
        });
    });
    }
    
    // Create Violations Chart
    const violationsCtx = document.getElementById('violationsChart').getContext('2d');
    const violationsChart = new Chart(violationsCtx, {
        type: 'line',
        data: {
            labels: formatDates(dates),
            datasets: [{
                label: 'Violations',
                data: violationsData,
                borderColor: chartColors.primary,
                backgroundColor: chartColors.primaryLight,
                pointBackgroundColor: chartColors.primary,
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 4,
                pointHoverRadius: 6,
                tension: 0.4,
                fill: true,
                borderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: { display: false },
                legend: {
                    position: 'top',
                    align: 'end',
                    labels: { 
                        usePointStyle: true,
                        boxWidth: 6,
                        boxHeight: 6,
                        padding: 20,
                        font: { weight: 'bold' }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.parsed.y + ' violations';
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: { display: false },
                    grid: { display: false }
                },
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Number of Violations',
                        font: { size: 12 }
                    },
                    ticks: {
                        stepSize: 1,
                        precision: 0
                    }
                }
            },
            elements: {
                line: {
                    tension: 0.4
                }
            }
        }
    });
    
    // Create Status Distribution Chart
    const statusCtx = document.getElementById('statusDistributionChart').getContext('2d');
    const statusChart = new Chart(statusCtx, {
        type: 'doughnut',
        data: {
            labels: statusLabels,
            datasets: [{
                data: statusData,
                backgroundColor: [
                    chartColors.warning,
                    chartColors.success,
                    chartColors.primary,
                    chartColors.danger
                ],
                borderColor: '#ffffff',
                borderWidth: 2,
                hoverOffset: 15
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '70%',
            plugins: {
                legend: {
                    position: 'bottom',
            labels: {
                        usePointStyle: true,
                        padding: 20,
                        font: { size: 12 }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label;
                            const value = context.raw;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = Math.round((value / total) * 100);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            },
            animation: {
                animateScale: true,
                animateRotate: true
            }
        }
    });

    // Create Adjudication Trend Chart
    const adjTrendCtx = document.getElementById('adjudicationTrendChart').getContext('2d');
    const adjTrendChart = new Chart(adjTrendCtx, {
        type: 'bar',
        data: {
            labels: formatDates(useAdjDates),
            datasets: [
                {
                    label: 'Approved',
                    data: useApprovedSeries,
                    backgroundColor: 'rgba(34, 197, 94, 0.8)',
                    borderRadius: 4,
                    stack: 'Stack 0',
                    barPercentage: 0.7,
                    categoryPercentage: 0.8
                },
                {
                    label: 'Rejected',
                    data: useRejectedSeries,
                    backgroundColor: 'rgba(239, 68, 68, 0.8)',
                    borderRadius: 4,
                    stack: 'Stack 0',
                    barPercentage: 0.7,
                    categoryPercentage: 0.8
                },
                {
                    label: 'Pending',
                    data: usePendingSeries,
                    backgroundColor: 'rgba(59, 130, 246, 0.8)',
                    borderRadius: 4,
                    stack: 'Stack 0',
                    barPercentage: 0.7,
                    categoryPercentage: 0.8
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: { display: false },
                legend: {
                    position: 'top',
                    align: 'end',
            labels: {
                        usePointStyle: true,
                        boxWidth: 8,
                        boxHeight: 8,
                        padding: 20
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y;
                        }
                    }
                }
            },
            scales: {
                x: {
                    stacked: true,
                    grid: { display: false }
                },
                y: {
                    stacked: true,
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Number of Adjudications',
                        font: { size: 12 }
                    },
                    ticks: {
                        stepSize: 1,
                        precision: 0
                    }
                }
            }
        }
    });
    
    // Create Violation Types Chart
    const violationTypesCtx = document.getElementById('violationTypesChart').getContext('2d');
    const violationTypesChart = new Chart(violationTypesCtx, {
        type: 'bar',
        data: {
            labels: violationTypeLabels,
            datasets: [{
                label: 'Adjudications',
                data: violationTypeValues,
                backgroundColor: 'rgba(137, 80, 252, 0.8)',
                borderRadius: 6,
                barPercentage: 0.7,
                categoryPercentage: 0.8
            }]
        },
            options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.parsed.x + ' adjudications';
                        }
                    }
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Number of Adjudications',
                        font: { size: 12 }
                    },
                    ticks: {
                        stepSize: 1,
                        precision: 0
                    }
                },
                y: {
                    grid: { display: false }
                }
            }
        }
    });
    
    // Create Monthly Adjudication Chart
    const monthlyCtx = document.getElementById('monthlyAdjudicationChart').getContext('2d');
    const monthlyChart = new Chart(monthlyCtx, {
        type: 'line',
        data: {
            labels: monthLabels,
            datasets: [{
                label: 'Adjudications',
                data: monthValues,
                borderColor: '#8950fc',
                backgroundColor: 'rgba(137, 80, 252, 0.1)',
                pointBackgroundColor: '#8950fc',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 6,
                pointHoverRadius: 8,
                tension: 0.4,
                fill: true,
                borderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.parsed.y + ' adjudications';
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: { display: false }
                },
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Number of Adjudications',
                        font: { size: 12 }
                    },
                    ticks: {
                        stepSize: 1,
                        precision: 0
                    }
                }
            }
        }
    });

    // Time range selector functionality for violations chart
    document.querySelectorAll('[data-range]').forEach(button => {
        button.addEventListener('click', function() {
            // Remove active class from all buttons
            document.querySelectorAll('[data-range]').forEach(btn => {
                btn.classList.remove('active');
            });
            // Add active class to clicked button
            this.classList.add('active');
            
            // Update chart data based on selected range
            updateViolationsChartData(this.dataset.range);
        });
    });
    
    // Time range selector functionality for adjudication chart
    document.querySelectorAll('[data-adj-range]').forEach(button => {
        button.addEventListener('click', function() {
            // Remove active class from all buttons
            document.querySelectorAll('[data-adj-range]').forEach(btn => {
                btn.classList.remove('active');
            });
            // Add active class to clicked button
            this.classList.add('active');
            
            // Update chart data based on selected range
            updateAdjudicationChartData(this.dataset.adjRange);
        });
    });

    function updateViolationsChartData(range) {
        fetch(`/api/statistics/${range}/`)
            .then(response => response.json())
            .then(data => {
                // Update chart
                violationsChart.data.labels = formatDates(data.violations.labels);
                violationsChart.data.datasets[0].data = data.violations.datasets[0].data;
                violationsChart.update();
            })
            .catch(error => {
                console.error('Error fetching violation statistics:', error);
            });
    }
    
    function updateAdjudicationChartData(range) {
        // Show loading state
        const chartContainer = document.querySelector('.adj-trend-chart .card-body');
        if (chartContainer) {
            const loadingIndicator = document.createElement('div');
            loadingIndicator.className = 'loading-indicator';
            loadingIndicator.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>';
            chartContainer.appendChild(loadingIndicator);
        }
        
        fetch(`/api/adjudication-statistics/${range}/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Server responded with ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                // Validate the returned data
                if (!data.dates || !Array.isArray(data.dates) || !data.approved_series || 
                    !data.rejected_series || !data.pending_series) {
                    console.error('Invalid data format received from API:', data);
                    throw new Error('Invalid data format received from API');
                }
                
                // Update chart
                adjTrendChart.data.labels = formatDates(data.dates);
                adjTrendChart.data.datasets[0].data = data.approved_series;
                adjTrendChart.data.datasets[1].data = data.rejected_series;
                adjTrendChart.data.datasets[2].data = data.pending_series;
                adjTrendChart.update();
            })
            .catch(error => {
                console.error('Error fetching adjudication statistics:', error);
                // Show error notification
                showErrorNotification(`Failed to load adjudication data: ${error.message}`);
            })
            .finally(() => {
                // Remove loading indicator
                const loadingIndicator = document.querySelector('.adj-trend-chart .loading-indicator');
                if (loadingIndicator) {
                    loadingIndicator.remove();
                }
            });
    }

    // Add subtle entry animations
    const chartCards = document.querySelectorAll('.chart-card');
    chartCards.forEach((card, index) => {
        setTimeout(() => {
            card.style.opacity = '1';
        }, 100 * index);
    });

    // Educational Analytics - Connect to API
    function initializeEducationalData() {
        console.log('Initializing educational data');
        
        // Show loading indicators for all educational section cards and charts
        document.querySelectorAll('.educational-stats .stat-card, .educational-charts .chart-card').forEach(card => {
            card.style.position = 'relative';
            
            // Check if loading indicator already exists
            const existingIndicator = card.querySelector('.loading-indicator');
            if (!existingIndicator) {
                const loadingIndicator = document.createElement('div');
                loadingIndicator.className = 'position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center bg-white bg-opacity-75 loading-indicator';
                loadingIndicator.innerHTML = '<div class="spinner-border text-primary spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div>';
                card.appendChild(loadingIndicator);
            }
        });
        
        // Clear any existing charts to prevent conflicts
        if (window.completionChart) {
            console.log('Destroying existing chart before fetching new data');
            window.completionChart.destroy();
            window.completionChart = null;
        }
        
        // Make sure the canvas elements are visible and clear any error messages
        const categoryCtx = document.getElementById('categoryTopicsChart');
        const completionCtx = document.getElementById('passFailRateChart');
        if (categoryCtx) categoryCtx.style.display = 'block';
        if (completionCtx) completionCtx.style.display = 'block';
        
        document.querySelectorAll('.educational-charts .error-message, .educational-charts .badge').forEach(el => el.remove());
        
        // Fetch educational analytics data from API
        console.log('Fetching educational analytics data');
        fetch('/api/educational-analytics/')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Server responded with ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(result => {
                console.log('Received educational analytics data:', result);
                
                if (result.status === 'success' && result.data) {
                    const data = result.data;
                    
                    // Update stats cards
                    document.getElementById('total-categories').textContent = data.total_categories || '0';
                    document.getElementById('new-categories').textContent = (data.new_categories || '0') + ' new this month';
                    document.getElementById('total-topics').textContent = data.total_topics || '0';
                    document.getElementById('new-topics').textContent = (data.new_topics || '0') + ' new this month';
                    document.getElementById('published-topics').textContent = data.published_topics || '0';
                    document.getElementById('published-rate').textContent = (data.published_rate || '0') + '% of total';
                    document.getElementById('pass-rate').textContent = (data.average_pass_rate || '0') + '%';
                    document.getElementById('completion-rate').textContent = (data.completion_rate || '0') + '% completion rate';
                    
                    // Initialize Category Topics Chart with validation
                    if (data.categories && data.categories.labels && data.categories.values) {
                        console.log('Initializing category chart with data:', data.categories);
                        initializeCategoryChart(data.categories);
                    } else {
                        console.error('Invalid category data structure:', data.categories);
                        // Use fallback data
                        initializeCategoryChart({
                            labels: ['Traffic Rules', 'Road Safety', 'Vehicle Regulations', 'Defensive Driving', 'Emergency Response'],
                            values: [12, 10, 8, 6, 4]
                        });
                    }
                    
                    // Initialize Pass/Fail Rate Chart with validation
                    console.log('Initializing pass/fail rate chart with data:', data.completion_trend);
                    
                    // Transform the data for our new pass/fail chart - preserve pass_series and add failure_series
                    const passFailData = {
                        labels: data.completion_trend?.labels || ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                        pass_series: data.completion_trend?.pass_series || [78, 80, 79, 81, 82, 82]
                    };
                    
                    initializeCompletionRateChart(passFailData);
                } else {
                    console.error('Error in API response:', result.message || 'Invalid response format');
                    
                    // Show error messages in cards
                    document.querySelectorAll('.educational-stats .stat-content h2, #published-rate, #completion-rate').forEach(element => {
                        element.textContent = 'N/A';
                    });
                    
                    // Fall back to mock data
                    showErrorAndUseMockData(error.message);
                }
            })
            .catch(error => {
                console.error('Error fetching educational analytics:', error);
                // Fall back to mock data for demonstration
                showErrorAndUseMockData(error.message);
            })
            .finally(() => {
                // Remove all loading indicators
                document.querySelectorAll('.loading-indicator').forEach(indicator => {
                    indicator.remove();
                });
            });
    }
    
    function showErrorAndUseMockData(errorMessage) {
        console.log('Initializing with mock data');
        
        // Mock educational analytics data
        const educationalData = {
            totalCategories: 12,
            newCategories: 2,
            totalTopics: 48,
            newTopics: 5,
            publishedTopics: 36,
            publishedRate: 75,
            averagePassRate: 82,
            completionRate: 68,
            categories: {
                labels: ['Traffic Rules', 'Road Safety', 'Vehicle Regulations', 'Defensive Driving', 'Emergency Response'],
                values: [12, 10, 8, 6, 4]
            },
            completion_trend: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                pass_series: [78, 80, 79, 81, 82, 82]
            }
        };
        
        // Update stats cards
        document.getElementById('total-categories').textContent = educationalData.totalCategories;
        document.getElementById('new-categories').textContent = educationalData.newCategories + ' new this month';
        document.getElementById('total-topics').textContent = educationalData.totalTopics;
        document.getElementById('new-topics').textContent = educationalData.newTopics + ' new this month';
        document.getElementById('published-topics').textContent = educationalData.publishedTopics;
        document.getElementById('published-rate').textContent = educationalData.publishedRate + '% of total';
        document.getElementById('pass-rate').textContent = educationalData.averagePassRate + '%';
        document.getElementById('completion-rate').textContent = educationalData.completionRate + '% completion rate';
        
        // Clear any existing chart to prevent conflicts
        if (window.completionChart) {
            console.log('Destroying existing chart');
            window.completionChart.destroy();
        }
        
        const categoryCtx = document.getElementById('categoryTopicsChart');
        const completionCtx = document.getElementById('passFailRateChart');
        
        // Ensure canvas elements are visible
        if (categoryCtx) categoryCtx.style.display = 'block';
        if (completionCtx) completionCtx.style.display = 'block';
        
        // Remove any error messages that might be present
        document.querySelectorAll('.educational-charts .error-message').forEach(msg => msg.remove());
        
        // Initialize charts with mock data
        console.log('Initializing category chart with mock data');
        initializeCategoryChart(educationalData.categories);
        
        console.log('Initializing pass/fail rate chart with mock data');
        initializeCompletionRateChart(educationalData.completion_trend);
    }
    
    function initializeCategoryChart(categoryData) {
        const categoryCtx = document.getElementById('categoryTopicsChart').getContext('2d');
        
        // Check if we have data
        if (!categoryData || !categoryData.labels || categoryData.labels.length === 0) {
            // Display a message in the chart area
            const noDataMessage = document.createElement('div');
            noDataMessage.className = 'text-center p-5 text-muted';
            noDataMessage.innerHTML = '<p>No category data available</p>';
            categoryCtx.canvas.parentNode.appendChild(noDataMessage);
            categoryCtx.canvas.style.display = 'none';
            return;
        }
        
        const categoryChart = new Chart(categoryCtx, {
            type: 'bar',
            data: {
                labels: categoryData.labels,
                datasets: [{
                    label: 'Number of Topics',
                    data: categoryData.values,
                    backgroundColor: chartColors.info,
                    borderRadius: 6,
                    barPercentage: 0.7,
                    categoryPercentage: 0.8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.parsed.y + ' topics';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { display: false }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Topics',
                            font: { size: 12 }
                        },
                        ticks: {
                            stepSize: 2,
                            precision: 0
                        }
                    }
                }
            }
        });
    }
    
    function initializeCompletionRateChart(trendData) {
        const completionCtx = document.getElementById('passFailRateChart').getContext('2d');
        
        console.log('Initializing pass/fail rate chart with data:', trendData);
        
        // Better data validation with more detailed logging
        let hasValidData = false;
        let validationError = '';
        
        try {
            if (!trendData) {
                validationError = 'No trend data provided';
            } else if (!trendData.labels || !Array.isArray(trendData.labels)) {
                validationError = 'Missing or invalid labels array';
            } else if (!trendData.pass_series || !Array.isArray(trendData.pass_series)) {
                validationError = 'Missing or invalid pass_series array';
            } else if (trendData.labels.length === 0) {
                validationError = 'Labels array is empty';
            } else if (trendData.pass_series.length !== trendData.labels.length) {
                validationError = `Pass series length (${trendData.pass_series.length}) doesn't match labels length (${trendData.labels.length})`;
        } else {
                hasValidData = true;
            }
        } catch (error) {
            validationError = `Error validating data: ${error.message}`;
            console.error('Error during data validation:', error);
        }
        
        // Check if we have data
        if (!hasValidData) {
            console.error('Invalid pass/fail rate data:', validationError, trendData);
            
            // Create fallback data with consistent structure
            trendData = {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                pass_series: [78, 80, 79, 81, 82, 82]
            };
            
            // Display a small warning in the chart
            const warningElement = document.createElement('div');
            warningElement.className = 'position-absolute top-0 end-0 m-2 badge bg-warning text-dark';
            warningElement.innerHTML = 'Using demo data';
            warningElement.style.zIndex = '10';
            warningElement.style.opacity = '0.7';
            warningElement.style.fontSize = '0.7rem';
            completionCtx.canvas.parentNode.appendChild(warningElement);
            
            console.log('Using fallback data for pass/fail chart:', trendData);
        }
        
        // Ensure the canvas is visible
        completionCtx.canvas.style.display = 'block';
        
        // Check if chart already exists and destroy it before creating a new one
        if (window.completionChart) {
            console.log('Destroying existing pass/fail chart');
            window.completionChart.destroy();
        }
        
        // Calculate failure rate as the inverse of pass rate
        const failureRates = trendData.pass_series.map(rate => Math.max(0, 100 - rate));
        
        // Create the chart with error handling
        try {
            window.completionChart = new Chart(completionCtx, {
                type: 'line',
                data: {
                    labels: trendData.labels,
                    datasets: [
                        {
                            label: 'Passing Rate',
                            data: trendData.pass_series,
                            borderColor: chartColors.success,
                            backgroundColor: chartColors.successLight,
                            pointBackgroundColor: chartColors.success,
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            tension: 0.4,
                            fill: true,
                            borderWidth: 3
                        },
                        {
                            label: 'Failure Rate',
                            data: failureRates,
                            borderColor: chartColors.danger,
                            backgroundColor: chartColors.dangerLight,
                            pointBackgroundColor: chartColors.danger,
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            tension: 0.4,
                            fill: true,
                            borderWidth: 3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            align: 'end',
                            labels: { 
                                usePointStyle: true,
                                boxWidth: 6,
                                boxHeight: 6,
                                padding: 20,
                                font: { weight: 'bold' }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y + '%';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false }
                        },
                        y: {
                            beginAtZero: false,
                            min: 0,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Percentage (%)',
                                font: { size: 12 }
                            }
                        }
                    }
                }
            });
            
            console.log('Pass/fail chart initialized successfully');
        } catch (error) {
            console.error('Error creating pass/fail chart:', error);
            // Show error message in the chart area
            const errorMessage = document.createElement('div');
            errorMessage.className = 'text-center p-5 error-message';
            errorMessage.innerHTML = `
                <span class="material-icons">error_outline</span>
                <p>Error creating chart: ${error.message}</p>
            `;
            
            completionCtx.canvas.style.display = 'none';
            const parent = completionCtx.canvas.parentNode;
            parent.appendChild(errorMessage);
        }
    }
    
    function updateEducationalChartData(range) {
        // Show loading indicator
        const loadingIndicator = document.createElement('div');
        loadingIndicator.id = 'chart-loading';
        loadingIndicator.className = 'position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center bg-white bg-opacity-75 loading-indicator';
        loadingIndicator.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>';
        
        const chartContainer = document.getElementById('passFailRateChart').parentNode;
        chartContainer.style.position = 'relative';
        chartContainer.appendChild(loadingIndicator);
        
        console.log(`Fetching educational data for range: ${range}`);
        
        // Fetch data for the selected time range
        fetch(`/api/educational-analytics/${range}/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Server responded with ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(result => {
                console.log(`Received educational data for range ${range}:`, result);
                
                if (result.status === 'success' && result.data) {
                    // Initialize with the returned data - our improved initializeCompletionRateChart
                    // will handle validation and fallbacks
                    initializeCompletionRateChart(result.data);
                } else {
                    console.error('Error in API response:', result.message || 'Unknown error');
                    showErrorNotification('Error in server response');
                    
                    // Initialize with fallback data
                    initializeCompletionRateChart({
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                        pass_series: [78, 80, 79, 81, 82, 82]
                    });
                }
            })
            .catch(error => {
                console.error('Error fetching educational analytics by range:', error);
                showErrorNotification(`Failed to load chart data: ${error.message}`);
                
                // Initialize with fallback data
                initializeCompletionRateChart({
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    pass_series: [78, 80, 79, 81, 82, 82]
                });
            })
            .finally(() => {
                // Remove loading indicator
                document.getElementById('chart-loading')?.remove();
            });
    }
    
    function showErrorNotification(message) {
        const errorToast = document.createElement('div');
        errorToast.className = 'position-fixed top-0 end-0 p-3';
        errorToast.style.zIndex = '5000';
        errorToast.innerHTML = `
            <div class="toast show bg-danger text-white" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header">
                    <strong class="me-auto">Error</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body">
                    ${message}
                    <hr class="border-white opacity-25"/>
                    <small>Using demo data for preview</small>
                </div>
            </div>
        `;
        document.body.appendChild(errorToast);
        
        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            const toast = errorToast.querySelector('.toast');
            toast.classList.add('hiding');
            setTimeout(() => errorToast.remove(), 500);
        }, 5000);
    }
    
    // Initialize educational analytics section
    initializeEducationalData();
    
    // Time range selector functionality for educational charts
    document.querySelectorAll('[data-edu-range]').forEach(button => {
        button.addEventListener('click', function() {
            document.querySelectorAll('[data-edu-range]').forEach(btn => {
                btn.classList.remove('active');
            });
            this.classList.add('active');
            
            // Update chart data based on selected range
            updateEducationalChartData(this.dataset.eduRange);
        });
    });

    // Add animation order to cards for staggered entrance
    document.querySelectorAll('.stat-card').forEach((card, index) => {
        card.style.setProperty('--animation-order', index);
    });
    
    document.querySelectorAll('.chart-card').forEach((card, index) => {
        card.style.setProperty('--animation-order', index);
    });
});
</script>
{% endblock %}