{% extends 'base.html' %}
{% load static %}

{% block content %}
<!-- Add SweetAlert2 Library -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>

<!-- Custom Styles for Enhanced UI -->
<style>
    .search-section .info-card {
        background-color: #e6f2ff; /* Light blue background */
        border-left: 4px solid #0d6efd; /* Blue left border */
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* Enhanced shadow */
    }
    
    .info-card, .upload-card, .section {
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08); /* Enhanced shadow for all containers */
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        transition: all 0.3s ease;
    }
    
    .info-card:hover, .upload-card:hover, .section:hover {
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.12); /* Deeper shadow on hover */
    }
    
    .search-section .section-title {
        color: #0d6efd; /* Blue title */
    }
    
    .search-section .form-label {
        color: #0a58ca; /* Darker blue for labels */
        font-weight: 500;
    }
    
    .card {
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); /* Enhanced shadow for main card */
    }
    
    /* Enhanced section titles */
    .section-title {
        position: relative;
        padding-bottom: 10px;
        margin-bottom: 20px;
        font-weight: 600;
    }
    
    .section-title:after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        height: 3px;
        width: 50px;
        background-color: #0d6efd;
    }
    
    /* Form control enhancements */
    .form-control:focus {
        box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.25);
    }
    
    /* Better shadows for nested elements */
    .image-upload-container, .alert, .selected-violations-container table {
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }
    
    /* Add smooth transitions to all interactive elements */
    .btn, .form-control, .form-select {
        transition: all 0.2s ease-in-out;
    }
    
    /* Improved form styling for single-column layout */
    .upload-preview {
        height: 140px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        border: 1px dashed #ced4da;
        border-radius: 8px;
        cursor: pointer;
        background-color: #f8f9fa;
        transition: all 0.2s ease;
    }
    
    .upload-preview:hover {
        background-color: #e9ecef;
        border-color: #adb5bd;
    }
    
    .upload-preview .material-icons {
        font-size: 3rem;
        color: #6c757d;
        margin-bottom: 10px;
    }
    
    /* Form actions styling */
    .form-actions {
        background-color: #f8f9fa;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 -5px 10px rgba(0, 0, 0, 0.05);
        margin-top: 20px;
    }
    
    .btn-submit {
        min-width: 120px;
    }
</style>

<div class="container-fluid py-4">
    <div class="card shadow-sm border-0 rounded-3">
        <div class="card-header bg-white py-3">
            <div class="d-flex align-items-center">
                <span class="material-icons me-2" style="color: var(--primary-color)">photo_camera</span>
                <h4 class="m-0">Upload NCAP Violation</h4>
            </div>
        </div>
        
        <div class="card-body p-4">
            {% if messages %}
            <div class="alert alert-success">
                {% for message in messages %}
                {{ message }}
                {% endfor %}
            </div>
            {% endif %}
            
            <!-- Search Section - Now with blue theme -->
            <div class="search-section mb-4">
                <div class="info-card">
                    <h5 class="section-title">Quick Search</h5>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="search-container">
                                <label for="operatorSearch" class="form-label">Search Operators by PD/PO Number</label>
                                <div class="input-group">
                                    <span class="input-group-text"><span class="material-icons">business</span></span>
                                    <input type="text" class="form-control" id="operatorSearch" 
                                           placeholder="Enter PD/PO number..." autocomplete="off">
                                    <button class="btn btn-primary" type="button" id="searchOperatorBtn">
                                        <span class="material-icons">search</span>
                                    </button>
                                </div>
                                <div id="operatorResults" class="search-results"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="search-container">
                                <label for="driverSearch" class="form-label">Search Drivers by PD Number</label>
                                <div class="input-group">
                                    <span class="input-group-text"><span class="material-icons">drive_eta</span></span>
                                    <input type="text" class="form-control" id="driverSearch" 
                                           placeholder="Enter PD number..." autocomplete="off">
                                    <button class="btn btn-primary" type="button" id="searchDriverBtn">
                                        <span class="material-icons">search</span>
                                    </button>
                                </div>
                                <div id="driverResults" class="search-results"></div>
                            </div>
                        </div>
                    </div>
                    <!-- Add Vehicle Type Dropdown to the Search Section -->
                    <div class="col-md-12 mt-3">
                        <div class="form-group">
                            <label for="vehicle_penalty_type" class="form-label">Vehicle Penalty Type</label>
                            <select class="form-control" id="vehicle_penalty_type" name="vehicle_penalty_type" onchange="recalculateTotal()">
                                <option value="regular">Regular Vehicles</option>
                                <option value="potpot">Pot-Pot / e-Pot Vehicles</option>
                            </select>
                            <small class="form-text text-muted">Select the appropriate penalty rate based on the vehicle type.</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <form method="POST" enctype="multipart/form-data" id="violationForm" class="needs-validation" novalidate>
                {% csrf_token %}
                
                <!-- Hidden field for duplicate submission prevention -->
                <input type="hidden" id="request_id" name="request_id" value="">
                
                <!-- Hidden fields for storing selected ID values -->
                <input type="hidden" id="selectedOperatorId" name="selected_operator_id" value="">
                <input type="hidden" id="selectedDriverId" name="selected_driver_id" value="">
                
                <!-- IMAGE UPLOADS NOW AT THE TOP -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="upload-card" style="background-color: #f8f9fa; border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);">
                            <h5 class="section-title">Upload Images</h5>
                            
                            <div class="row">
                                <div class="col-md-4">
                                    <!-- Driver photo -->
                                    <div class="mb-4">
                                        <h6 class="mb-2">Driver Photo</h6>
                                        <div class="image-upload-container">
                                            <div class="upload-preview" id="driverPhotoPreview">
                                                <span class="material-icons">account_circle</span>
                                                <div class="upload-text">Click to upload driver photo</div>
                                            </div>
                                            <input type="file" class="d-none" id="driver_photo" name="driver_photo" accept="image/*">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <!-- Plate photo -->
                                    <div class="mb-4">
                                        <h6 class="mb-2">Plate/Vehicle Photo</h6>
                                        <div class="image-upload-container">
                                            <div class="upload-preview" id="platePhotoPreview">
                                                <span class="material-icons">directions_car</span>
                                                <div class="upload-text">Click to upload plate photo</div>
                                            </div>
                                            <input type="file" class="d-none" id="plate_photo" name="vehicle_photo" accept="image/*">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <!-- Secondary ID photo -->
                                    <div class="mb-4">
                                        <h6 class="mb-2">Secondary ID Photo</h6>
                                        <div class="image-upload-container">
                                            <div class="upload-preview" id="secondaryPhotoPreview">
                                                <span class="material-icons">image</span>
                                                <div class="upload-text">Click to upload ID photo</div>
                                            </div>
                                            <input type="file" class="d-none" id="secondary_photo" name="secondary_photo" accept="image/*">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-2">
                                <div class="alert alert-info">
                                    <h6 class="mb-2">Image Requirements</h6>
                                    <div class="row">
                                        <div class="col-md-3"><span class="material-icons">check_circle</span> Clear and visible license plate</div>
                                        <div class="col-md-3"><span class="material-icons">check_circle</span> Good lighting conditions</div>
                                        <div class="col-md-3"><span class="material-icons">check_circle</span> JPG, JPEG, or PNG format</div>
                                        <div class="col-md-3"><span class="material-icons">check_circle</span> Max file size: 5MB</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- FORM FIELDS IN SINGLE COLUMN -->
                <div class="row">
                    <div class="col-12">
                        <div class="info-card" style="background-color: #ffffff; border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);">
                            <!-- Hidden field for generated timestamp -->
                            <input type="hidden" id="generated_timestamp" name="generated_timestamp">
                            
                            <!-- Driver's Details -->
                            <div class="section mb-4" id="driver_details_section" style="background-color: #ffffff; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);">
                                <h5 class="section-title">Driver's Details <span id="driver_auto_populated" class="badge bg-success ms-2" style="display: none;">Auto-populated</span></h5>
                                <div class="alert alert-info mb-3 small" role="alert">
                                    <i class="fas fa-info-circle"></i> Search and select a driver above to auto-populate these fields.
                                </div>
                                <div class="row g-3">
                                    <div class="col-md-12">
                                        <div class="form-floating">
                                            <input type="text" class="form-control" id="driver_name" 
                                                   name="driver_name">
                                            <label for="driver_name">Driver's Name</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-floating">
                                            <input type="text" class="form-control" id="novr_number" 
                                                   name="novr_number">
                                            <label for="novr_number">NOVR #</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-floating">
                                            <input type="text" class="form-control" id="pin_number" 
                                                   name="pin_number">
                                            <label for="pin_number">PIN #</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-floating">
                                            <input type="text" class="form-control" id="pd_number" 
                                                   name="pd_number">
                                            <label for="pd_number">PD Number</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-floating">
                                            <input type="text" class="form-control" id="license_number" 
                                                   name="license_number" pattern="[A-Z0-9]{3}-[0-9]{2}-[0-9]{6}" title="Format: XXX-XX-XXXXXX">
                                            <label for="license_number">License Number</label>
                                            <div class="form-text">Format: XXX-XX-XXXXXX (e.g., G12-24-001899) - Optional</div>
                                        </div>
                                    </div>
                                    <div class="col-md-12">
                                        <div class="form-floating">
                                            <textarea class="form-control" id="driver_address" 
                                                      name="driver_address" style="height: 80px"></textarea>
                                            <label for="driver_address">Driver Address</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Operator's Details -->
                            <div class="section mb-4" id="operator_details_section" style="background-color: #ffffff; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);">
                                <h5 class="section-title">Operator's Details <span id="operator_auto_populated" class="badge bg-success ms-2" style="display: none;">Auto-populated</span></h5>
                                <div class="alert alert-info mb-3 small" role="alert">
                                    <i class="fas fa-info-circle"></i> Search and select an operator above to auto-populate these fields.
                                </div>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="form-floating">
                                            <input type="text" class="form-control" id="operator_name" 
                                                   name="operator_name">
                                            <label for="operator_name">Operator's Name</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-floating">
                                            <input type="text" class="form-control" id="operator_pd_number" 
                                                   name="operator_pd_number">
                                            <label for="operator_pd_number">PO Number</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-floating">
                                            <input type="text" class="form-control" id="potpot_number" 
                                                   name="potpot_number">
                                            <label for="potpot_number">POTPOT No.</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-floating">
                                            <textarea class="form-control" id="operator_address" 
                                                      name="operator_address" style="height: 80px"></textarea>
                                            <label for="operator_address">Operator Address</label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Vehicle Information -->
                            <div class="section mb-4" id="vehicle_information_section" style="background-color: #ffffff; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);">
                                <h5 class="section-title">Vehicle Information</h5>
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <div class="form-floating">
                                            <input type="text" class="form-control" id="plate_number" 
                                                   name="plate_number">
                                            <label for="plate_number">Plate Number</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-floating">
                                            <input type="text" class="form-control" id="vehicle_type" 
                                                   name="vehicle_type">
                                            <label for="vehicle_type">Vehicle Type/Make</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-floating">
                                            <input type="text" class="form-control" id="color" 
                                                   name="color">
                                            <label for="color">Vehicle Color</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-floating">
                                            <select class="form-select" id="classification" name="classification">
                                                <option value="">Select classification</option>
                                                <option value="Private">Private</option>
                                                <option value="Public">Public</option>
                                                <option value="Government">Government</option>
                                                <option value="Commercial">Commercial</option>
                                            </select>
                                            <label for="classification">Classification</label>
                                        </div>
                                    </div>
                                    <div class="col-md-12">
                                        <div class="form-floating">
                                            <input type="text" class="form-control" id="registration_number" 
                                                   name="registration_number">
                                            <label for="registration_number">Registration Number</label>
                                            <div class="form-text">Optional - Vehicle registration information</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Rest of the form remains the same structure -->
                            <div class="section mb-4" style="background-color: #ffffff; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);">
                                <h5 class="section-title">Violation Details</h5>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <div class="form-floating">
                                            <input type="date" class="form-control" id="violation_date" 
                                                   name="violation_date">
                                            <label for="violation_date">Date</label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-floating">
                                            <input type="time" class="form-control" id="violation_time" 
                                                   name="violation_time">
                                            <label for="violation_time">Time</label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-floating">
                                            <input type="text" class="form-control" id="street_name" 
                                                   name="street_name">
                                            <label for="street_name">Street</label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-floating">
                                            <input type="text" class="form-control" id="landmark" 
                                                   name="landmark">
                                            <label for="landmark">Landmark</label>
                                        </div>
                                    </div>
                                    <!-- Remove the original vehicle_penalty_type dropdown from here -->
                                    <div class="col-md-4">
                                        <div class="form-floating">
                                            <input type="number" class="form-control" id="fine_amount" 
                                                   name="fine_amount" min="0" readonly>
                                            <label for="fine_amount">Total Penalty Amount (₱)</label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mt-2">
                                            <div class="alert alert-success p-2 mb-0">
                                                <strong>Final Amount:</strong> ₱<span id="final_amount_display">0.00</span>
                                                <div id="tdz_multiplier_info" style="display:none" class="small mt-1">
                                                    <i class="fas fa-info-circle"></i> Doubled for Traffic Discipline Zone
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-12" id="penalty_info_box">
                                        <div class="alert alert-info mt-2">
                                            <h6 class="alert-heading mb-2">Violation Penalty Information</h6>
                                            <div id="penalty_breakdown">
                                                <div><strong>Per Violation Rate:</strong> Base rate varies by vehicle type (Regular Vehicles or Pot-Pot/e-Pot Vehicles)</div>
                                                <div><strong>Multiple Violations:</strong> The total amount will be the base rate multiplied by the number of violations</div>
                                                <div><strong>TDZ Violations:</strong> Penalties are doubled in Traffic Discipline Zones</div>
                                                <div><strong>Late Payment:</strong> 1% monthly interest will be applied after the 3-day payment deadline</div>
                                                <div><strong>Note:</strong> A driver seminar is mandatory before payment is accepted</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-12">
                                        <div class="form-floating">
                                            <input type="text" class="form-control" id="location" 
                                                   name="location" required>
                                            <label for="location">Complete Location</label>
                                        </div>
                                    </div>
                                    <div class="col-md-12">
                                        <h6 class="mb-2">Traffic Violations Captured under NCAP</h6>
                                        <p class="small text-muted mb-3">These violations are subject to NCAP if detected by safety cameras. Each violation adds to the total penalty.</p>
                                        
                                        <!-- Debug information - will be visible only for developers -->
                                        <div class="alert alert-info mb-3" style="display: none;" id="debug_info">
                                            <h6>Debug Information (Available Violation Types)</h6>
                                            <ul>
                                                {% if violation_types %}
                                                    <li>Found {{ violation_types|length }} NCAP violation types:</li>
                                                    <ul>
                                                        {% for violation_type in violation_types %}
                                                            <li>{{ violation_type.name }} (₱{{ violation_type.amount }}) - Category: {{ violation_type.category }}</li>
                                                        {% endfor %}
                                                    </ul>
                                                {% else %}
                                                    <li>No NCAP violation types found in the database</li>
                                                {% endif %}
                                            </ul>
                                            <button class="btn btn-sm btn-secondary" onclick="document.getElementById('debug_info').style.display = 'none';">Hide Debug Info</button>
                                        </div>
                                        
                                        <!-- Multiple Violations Selection -->
                                        <div class="violation-selection-container mb-3">
                                            <div class="row">
                                                <div class="col-md-8">
                                                    <select class="form-select" id="violation_selector">
                                                        <option value="">Select violation type to add</option>
                                                        {% if violation_types %}
                                                            {% for violation_type in violation_types %}
                                                                {% if violation_type.classification == 'NCAP' %}
                                                                <option value="{{ violation_type.name }}" 
                                                                        data-amount="{{ violation_type.amount }}"
                                                                        data-classification="{{ violation_type.classification }}">
                                                                    {{ violation_type.name }} (₱{{ violation_type.amount }})
                                                                </option>
                                                                {% endif %}
                                                            {% endfor %}
                                                        {% else %}
                                                            <option value="" disabled>No violation types available</option>
                                                        {% endif %}
                                                    </select>
                                                </div>
                                                <div class="col-md-4">
                                                    <button type="button" class="btn btn-primary w-100" id="add_violation_btn">
                                                        <i class="fas fa-plus me-2"></i> Add Violation
                                                    </button>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Selected Violations Table -->
                                        <div class="selected-violations-container">
                                            <h6 class="mb-2">Selected Violations <small class="text-muted">(Each violation adds to penalty)</small></h6>
                                            <table class="table table-bordered table-hover" id="selected_violations_table">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th width="70%">Violation</th>
                                                        <th width="15%">Rate</th>
                                                        <th width="15%">Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="selected_violations_body">
                                                    <!-- Selected violations will be added here by JavaScript -->
                                                    <tr id="no_violations_row">
                                                        <td colspan="3" class="text-center py-3">No violations selected yet</td>
                                                    </tr>
                                                </tbody>
                                                <tfoot class="table-light">
                                                    <tr>
                                                        <th class="text-end">Total:</th>
                                                        <th colspan="2" id="count_display">0 violation(s)</th>
                                                    </tr>
                                                </tfoot>
                                            </table>
                                            
                                            <!-- Hidden input to store serialized violations data -->
                                            <input type="hidden" id="violation_type" name="violation_type" required>
                                            <input type="hidden" id="violation_penalties" name="violation_penalties">
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-12">
                                        <div class="form-check mt-3">
                                            <input class="form-check-input" type="checkbox" id="is_tdz_violation" name="is_tdz_violation" onchange="recalculateTotal()" onclick="console.log('[DEBUG] TDZ checkbox clicked'); recalculateTotal()">
                                            <label class="form-check-label" for="is_tdz_violation">
                                                <strong>Traffic Discipline Zone Violation (doubles fine)</strong>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Certificate Information -->
                            <div class="section mb-4" style="background-color: #ffffff; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);">
                                <h5 class="section-title">Certificate Information</h5>
                                <div class="certificate-content">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="official-info mb-3">
                                                <div class="official-label">Operations Officer</div>
                                                <div class="official-name">REYNALDO E. CRISOSTOMO, JR.</div>
                                                <input type="hidden" name="operations_officer" value="REYNALDO E. CRISOSTOMO, JR.">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="official-info mb-3">
                                                <div class="official-label">CTTM Officer</div>
                                                <div class="official-name">EDILBERITO B. EURAOBA II</div>
                                                <input type="hidden" name="cttm_officer" value="EDILBERITO B. EURAOBA II">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="certificate-text-block">
                                                <div class="text-block-title">Certificate Text</div>
                                                <div class="text-block-content">
                                                    Usa ko ka awtorısadong opisyal sa City Transportation and Traffic Management Office. Sumala sa among pag-inspeksyon sa mga halagway nga nakuha sa CCTV, ang ımong sakyanan gipa-tunkor ug halabapas sa Ordinansa sa Seguridad sa Bayawan.
                                                </div>
                                                <input type="hidden" name="certificate_text" value="Usa ko ka awtorısadong opisyal sa City Transportation and Traffic Management Office. Sumala sa among pag-inspeksyon sa mga halagway nga nakuha sa CCTV, ang ımong sakyanan gipa-tunkor ug halabapas sa Ordinansa sa Seguridad sa Bayawan.">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-md-12">
                                            <div class="certificate-text-block warning-block">
                                                <div class="text-block-title">Warning Text</div>
                                                <div class="text-block-content text-danger">
                                                    SIPAHIMANGONG ANG TAGTUNGOD NGA MO-AKSYON GAYUD BAYON NI-INING NOTISYA. ANG KABALAY-KASALIKAY SIGEAS SA PITO (7) KA ADLAW HUMAN MADAWAT NIINING NOTISYA. NAGKASABOT LAMANG NGA GI-AKO SA TAGTUNGOD ANG MAONG VIOLATIONS. PAGATABANGAN UG ALARMA ANG DPRNA SA BUSINESS ONE STOP SHOP (BOSS) KASANGPANAN MADAOT PAGAABOT ANG OPENA SA PAG-REVOKE SA MAYOR'S PERMIT.
                                                </div>
                                                <input type="hidden" name="warning_text" value="SIPAHIMANGONG ANG TAGTUNGOD NGA MO-AKSYON GAYUD BAYON NI-INING NOTISYA. ANG KABALAY-KASALIKAY SIGEAS SA PITO (7) KA ADLAW HUMAN MADAWAT NIINING NOTISYA. NAGKASABOT LAMANG NGA GI-AKO SA TAGTUNGOD ANG MAONG VIOLATIONS. PAGATABANGAN UG ALARMA ANG DPRNA SA BUSINESS ONE STOP SHOP (BOSS) KASANGPANAN MADAOT PAGAABOT ANG OPENA SA PAG-REVOKE SA MAYOR'S PERMIT.">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <style>
                            .certificate-content {
                                background-color: #f8f9fa;
                                border-radius: 8px;
                                padding: 15px;
                            }
                            
                            .official-info {
                                padding: 10px;
                                background-color: #ffffff;
                                border-radius: 6px;
                                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                            }
                            
                            .official-label {
                                font-size: 0.8rem;
                                color: #6c757d;
                                margin-bottom: 5px;
                            }
                            
                            .official-name {
                                font-size: 1rem;
                                font-weight: 600;
                                color: #343a40;
                            }
                            
                            .certificate-text-block {
                                margin-bottom: 10px;
                                background-color: white;
                                border: 1px solid #dee2e6;
                                border-radius: 6px;
                                padding: 15px;
                                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                            }
                            
                            .text-block-title {
                                font-size: 0.8rem;
                                color: #6c757d;
                                margin-bottom: 10px;
                                font-weight: 600;
                            }
                            
                            .text-block-content {
                                font-size: 0.95rem;
                                line-height: 1.5;
                                color: #212529;
                            }
                            
                            .warning-block {
                                border-left: 3px solid #dc3545;
                            }
                            
                            .warning-block .text-block-content {
                                font-weight: 500;
                            }
                            </style>

                            <!-- Additional Details -->
                            <div class="section mb-4">
                                <h5 class="section-title">Additional Details</h5>
                                <div class="row g-3">
                                    <div class="col-md-12">
                                        <div class="form-floating">
                                            <textarea class="form-control" id="description" name="description" style="height: 100px"></textarea>
                                            <label for="description">Notes/Remarks</label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Add form actions at bottom -->
                            <div class="form-actions text-end">
                                <div class="row">
                                    <div class="col-md-12">
                                        <button type="button" class="btn btn-outline-secondary me-2" onclick="window.history.back();">
                                            <i class="fas fa-times me-1"></i> Cancel
                                        </button>
                                        <button type="submit" class="btn btn-primary btn-submit">
                                            <i class="fas fa-save me-1"></i> Save Violation
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    /* Form container */
    .container-fluid {
        max-width: 1400px;
    }
    
    /* Card styling */
    .card {
        border-radius: 12px;
        overflow: hidden;
    }
    
    .card-header {
        background: white;
        border-bottom: 1px solid rgba(0,0,0,0.1);
    }
    
    .info-card {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 2px 15px rgba(0,0,0,0.05);
    }
    
    .section-title {
        color: var(--text-dark);
        font-weight: 600;
        margin-bottom: 1.5rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid var(--primary-color);
    }
    
    /* Upload styling */
    .upload-card {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 2px 15px rgba(0,0,0,0.05);
    }
    
    .image-upload-container {
        width: 100%;
    }
    
    .upload-preview {
        width: 100%;
        height: 250px; /* Increased height to make it square */
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background-color: #f8f9fa;
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .upload-preview:hover {
        border-color: var(--primary-color);
    }
    
    .upload-preview .material-icons {
        font-size: 36px;
        color: #adb5bd;
        margin-bottom: 0.5rem;
    }
    
    .upload-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .upload-text {
        font-size: 0.8rem;
        color: #6c757d;
    }
    
    /* Requirements list */
    .requirements-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .requirements-list li {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
        font-size: 0.9rem;
    }
    
    .requirements-list .material-icons {
        font-size: 1rem;
        color: var(--accent-teal);
    }
    
    .upload-info {
        margin-top: 2rem;
        padding: 1.5rem;
        background: #f8f9fa;
        border-radius: 12px;
    }
    
    /* Form styling */
    .form-floating {
        margin-bottom: 1rem;
    }
    
    .form-control:focus,
    .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.25rem rgba(37, 99, 235, 0.25);
    }
    
    .form-select {
        height: 3.5rem;
    }
    
    .btn {
        padding: 0.5rem 1.5rem;
        font-weight: 500;
    }
    
    @media (max-width: 992px) {
        .upload-card {
            margin-bottom: 2rem;
        }
    }
    
    .text-danger {
        color: #dc3545;
    }
    
    /* Search Section Styles */
    .search-container {
        position: relative;
        margin-bottom: 1rem;
    }
    
    .search-results {
        position: absolute;
        width: 100%;
        max-height: 300px;
        overflow-y: auto;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 0 0 6px 6px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        z-index: 1000;
        display: none;
    }
    
    .search-result-item {
        padding: 10px 15px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }
    
    .search-result-item:hover {
        background-color: rgba(37, 99, 235, 0.1);
    }
    
    .search-result-item:last-child {
        border-bottom: none;
    }
    
    .search-result-item .item-name {
        font-weight: 600;
        color: var(--text-dark);
    }
    
    .search-result-item .item-details {
        font-size: 0.85rem;
        color: var(--text-light);
    }
    
    .search-result-item .pd-number {
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--primary-color);
        background: rgba(37, 99, 235, 0.1);
        padding: 2px 8px;
        border-radius: 4px;
        display: inline-block;
    }
    
    .no-results {
        padding: 15px;
        text-align: center;
        color: var(--text-light);
    }
    
    .item-selected {
        background-color: rgba(37, 99, 235, 0.2);
    }
    
    .empty-state {
        text-align: center;
        padding: 20px;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        margin-bottom: 1rem;
    }
    
    .empty-state .material-icons {
        font-size: 48px;
        color: #adb5bd;
        margin-bottom: 10px;
    }
    
    .empty-state p {
        font-size: 1rem;
        color: #6c757d;
        margin-bottom: 5px;
    }
    
    .empty-state small {
        font-size: 0.8rem;
        color: #6c757d;
    }

    .search-debug-info {
        font-size: 0.75rem;
        background-color: #f8f9fa;
        border-top: 1px solid #dee2e6;
        padding: 0.5rem;
        color: #6c757d;
    }

    .po-match-highlight {
        background-color: rgba(25, 135, 84, 0.1) !important;
        border-left: 4px solid #198754 !important;
    }

    .matched-po-alert {
        color: #198754;
        font-weight: 600;
        font-size: 0.8rem;
        margin-top: 0.3rem;
        padding: 0.25rem 0;
    }
</style>

<script>
// Add SweetAlert2 dynamic loader to ensure availability
document.addEventListener('DOMContentLoaded', function() {
    if (typeof Swal === 'undefined') {
        // If SweetAlert is not defined, load it dynamically
        const sweetAlertScript = document.createElement('script');
        sweetAlertScript.src = 'https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js';
        document.head.appendChild(sweetAlertScript);
        
        // Add CSS
        const sweetAlertCSS = document.createElement('link');
        sweetAlertCSS.rel = 'stylesheet';
        sweetAlertCSS.href = 'https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.min.css';
        document.head.appendChild(sweetAlertCSS);
    }
});

// Automatically set the generated timestamp when the page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('Document loaded, initializing search functionality');
    
    // Set current date and time for generated timestamp
    const now = new Date();
    const formattedDateTime = now.toISOString().slice(0, 16); // Format: YYYY-MM-DDThh:mm
    document.getElementById('generated_timestamp').value = formattedDateTime;
    
    // Setup image uploads
    setupImageUploadHandlers();
    
    // Generate initial NOVR and PIN numbers
    generateNovrPinNumbers();
    
    // Initialize recalculate function to set initial state
    window.recalculateTotal();
    
    // Add event listener for vehicle type changes
    const vehicleTypeSelector = document.getElementById('vehicle_penalty_type');
    if (vehicleTypeSelector) {
        vehicleTypeSelector.addEventListener('change', function() {
            window.recalculateTotal();
        });
    }
});

// Function to generate NOVR and PIN numbers
function generateNovrPinNumbers() {
    // Get the current sequence number from localStorage or start from 0
    let currentSequence = parseInt(localStorage.getItem('novrPinSequence') || '0');
    
    // Increment the sequence number
    currentSequence++;
    
    // Format with leading zeros (e.g., 01, 02, 03, etc.)
    const generatedCode = currentSequence.toString().padStart(2, '0');
    
    // Store the updated sequence number for next time
    localStorage.setItem('novrPinSequence', currentSequence.toString());
    
    // Set both NOVR and PIN to the same value
    const novrField = document.getElementById('novr_number');
    const pinField = document.getElementById('pin_number');
    
    if (novrField && pinField) {
        novrField.value = generatedCode;
        pinField.value = generatedCode;
    }
    
    console.log(`Generated sequential number: ${generatedCode} (sequence: ${currentSequence})`);
}

// Setup additional image upload fields
function setupImageUploadHandlers() {
    setupSingleImageUpload('driverPhotoPreview', 'driver_photo');
    setupSingleImageUpload('platePhotoPreview', 'plate_photo');
    setupSingleImageUpload('secondaryPhotoPreview', 'secondary_photo');
}

function setupSingleImageUpload(previewId, inputId) {
    const preview = document.getElementById(previewId);
    const input = document.getElementById(inputId);
    
    if (!preview || !input) return;
    
    preview.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        input.click();
    });
    
    input.addEventListener('change', function(e) {
        if (this.files && this.files[0]) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                preview.innerHTML = `<img src="${e.target.result}" alt="Preview" style="width:100%;height:100%;object-fit:cover;">`;
                
                // Show success notification with SweetAlert
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        icon: 'success',
                        title: 'Image Uploaded',
                        text: 'Image preview is ready',
                        confirmButtonText: 'OK'
                    });
                }
            }
            
            reader.readAsDataURL(this.files[0]);
        }
    });
}

// Form validation - kept only one handler at the end, removed duplicates
const form = document.getElementById('violationForm');
form.addEventListener('submit', function(event) {
    event.preventDefault();  // Always prevent default submission
    
    if (!this.checkValidity()) {
        event.stopPropagation();
        
        // Show validation error with SweetAlert
        if (typeof Swal !== 'undefined') {
            Swal.fire({
                icon: 'error',
                title: 'Form Validation Error',
                text: 'Please complete all required fields correctly',
                confirmButtonText: 'OK'
            });
        }
        this.classList.add('was-validated');
        return;
    }
    
    // If form is valid, show confirmation dialog
    Swal.fire({
        title: 'Submit Violation',
        text: 'Do you want to upload this violation?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Submit and Print',
        cancelButtonText: 'Cancel',
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
    }).then((result) => {
        if (result.isConfirmed) {
            // Show a loading message
            Swal.fire({
                title: 'Processing Violation...',
                text: 'Please wait while we process your submission',
                allowOutsideClick: false,
                showConfirmButton: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            // Create FormData from the form
            const formData = new FormData(this);
            
            // Perform client-side validation
            let validationErrors = [];
            
            // Required fields
            const requiredFields = ['violation_type', 'location', 'violation_date', 'fine_amount'];
            requiredFields.forEach(field => {
                const value = formData.get(field);
                if (!value || value.trim() === '') {
                    validationErrors.push(`${field.replace('_', ' ')} is required`);
                    // Add visual indicator
                    const element = document.getElementById(field);
                    if (element) {
                        element.classList.add('is-invalid');
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'invalid-feedback';
                        errorDiv.textContent = 'This field is required';
                        element.parentNode.appendChild(errorDiv);
                    }
                }
            });
            
            // Validate fine amount is a number
            const fineAmount = formData.get('fine_amount');
            if (fineAmount && isNaN(parseFloat(fineAmount))) {
                validationErrors.push('Fine amount must be a valid number');
                const element = document.getElementById('fine_amount');
                if (element) {
                    element.classList.add('is-invalid');
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'invalid-feedback';
                    errorDiv.textContent = 'Please enter a valid number';
                    element.parentNode.appendChild(errorDiv);
                }
            }
            
            // If there are validation errors, show them and stop the submission
            if (validationErrors.length > 0) {
                Swal.fire({
                    icon: 'error',
                    title: 'Validation Error',
                    html: `<ul class="text-left"><li>${validationErrors.join('</li><li>')}</li></ul>`,
                    confirmButtonText: 'OK'
                });
                return; // Stop form submission
            }
            
            // Log the form data for debugging
            const formValues = {};
            for (let [key, value] of formData.entries()) {
                formValues[key] = value;
            }
            console.log('Form data being submitted:', formValues);
            
            // Show a loading indicator with a more detailed message
            Swal.fire({
                title: 'Processing Violation...',
                html: 'Uploading images and processing data. This may take a moment...',
                allowOutsideClick: false,
                showConfirmButton: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            // Submit the form via AJAX with a longer timeout
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 60000); // 60 second timeout
            
            fetch(this.action, {
                method: 'POST',
                body: formData,
                signal: controller.signal,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                credentials: 'same-origin'
            })
            .then(response => {
                clearTimeout(timeoutId); // Clear the timeout
                
                // Add a clearer log message for debugging
                console.log(`Server response status: ${response.status}, contentType: ${response.headers.get('content-type')}`);
                
                // Check content type to handle non-JSON responses
                const contentType = response.headers.get('content-type');
                
                // Handle error responses
                if (!response.ok) {
                    console.error(`Server error: ${response.status} ${response.statusText}`);
                    
                    // For HTML error responses (server error pages)
                    if (contentType && contentType.includes('text/html')) {
                        // Don't try to parse HTML as JSON, just throw a clear error
                        throw new Error('The server encountered an error processing your request. Please try again.');
                    }
                    
                    // For JSON error responses
                    if (contentType && contentType.includes('application/json')) {
                        return response.json().then(errorData => {
                            console.log('Error data from server:', errorData);
                            const errorMsg = errorData.message || `Error ${response.status}: ${response.statusText}`;
                            const errorDetails = errorData.details || '';
                            throw { message: errorMsg, details: errorDetails, type: 'server_validation' };
                        });
                    }
                    
                    // For other error types
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                
                // For successful responses, verify it's JSON
                if (!contentType || !contentType.includes('application/json')) {
                    console.error('Received non-JSON success response:', contentType);
                    throw new Error('The server did not return a valid JSON response.');
                }
                
                return response.json();
            })
            .then(data => {
                console.log('Success response:', data);
                
                if (data.success) {
                    // Show success message
                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: data.message,
                        confirmButtonText: 'OK'
                    }).then(() => {
                        // Open print preview in a new tab
                        if (data.violation_id) {
                            const printUrl = `/violation/${data.violation_id}/print/`;
                            window.open(printUrl, '_blank');
                        }
                        
                        // Redirect after confirmation
                        window.location.href = data.redirect_url;
                    });
                } else {
                    // Show error message with details if available
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.message || 'An error occurred while processing your request.',
                        confirmButtonText: 'OK',
                        footer: data.details ? `<span class="text-danger">${data.details}</span>` : ''
                    });
                }
            })
            .catch(error => {
                console.error('Error during form submission:', error);
                clearTimeout(timeoutId); // Clear the timeout if it hasn't fired yet
                
                // Provide more user-friendly error message based on error type
                let errorMessage = 'An error occurred while processing your request. Please try again.';
                let errorDetails = '';
                
                if (error.name === 'AbortError') {
                    errorMessage = 'The request took too long to complete and was canceled. This might be due to large image files or network issues.';
                    errorDetails = 'Try using smaller image files or check your internet connection.';
                } else if (error.message && error.message.includes('JSON')) {
                    errorMessage = 'The server returned an invalid response format. This might be a temporary issue.';
                    errorDetails = 'The server might be experiencing technical difficulties. Please try again later.';
                } else if (error.message && (error.message.includes('network') || error.name === 'TypeError' || error.message.includes('response was not ok'))) {
                    errorMessage = 'Network error. Please check your internet connection and try again.';
                    errorDetails = 'Your connection to the server was interrupted. Check your internet connection and make sure the server is running.';
                } else if (error.message && error.message.includes('HTML')) {
                    errorMessage = 'The server encountered an internal error. Please try again later.';
                    errorDetails = 'The system might be experiencing technical difficulties.';
                } else if (error.message && (error.message.includes('400') || error.message.includes('Bad Request'))) {
                    errorMessage = 'The server rejected your submission due to validation errors.';
                    errorDetails = 'Please check all required fields and ensure they contain valid data. Especially check the date, time, and fine amount fields.';
                } else if (error.type === 'server_validation') {
                    // For server validation errors returned as JSON
                    errorMessage = error.message;
                    errorDetails = error.details || 'Please verify all the information and try again.';
                    
                    // Special handling for violator information errors
                    if (error.message.includes('violator')) {
                        errorDetails = 'Check the license number format and ensure driver information is valid. If no license number is available, you can leave it blank.';
                    }
                }
                
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: errorMessage,
                    confirmButtonText: 'OK',
                    footer: errorDetails ? `<span class="text-danger">${errorDetails}</span>` : '<span class="text-muted">If this issue persists, please contact support.</span>',
                    didClose: () => {
                        // Provide an alternative form submission method if AJAX fails
                        const shouldSubmitDirectly = confirm("Would you like to try submitting the form directly instead? This may work better for large images or slow connections.");
                        if (shouldSubmitDirectly) {
                            // Create a hidden form and submit it traditionally
                            const directForm = document.createElement('form');
                            directForm.method = 'POST';
                            directForm.action = form.action;
                            directForm.enctype = 'multipart/form-data';
                            directForm.style.display = 'none';
                            
                            // Add CSRF token
                            const csrfToken = document.createElement('input');
                            csrfToken.type = 'hidden';
                            csrfToken.name = 'csrfmiddlewaretoken';
                            csrfToken.value = getCookie('csrftoken');
                            directForm.appendChild(csrfToken);
                            
                            // Show a loading message during the regular form submission
                            Swal.fire({
                                title: 'Submitting Form...',
                                text: 'Using traditional form submission. This may take a moment...',
                                allowOutsideClick: false,
                                showConfirmButton: false,
                                didOpen: () => {
                                    Swal.showLoading();
                                }
                            });
                            
                            // Copy all input elements from the original form
                            Array.from(form.elements).forEach(element => {
                                if (element.name && element.name !== 'csrfmiddlewaretoken') {
                                    if (element.type === 'file' && element.files.length > 0) {
                                        // File inputs can't be copied directly - we'll submit the original form instead
                                        console.log(`Skipping file input: ${element.name} (will use original form)`);
                                    } else if (element.type === 'checkbox' || element.type === 'radio') {
                                        if (element.checked) {
                                            const input = document.createElement('input');
                                            input.type = 'hidden';
                                            input.name = element.name;
                                            input.value = element.value;
                                            directForm.appendChild(input);
                                        }
                                    } else if (element.type !== 'button' && element.type !== 'submit') {
                                        const input = document.createElement('input');
                                        input.type = 'hidden';
                                        input.name = element.name;
                                        input.value = element.value;
                                        directForm.appendChild(input);
                                    }
                                }
                            });
                            
                            // For regular form submission, we'll use the original form with file inputs
                            // but disable AJAX handling
                            
                            // Disable our custom event handler
                            const oldListener = form.onsubmit;
                            form.onsubmit = null;
                            
                            // Submit the original form
                            document.body.appendChild(directForm);
                            form.submit();
                        }
                    }
                });
            });
        }
    });
    this.classList.add('was-validated');
});

// Make sure CSRF token is properly retrieved
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// License number format validation
document.getElementById('license_number').addEventListener('input', function(e) {
    this.value = this.value.toUpperCase();
    // Only validate if there's a value (since it's now optional)
    if (this.value.trim() === '') {
        this.setCustomValidity(''); // Empty value is valid
    } else if (!this.value.match(/^[A-Z0-9]{3}-[0-9]{2}-[0-9]{6}$/)) {
        this.setCustomValidity('Please use the format: XXX-XX-XXXXXX');
    } else {
        this.setCustomValidity('');
    }
});

// Recalculate total based on vehicle type and multipliers
window.recalculateTotal = function() {
    console.log("[DEBUG] recalculateTotal called");
    
    // Get vehicle type rate
    let ratePerViolation = 0;
    const vehicleTypeSelector = document.getElementById('vehicle_penalty_type');
    const finalAmountDisplay = document.getElementById('final_amount_display');
    const tdzMultiplierInfo = document.getElementById('tdz_multiplier_info');
    const vehicleInfoSection = document.getElementById('vehicle_information_section');
    const operatorDetailsSection = document.getElementById('operator_details_section');
    const fineAmountInput = document.getElementById('fine_amount');
    const tdzViolationCheckbox = document.getElementById('is_tdz_violation');
    
    // Verify TDZ checkbox state
    const isTdzChecked = tdzViolationCheckbox ? tdzViolationCheckbox.checked : false;
    console.log("[DEBUG] TDZ checkbox state:", isTdzChecked, tdzViolationCheckbox);
    
    // Get access to selectedViolations array
    const selectedViolations = window.selectedViolations || [];
    
    if (vehicleTypeSelector && vehicleTypeSelector.value) {
        if (vehicleTypeSelector.value === 'potpot') {
            ratePerViolation = 50; // ₱50 for Pot-Pot vehicles
            // Hide vehicle information section for Pot-Pot vehicles
            if (vehicleInfoSection) {
                vehicleInfoSection.style.display = 'none';
            }
            // Show operator details section for Pot-Pot vehicles
            if (operatorDetailsSection) {
                operatorDetailsSection.style.display = 'block';
                console.log("[DEBUG] Showing operator details for Pot-Pot vehicle");
            }
        } else if (vehicleTypeSelector.value === 'regular') {
            ratePerViolation = 300; // ₱300 for regular vehicles
            // Show vehicle information section for regular vehicles
            if (vehicleInfoSection) {
                vehicleInfoSection.style.display = 'block';
            }
            // Hide operator details section for regular vehicles
            if (operatorDetailsSection) {
                operatorDetailsSection.style.display = 'none';
                console.log("[DEBUG] Hiding operator details for Regular vehicle");
            }
        }
    }
    
    // Count total violations
    const violationCount = selectedViolations.length;
    
    // Calculate base total (rate * number of violations)
    let baseTotal = ratePerViolation * violationCount;
    console.log("[DEBUG] Base total before TDZ:", baseTotal);
    
    // Update rates in the table rows if vehicle type changed
    selectedViolations.forEach(violation => {
        violation.rate = ratePerViolation;
        const row = document.getElementById(violation.id);
        if (row) {
            const rateCell = row.querySelector('td:nth-child(2)');
            if (rateCell) {
                rateCell.textContent = `₱${ratePerViolation.toFixed(2)}`;
            }
        }
    });
    
    // Apply TDZ multiplier if checked (double the penalty)
    if (isTdzChecked) {
        baseTotal *= 2; // Double the penalty in Traffic Discipline Zones
        console.log("[DEBUG] Applied TDZ multiplier, new total:", baseTotal);
        if (tdzMultiplierInfo) {
            tdzMultiplierInfo.style.display = 'block';
        }
    } else {
        if (tdzMultiplierInfo) {
            tdzMultiplierInfo.style.display = 'none';
        }
    }
    
    // Update the fine amount input
    if (fineAmountInput) {
        fineAmountInput.value = baseTotal.toFixed(2);
        console.log("[DEBUG] Updated fine amount input:", fineAmountInput.value);
    }
    
    // Update the final amount display
    if (finalAmountDisplay) {
        finalAmountDisplay.textContent = baseTotal.toFixed(2);
        console.log("[DEBUG] Updated final amount display:", finalAmountDisplay.textContent);
    }
    
    return baseTotal;
};

// Operator and Driver Search Functionality
document.addEventListener('DOMContentLoaded', function() {
    console.log('Document loaded, initializing search functionality');
    
    // Get element references for search functionality
    const operatorSearch = document.getElementById('operatorSearch');
    const driverSearch = document.getElementById('driverSearch');
    const operatorResults = document.getElementById('operatorResults');
    const driverResults = document.getElementById('driverResults');
    const searchOperatorBtn = document.getElementById('searchOperatorBtn');
    const searchDriverBtn = document.getElementById('searchDriverBtn');
    
    // Selected IDs
    const selectedOperatorId = document.getElementById('selectedOperatorId');
    const selectedDriverId = document.getElementById('selectedDriverId');
    
    // Form fields
    const driverNameField = document.getElementById('driver_name');
    const pdNumberField = document.getElementById('pd_number');
    const licenseNumberField = document.getElementById('license_number');
    const driverAddressField = document.getElementById('driver_address');
    const potpotNumberField = document.getElementById('potpot_number');
    const operatorAddressField = document.getElementById('operator_address');
    
    // Log all form fields to verify they're being found
    console.log('Initialized form fields:', {
        operatorSearch: operatorSearch,
        driverSearch: driverSearch,
        operatorResults: operatorResults,
        driverResults: driverResults,
        searchOperatorBtn: searchOperatorBtn,
        searchDriverBtn: searchDriverBtn,
        selectedOperatorId: selectedOperatorId,
        selectedDriverId: selectedDriverId,
        driverNameField: driverNameField,
        pdNumberField: pdNumberField,
        licenseNumberField: licenseNumberField,
        driverAddressField: driverAddressField,
        potpotNumberField: potpotNumberField,
        operatorAddressField: operatorAddressField
    });
    
    // Also check for vehicle form fields
    const vehicleFields = {
        plateNumber: document.getElementById('plate_number'),
        vehicleType: document.getElementById('vehicle_type'),
        color: document.getElementById('color'),
        classification: document.getElementById('classification')
    };
    console.log('Vehicle form fields:', vehicleFields);
    
    // Search for operators
    searchOperatorBtn.addEventListener('click', () => {
        const query = operatorSearch.value.trim();
        if (query.length === 0) {
            return;
        }
        
        console.log(`Searching for operators with query: "${query}"`);
        
        fetch(`/api/search-operators/?q=${encodeURIComponent(query)}`)
            .then(response => {
                console.log('Search response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log(`Found ${data.length} operators matching query:`, data);
                operatorResults.innerHTML = '';
                operatorResults.style.display = 'block';
                
                if (data.length === 0) {
                    operatorResults.innerHTML = `
                        <div class="empty-state">
                            <span class="material-icons">search_off</span>
                            <p>No operators found matching "${query}"</p>
                            <small>Try using different keywords or check for typos</small>
                        </div>`;
                    return;
                }
                
                data.forEach(operator => {
                    const resultItem = document.createElement('div');
                    resultItem.className = 'search-result-item';
                    
                    // Show PO number with special highlight if it's available
                    const poNumberDisplay = operator.po_number ? 
                        `<div class="badge bg-success">PO: ${operator.po_number}</div>` :
                        '';
                    
                    // Highlight if the query matches the PO number
                    const isPOMatch = operator.po_number && query === operator.po_number;
                    if (isPOMatch) {
                        resultItem.classList.add('po-match-highlight');
                    }
                    
                    resultItem.innerHTML = `
                        <div class="item-name">${operator.last_name}, ${operator.first_name}</div>
                        <div class="d-flex mt-1 mb-1">
                            <div class="badge bg-primary me-2">PD: ${operator.new_pd_number || 'N/A'}</div>
                            ${operator.old_pd_number ? `<div class="badge bg-secondary me-2">Old PD: ${operator.old_pd_number}</div>` : ''}
                            ${poNumberDisplay}
                        </div>
                        <div class="item-details text-muted small">Address: ${operator.address || 'No address available'}</div>
                        ${isPOMatch ? '<div class="matched-po-alert">✓ Exact PO Number Match!</div>' : ''}
                    `;
                    
                    // Add click event to select operator
                    resultItem.addEventListener('click', () => {
                        selectOperator(operator);
                    });
                    
                    operatorResults.appendChild(resultItem);
                });
                
                // Add a helpful debug message
                const debugInfo = document.createElement('div');
                debugInfo.className = 'search-debug-info p-2 text-muted border-top mt-2';
                debugInfo.innerHTML = `
                    <small>Debug: Found ${data.length} operators for query "${query}"</small>
                    <button class="btn btn-sm btn-link p-0 ms-2" id="showOperatorDetailsBtn">Show Details</button>
                `;
                operatorResults.appendChild(debugInfo);
                
                // Add event listener for the Show Details button
                document.getElementById('showOperatorDetailsBtn').addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.table(data);
                    
                    // Create a modal with the detailed data
                    const detailsHtml = data.map(op => `
                        <tr>
                            <td>${op.id}</td>
                            <td>${op.last_name}, ${op.first_name}</td>
                            <td>${op.new_pd_number || 'N/A'}</td>
                            <td>${op.old_pd_number || 'N/A'}</td>
                            <td>${op.po_number || 'N/A'}</td>
                        </tr>
                    `).join('');
                    
                    Swal.fire({
                        title: 'Operator Search Details',
                        html: `
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Name</th>
                                            <th>PD Number</th>
                                            <th>Old PD</th>
                                            <th>PO Number</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${detailsHtml}
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-3">
                                <small class="text-muted">Query: "${query}"</small>
                            </div>
                        `,
                        width: '800px',
                    });
                });
            })
            .catch(error => {
                console.error('Error searching operators:', error);
                operatorResults.innerHTML = `
                    <div class="empty-state">
                        <span class="material-icons">error_outline</span>
                        <p>Error searching operators</p>
                        <small>Please try again or check your connection</small>
                    </div>`;
                operatorResults.style.display = 'block';
                
                // Show error with SweetAlert
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        icon: 'error',
                        title: 'Search Error',
                        text: 'Failed to search operators. Please try again.',
                        confirmButtonText: 'OK'
                    });
                }
            });
    });
    
    // Search for drivers
    searchDriverBtn.addEventListener('click', () => {
        const query = driverSearch.value.trim();
        if (query.length === 0) {
            return;
        }
        
        console.log(`Searching for drivers with query: "${query}"`);
        
        fetch(`/api/search-drivers/?q=${encodeURIComponent(query)}`)
            .then(response => {
                console.log('Driver search response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log(`Found ${data.length} drivers matching query:`, data);
                driverResults.innerHTML = '';
                driverResults.style.display = 'block';
                
                if (data.length === 0) {
                    driverResults.innerHTML = `
                        <div class="empty-state">
                            <span class="material-icons">search_off</span>
                            <p>No drivers found matching "${query}"</p>
                            <small>Try using different keywords or check for typos</small>
                        </div>`;
                    return;
                }
                
                data.forEach(driver => {
                    const resultItem = document.createElement('div');
                    resultItem.className = 'search-result-item';
                    resultItem.innerHTML = `
                        <div class="item-name">${driver.last_name}, ${driver.first_name}</div>
                        <div class="d-flex mt-1 mb-1">
                            <div class="badge bg-primary me-2">PD: ${driver.new_pd_number || 'N/A'}</div>
                            ${driver.old_pd_number ? `<div class="badge bg-secondary">Old PD: ${driver.old_pd_number}</div>` : ''}
                        </div>
                        <div class="item-details text-muted small">Address: ${driver.address || 'No address available'}</div>
                    `;
                    
                    // Add click event to select driver
                    resultItem.addEventListener('click', () => {
                        selectDriver(driver);
                    });
                    
                    driverResults.appendChild(resultItem);
                });
                
                // Add a helpful debug message
                const debugInfo = document.createElement('div');
                debugInfo.className = 'search-debug-info p-2 text-muted border-top mt-2';
                debugInfo.innerHTML = `<small>Debug: Found ${data.length} drivers for query "${query}"</small>`;
                driverResults.appendChild(debugInfo);
            })
            .catch(error => {
                console.error('Error searching drivers:', error);
                driverResults.innerHTML = `
                    <div class="empty-state">
                        <span class="material-icons">error_outline</span>
                        <p>Error searching drivers</p>
                        <small>Please try again or check your connection</small>
                    </div>`;
                driverResults.style.display = 'block';
                
                // Show error with SweetAlert
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        icon: 'error',
                        title: 'Search Error',
                        text: 'Failed to search drivers. Please try again.',
                        confirmButtonText: 'OK'
                    });
                }
            });
    });
    
    // Select operator and populate fields
    function selectOperator(operator) {
        // Debug the operator object to see all available properties
        console.log('DEBUG OPERATOR OBJECT:', operator);
        
        // Set selected operator ID
        selectedOperatorId.value = operator.id;
        
        // Update the search field
        operatorSearch.value = `${operator.new_pd_number} - ${operator.last_name}, ${operator.first_name}`;
        
        // Highlight the selected item and close results
        const items = operatorResults.querySelectorAll('.search-result-item');
        items.forEach(item => item.classList.remove('item-selected'));
        operatorResults.style.display = 'none';
        
        // Show auto-populated indicator
        const autoPopulatedBadge = document.getElementById('operator_auto_populated');
        if (autoPopulatedBadge) {
            autoPopulatedBadge.style.display = 'inline-block';
        }
        
        // Highlight the operator section
        const operatorSection = document.getElementById('operator_details_section');
        if (operatorSection) {
            operatorSection.classList.add('border-success');
            operatorSection.style.borderLeft = '4px solid #198754';
            
            // Remove the highlight after 3 seconds
            setTimeout(() => {
                operatorSection.classList.remove('border-success');
                operatorSection.style.borderLeft = '';
            }, 3000);
        }
        
        // Populate only operator-related fields
        // Do NOT populate driver fields
        
        // Always populate operator address field if it exists
        const operatorAddressField = document.getElementById('operator_address');
        if (operatorAddressField) {
            operatorAddressField.value = operator.address || '';
            operatorAddressField.dispatchEvent(new Event('input', { bubbles: true }));
            operatorAddressField.dispatchEvent(new Event('change', { bubbles: true }));
            operatorAddressField.classList.add('is-valid');
        }
        
        // Populate operator name field if it exists
        const operatorNameField = document.getElementById('operator_name');
        if (operatorNameField) {
            const fullName = `${operator.first_name} ${operator.middle_initial ? operator.middle_initial + ' ' : ''}${operator.last_name}`;
            operatorNameField.value = fullName;
            operatorNameField.dispatchEvent(new Event('input', { bubbles: true }));
            operatorNameField.dispatchEvent(new Event('change', { bubbles: true }));
            operatorNameField.classList.add('is-valid');
        }
        
        // Populate potpot number field
        const potpotNumberField = document.getElementById('potpot_number');
        if (potpotNumberField) {
            potpotNumberField.value = operator.potpot_number || '';
            potpotNumberField.dispatchEvent(new Event('input', { bubbles: true }));
            potpotNumberField.dispatchEvent(new Event('change', { bubbles: true }));
            potpotNumberField.classList.add('is-valid');
        }
        
        // Populate PD Number in the operator section if it exists
        const operatorPdNumberField = document.getElementById('operator_pd_number');
        if (operatorPdNumberField) {
            // Try all possible property names for PO number
            const poNumber = operator.po_number || operator.new_pd_number || operator.pd_number || '';
            console.log('DEBUGGING PO NUMBER FIELD:');
            console.log('- operator.po_number:', operator.po_number);
            console.log('- operator.new_pd_number:', operator.new_pd_number);
            console.log('- operator.pd_number:', operator.pd_number);
            console.log('- Field element found:', operatorPdNumberField ? 'YES' : 'NO');
            console.log('- Field ID:', operatorPdNumberField ? operatorPdNumberField.id : 'N/A');
            
            // Set the value and trigger events
            operatorPdNumberField.value = poNumber;
            console.log('- Setting field value to:', poNumber);
            operatorPdNumberField.dispatchEvent(new Event('input', { bubbles: true }));
            operatorPdNumberField.dispatchEvent(new Event('change', { bubbles: true }));
            operatorPdNumberField.classList.add('is-valid');
            
            // Force the value again after a slight delay (sometimes needed for certain frameworks)
            setTimeout(() => {
                operatorPdNumberField.value = poNumber;
                console.log('- Re-setting field value after delay to:', poNumber);
            }, 100);
            
            // Add visual feedback for PO number
            if (poNumber) {
                // Add visual indicator that PO number was populated
                const feedbackElement = document.createElement('div');
                feedbackElement.className = 'valid-feedback d-block';
                feedbackElement.textContent = 'PO Number auto-populated';
                feedbackElement.style.color = '#198754';
                feedbackElement.style.fontSize = '0.8rem';
                
                // Remove any existing feedback
                const existingFeedback = operatorPdNumberField.parentNode.querySelector('.valid-feedback');
                if (existingFeedback) {
                    existingFeedback.remove();
                }
                
                // Insert the feedback after the field
                const parentElement = operatorPdNumberField.closest('.form-floating');
                if (parentElement) {
                    parentElement.appendChild(feedbackElement);
                }
            }
        } else {
            console.error('ERROR: operator_pd_number field not found in the DOM!');
            
            // Try to find the field by other means
            const allInputs = document.querySelectorAll('input');
            console.log('All input fields:', allInputs.length);
            allInputs.forEach((input, index) => {
                if (input.id.toLowerCase().includes('po') || input.id.toLowerCase().includes('pd') || 
                    input.name.toLowerCase().includes('po') || input.name.toLowerCase().includes('pd')) {
                    console.log(`Found potential PO/PD field: id=${input.id}, name=${input.name}, index=${index}`);
                }
            });
        }
        
        // Show success notification with SweetAlert
        if (typeof Swal !== 'undefined') {
            Swal.fire({
                icon: 'success',
                title: 'Operator Selected',
                text: 'Operator information loaded successfully!',
                toast: true,
                position: 'bottom-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true
            });
        }
    }
    
    // Select driver and populate fields
    function selectDriver(driver) {
        // Set selected driver ID
        selectedDriverId.value = driver.id;
        
        // Update the search field
        driverSearch.value = `${driver.new_pd_number} - ${driver.last_name}, ${driver.first_name}`;
        
        // Highlight the selected item and close results
        const items = driverResults.querySelectorAll('.search-result-item');
        items.forEach(item => item.classList.remove('item-selected'));
        driverResults.style.display = 'none';
        
        // Show auto-populated indicator
        const autoPopulatedBadge = document.getElementById('driver_auto_populated');
        if (autoPopulatedBadge) {
            autoPopulatedBadge.style.display = 'inline-block';
        }
        
        // Highlight the driver section
        const driverSection = document.getElementById('driver_details_section');
        if (driverSection) {
            driverSection.classList.add('border-success');
            driverSection.style.borderLeft = '4px solid #198754';
            
            // Remove the highlight after 3 seconds
            setTimeout(() => {
                driverSection.classList.remove('border-success');
                driverSection.style.borderLeft = '';
            }, 3000);
        }
        
        // ALWAYS populate the driver's name field
        const driverNameField = document.getElementById('driver_name');
        if (driverNameField) {
            // Force update the field with the driver's name
            const fullName = `${driver.first_name} ${driver.middle_initial ? driver.middle_initial + ' ' : ''}${driver.last_name}`;
            driverNameField.value = fullName;
            driverNameField.dispatchEvent(new Event('input', { bubbles: true }));
            driverNameField.dispatchEvent(new Event('change', { bubbles: true }));
            driverNameField.classList.add('is-valid');
        }
        
        // Populate PD number field if it exists
        const pdNumberField = document.getElementById('pd_number');
        if (pdNumberField) {
            pdNumberField.value = driver.new_pd_number || '';
            pdNumberField.dispatchEvent(new Event('input', { bubbles: true }));
            pdNumberField.dispatchEvent(new Event('change', { bubbles: true }));
            pdNumberField.classList.add('is-valid');
        }
        
        // Populate license number field if it exists
        const licenseNumberField = document.getElementById('license_number');
        if (licenseNumberField) {
            licenseNumberField.value = driver.license_number || '';
            licenseNumberField.dispatchEvent(new Event('input', { bubbles: true }));
            licenseNumberField.dispatchEvent(new Event('change', { bubbles: true }));
            licenseNumberField.classList.add('is-valid');
        }
        
        // Always populate driver address field if it exists
        const driverAddressField = document.getElementById('driver_address');
        if (driverAddressField) {
            driverAddressField.value = driver.address || '';
            driverAddressField.dispatchEvent(new Event('input', { bubbles: true }));
            driverAddressField.dispatchEvent(new Event('change', { bubbles: true }));
            driverAddressField.classList.add('is-valid');
        }
        
        // Show success notification with SweetAlert
        if (typeof Swal !== 'undefined') {
            Swal.fire({
                icon: 'success',
                title: 'Driver Selected',
                text: 'Driver information loaded successfully!',
                toast: true,
                position: 'bottom-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true
            });
        }
    }
    
    // Close result containers when clicking outside
    document.addEventListener('click', (event) => {
        if (!operatorSearch.contains(event.target) && !operatorResults.contains(event.target) && !searchOperatorBtn.contains(event.target)) {
            operatorResults.style.display = 'none';
        }
        if (!driverSearch.contains(event.target) && !driverResults.contains(event.target) && !searchDriverBtn.contains(event.target)) {
            driverResults.style.display = 'none';
        }
    });
    
    // Input event listeners for autocomplete
    operatorSearch.addEventListener('input', debounce(() => {
        if (operatorSearch.value.trim().length > 0) {
            searchOperatorBtn.click();
        } else {
            operatorResults.style.display = 'none';
        }
    }, 300));
    
    driverSearch.addEventListener('input', debounce(() => {
        if (driverSearch.value.trim().length > 0) {
            searchDriverBtn.click();
        } else {
            driverResults.style.display = 'none';
        }
    }, 300));
    
    // Helper function to debounce inputs
    function debounce(func, wait) {
        let timeout;
        return function() {
            const context = this;
            const args = arguments;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), wait);
        };
    }
    
    // Show success message (kept as fallback)
    function showSuccessMessage(message) {
        // Create alert element
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-success alert-dismissible fade show';
        alertDiv.role = 'alert';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        // Insert at top of form
        const form = document.getElementById('violationForm');
        form.insertBefore(alertDiv, form.firstChild);
        
        // Auto-dismiss after 3 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.parentNode.removeChild(alertDiv);
            }
        }, 3000);
    }
});

// JavaScript for Multiple Violations Selection and Calculation
document.addEventListener('DOMContentLoaded', function() {
    console.log('[PENALTY] DOM loaded - initializing penalty calculator');
    
    // Core elements needed for calculation
    const fineAmountInput = document.getElementById('fine_amount');
    const finalAmountDisplay = document.getElementById('final_amount_display');
    const tdzViolationCheckbox = document.getElementById('is_tdz_violation');
    const vehicleTypeSelector = document.getElementById('vehicle_penalty_type');
    const violationTypeInput = document.getElementById('violation_type');
    const violationPenaltiesInput = document.getElementById('violation_penalties');
    const selectedViolationsBody = document.getElementById('selected_violations_body');
    const vehicleInfoSection = document.getElementById('vehicle_information_section');
    const operatorDetailsSection = document.getElementById('operator_details_section');
    const potpotNumberField = document.getElementById('potpot_number');
    const operatorAddressField = document.getElementById('operator_address');
    
    // Setup initial visibility based on default selection
    if (vehicleTypeSelector) {
        // If no vehicle type is selected on page load or vehicle type is 'regular',
        // hide the operator details section by default
        if (!vehicleTypeSelector.value || vehicleTypeSelector.value === 'regular') {
            if (operatorDetailsSection) {
                operatorDetailsSection.style.display = 'none';
                // Clear operator fields when hidden
                if (potpotNumberField) potpotNumberField.value = '';
                if (operatorAddressField) operatorAddressField.value = '';
            }
        }
        
        // Add explicit handler for vehicle type changes
        vehicleTypeSelector.addEventListener('change', function() {
            console.log('[PENALTY] Vehicle type changed to:', this.value);
            
            // Toggle operator details section visibility
            if (operatorDetailsSection) {
                if (this.value === 'regular') {
                    operatorDetailsSection.style.display = 'none';
                    // Clear operator fields when hidden
                    if (potpotNumberField) potpotNumberField.value = '';
                    if (operatorAddressField) operatorAddressField.value = '';
                } else if (this.value === 'potpot') {
                    operatorDetailsSection.style.display = 'block';
                }
            }
            
            // Toggle vehicle information section visibility
            if (vehicleInfoSection) {
                if (this.value === 'regular') {
                    vehicleInfoSection.style.display = 'block';
                } else if (this.value === 'potpot') {
                    vehicleInfoSection.style.display = 'none';
                }
            }
            
            // Recalculate the penalty with the new vehicle type
            calculatePenalty();
            
            // Update the visual display of rates in the violation table
            updateViolationRatesDisplay();
        });
    }
    
    // Initialize the violation storage - now with the originalRate field to store database rate
    window.violationTracker = {
        items: [],
        addViolation: function(text, originalRate) {
            const id = 'violation_' + Date.now();
            // Store both the original database rate and the adjusted rate (initialized as the same)
            this.items.push({id, text, originalRate, rate: originalRate});
            return id;
        },
        removeViolation: function(id) {
            const index = this.items.findIndex(v => v.id === id);
            if (index !== -1) {
                this.items.splice(index, 1);
                return true;
            }
            return false;
        },
        getViolations: function() {
            return this.items;
        },
        getCount: function() {
            return this.items.length;
        },
        // Apply vehicle type rate adjustment to all violations
        updateRates: function(vehicleType) {
            this.items.forEach(v => {
                if (vehicleType === 'potpot') {
                    // For potpot vehicles, use the actual amount from the violation type model
                    v.rate = v.originalRate;
                } else {
                    // For regular vehicles, always override to 300
                    v.rate = 300;
                }
            });
        },
        getTotal: function() {
            return this.items.reduce((sum, v) => sum + parseFloat(v.rate), 0);
        }
    };
    
    // Function to update the display of rates in the table based on vehicle type
    function updateViolationRatesDisplay() {
        const vehicleType = vehicleTypeSelector ? vehicleTypeSelector.value : 'regular';
        const violations = window.violationTracker.getViolations();
        
        // Update all rates based on the vehicle type
        window.violationTracker.updateRates(vehicleType);
        
        // Update the displayed rates in the table
        violations.forEach(violation => {
            const row = document.getElementById(violation.id);
            if (row) {
                const rateCell = row.querySelector('td:nth-child(2)');
                if (rateCell) {
                    rateCell.textContent = `₱${parseFloat(violation.rate).toFixed(2)}`;
                }
            }
        });
    }
    
    // Create a standalone function to calculate and update the penalty
    function calculatePenalty() {
        console.log('[PENALTY] Calculating penalty');
        
        // Get values
        const vehicleType = vehicleTypeSelector ? vehicleTypeSelector.value : 'regular';
        const isTdzViolation = tdzViolationCheckbox && tdzViolationCheckbox.checked;
        const violations = window.violationTracker.getViolations();
        
        console.log('[PENALTY] Inputs:', {
            vehicleType,
            isTdzViolation,
            violationCount: violations.length
        });
        
        // Update all violation rates based on vehicle type
        window.violationTracker.updateRates(vehicleType);
        
        // Calculate total based on the adjusted rates
        let totalPenalty = window.violationTracker.getTotal();
        console.log('[PENALTY] Base penalty before TDZ:', totalPenalty);
        
        // Apply TDZ multiplier
        if (isTdzViolation) {
            // Explicitly double the amount
            totalPenalty = totalPenalty * 2;
            console.log('[PENALTY] TDZ is checked - DOUBLING penalty from', totalPenalty/2, 'to', totalPenalty);
            
            if (document.getElementById('tdz_multiplier_info')) {
                document.getElementById('tdz_multiplier_info').style.display = 'block';
            }
        } else {
            console.log('[PENALTY] TDZ is NOT checked - keeping original penalty:', totalPenalty);
            if (document.getElementById('tdz_multiplier_info')) {
                document.getElementById('tdz_multiplier_info').style.display = 'none';
            }
        }
        
        console.log('[PENALTY] Final calculated amount:', totalPenalty);
        
        // Update UI
        if (fineAmountInput) {
            fineAmountInput.value = totalPenalty.toFixed(2);
            console.log('[PENALTY] Updated fineAmountInput:', fineAmountInput.value);
        }
        
        if (finalAmountDisplay) {
            finalAmountDisplay.textContent = totalPenalty.toFixed(2);
            console.log('[PENALTY] Updated finalAmountDisplay:', finalAmountDisplay.textContent);
        }
        
        return totalPenalty;
    }
    
    // Set our calculator as the global recalculateTotal
    window.recalculateTotal = calculatePenalty;
    
    // Attach event listeners
    if (vehicleTypeSelector) {
        vehicleTypeSelector.addEventListener('change', function() {
            console.log('[PENALTY] Vehicle type changed to:', this.value);
            calculatePenalty();
        });
    }
    
    if (tdzViolationCheckbox) {
        // Remove the inline event handlers to prevent double-firing
        tdzViolationCheckbox.removeAttribute('onchange');
        tdzViolationCheckbox.removeAttribute('onclick');
        
        // Add our own event listener
        tdzViolationCheckbox.addEventListener('change', function() {
            console.log('[PENALTY] TDZ checkbox changed to:', this.checked);
            // Force recalculation and double the penalty if checked
            calculatePenalty();
        });
        
        // Add click handler to debug
        tdzViolationCheckbox.addEventListener('click', function() {
            console.log('[PENALTY] TDZ checkbox clicked, state after click will be:', !this.checked);
        });
    } else {
        console.warn('[PENALTY] TDZ checkbox not found! This will prevent the TDZ multiplier from working.');
    }
    
    // Run the initial calculation after a short delay
    setTimeout(function() {
        console.log('[PENALTY] Running initial calculation');
        calculatePenalty();
    }, 300);
    
    // Override the violation add/remove functions
    window.addViolation = function() {
        console.log('[DEBUG] Adding violation');
        // Get selected violation from the selector
        const violationSelector = document.getElementById('violation_selector');
        const selectedOption = violationSelector.options[violationSelector.selectedIndex];
        
        if (!selectedOption || violationSelector.selectedIndex === 0) {
            // Show error if no violation type is selected
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: 'error',
                    title: 'No Violation Selected',
                    text: 'Please select a violation type to add.',
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3000
                });
            }
            return;
        }
        
        const violationText = selectedOption.text;
        
        // Check if this violation is already in the list
        const existingViolations = window.violationTracker.getViolations();
        const isDuplicate = existingViolations.some(v => v.text === violationText);
        
        if (isDuplicate) {
            // Show error if violation is already added
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: 'warning',
                    title: 'Duplicate Violation',
                    text: 'This violation has already been added to the list.',
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3000
                });
            }
            
            // Reset selector
            violationSelector.selectedIndex = 0;
            return;
        }
        
        const violationTypeInput = document.getElementById('violation_type');
        const violationPenaltiesInput = document.getElementById('violation_penalties');
        const selectedViolationsBody = document.getElementById('selected_violations_body');
        
        console.log('[DEBUG] Selected violation text:', violationText);
        
        // Get the original amount directly from the data attribute
        let originalRate = parseFloat(selectedOption.dataset.amount || 0);
        if (isNaN(originalRate)) {
            originalRate = 0;
        }
        
        // Add to tracker with the original database rate
        const violationId = window.violationTracker.addViolation(violationText, originalRate);
        
        // Apply vehicle type adjustment to the newly added violation
        const vehicleType = vehicleTypeSelector ? vehicleTypeSelector.value : 'regular';
        window.violationTracker.updateRates(vehicleType);
        
        // Get the adjusted rate for display
        const violation = window.violationTracker.getViolations().find(v => v.id === violationId);
        const adjustedRate = violation ? violation.rate : originalRate;
        
        console.log('[DEBUG] Added violation:', violationText, 'with originalRate:', originalRate, 'adjustedRate:', adjustedRate, 'ID:', violationId);
        
        // Hide the "no violations" row if it's visible
        const noViolationsRow = document.getElementById('no_violations_row');
        if (noViolationsRow && noViolationsRow.style.display !== 'none') {
            noViolationsRow.style.display = 'none';
        }
        
        // Create new row
        const newRow = document.createElement('tr');
        newRow.id = violationId;
        newRow.innerHTML = `
            <td>${violationText}</td>
            <td>₱${parseFloat(adjustedRate).toFixed(2)}</td>
            <td>
                <button type="button" class="btn btn-sm btn-danger" onclick="removeViolation('${violationId}')">
                    <i class="fas fa-trash-alt"></i> Remove
                </button>
            </td>
        `;
        
        // Add to table
        if (selectedViolationsBody) {
            selectedViolationsBody.appendChild(newRow);
        }
        
        // Reset selector
        violationSelector.selectedIndex = 0;
        
        // Update count display
        const countDisplay = document.getElementById('count_display');
        if (countDisplay) {
            countDisplay.textContent = `${window.violationTracker.getCount()} violation(s)`;
        }
        
        // Update form values
        if (violationTypeInput) {
            const violationTexts = window.violationTracker.getViolations().map(v => v.text);
            console.log('[DEBUG] All violation texts:', violationTexts);
            violationTypeInput.value = violationTexts.join(', ');
            console.log('[DEBUG] Set violation_type field to:', violationTypeInput.value);
        }
        
        if (violationPenaltiesInput) {
            const jsonData = JSON.stringify(window.violationTracker.getViolations());
            console.log('[DEBUG] Violation penalties JSON:', jsonData);
            violationPenaltiesInput.value = jsonData;
        }
        
        // Recalculate total
        calculatePenalty();
        
        // Show success notification
        if (typeof Swal !== 'undefined') {
            Swal.fire({
                icon: 'success',
                title: 'Violation Added',
                text: 'Violation has been added to the list.',
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 2000
            });
        }
    };
    
    window.removeViolation = function(violationId) {
        console.log('[PENALTY] Removing violation:', violationId);
        
        if (window.violationTracker.removeViolation(violationId)) {
            // Remove from table
            const rowToRemove = document.getElementById(violationId);
            if (rowToRemove) {
                rowToRemove.remove();
            }
            
            // Show "no violations" row if no violations are left
            const noViolationsRow = document.getElementById('no_violations_row');
            if (window.violationTracker.getCount() === 0 && noViolationsRow) {
                noViolationsRow.style.display = '';
            }
            
            // Update count display
            const countDisplay = document.getElementById('count_display');
            if (countDisplay) {
                countDisplay.textContent = `${window.violationTracker.getCount()} violation(s)`;
            }
            
            // Update form values
            if (violationTypeInput) {
                violationTypeInput.value = window.violationTracker.getViolations().map(v => v.text).join(', ');
            }
            
            if (violationPenaltiesInput) {
                violationPenaltiesInput.value = JSON.stringify(window.violationTracker.getViolations());
            }
            
            // Recalculate total
            calculatePenalty();
            
            // Show success notification
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: 'success',
                    title: 'Violation Removed',
                    text: 'Violation has been removed from the list.',
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 2000
                });
            }
        }
    };
    
    // Connect add button to the addViolation function
    const addViolationBtn = document.getElementById('add_violation_btn');
    if (addViolationBtn) {
        addViolationBtn.addEventListener('click', window.addViolation);
        console.log('[PENALTY] Connected add violation button');
    } else {
        console.warn('[PENALTY] Add violation button not found!');
    }
    
    console.log('[PENALTY] Initialization complete');
});

function recalculateTotal() {
    var vehicleType = document.getElementById('vehicle_penalty_type').value;
    
    // Instead of hardcoded values, use the violation rates from the selected violations
    if (vehicleType === 'regular') {
        // Show vehicle information section and hide operator details for regular vehicles
        document.getElementById('vehicle_information_section').style.display = 'block';
        document.getElementById('operator_details_section').style.display = 'none';
    } else if (vehicleType === 'potpot') {
        // Hide vehicle information section and show operator details for potpot vehicles
        document.getElementById('vehicle_information_section').style.display = 'none';
        document.getElementById('operator_details_section').style.display = 'block';
    }
    
    // Calculate final amount using the violation tracker
    var finalAmount = window.violationTracker ? window.violationTracker.getTotal() : 0;
    
    // Apply TDZ multiplier if checked
    if (document.getElementById('is_tdz_violation').checked) {
        finalAmount *= 2;
        document.getElementById('tdz_multiplier_info').style.display = 'block';
    } else {
        document.getElementById('tdz_multiplier_info').style.display = 'none';
    }
    
    // Update the displayed amounts
    document.getElementById('final_amount_display').innerText = finalAmount.toFixed(2);
    document.getElementById('fine_amount').value = finalAmount.toFixed(2);
    
    return finalAmount;
}

function updatePenaltyInfo(vehicleType, violationCount, totalAmount) {
    // Determine base rate message based on actual violation types rather than hardcoded values
    var penaltyInfoText = `
        <strong>Number of Violations:</strong> ${violationCount}<br>
        <strong>Total Amount:</strong> ₱${totalAmount.toFixed(2)}<br>
        <strong>Late Payment:</strong> Additional 2% interest per month<br>
        <small class="text-muted">Note: Driver must attend traffic seminar before payment will be accepted.</small>
    `;
    
    document.getElementById('penalty_info').innerHTML = penaltyInfoText;
}

// Generate a unique ID for this form submission to prevent duplicate processing
function generateUniqueId() {
    // Simple UUID v4 generator
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}

// Consolidate all DOMContentLoaded event listeners into one to prevent duplicates
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM fully loaded - initializing all functions');
    
    // Initialize request ID to prevent duplicate submissions
    const requestIdField = document.getElementById('request_id');
    if (requestIdField) {
        requestIdField.value = generateUniqueId();
        console.log('Form initialized with request ID:', requestIdField.value);
    }
    
    // Initialize form submission handling - only attach once
    const violationForm = document.getElementById('violationForm');
    if (violationForm && !violationForm.hasAttribute('data-initialized')) {
        // Mark the form as initialized to prevent duplicate event listeners
        violationForm.setAttribute('data-initialized', 'true');
        
        violationForm.addEventListener('submit', function(e) {
            e.preventDefault();
            console.log('Form submission intercepted with request ID:', requestIdField.value);
            
            // Check if SweetAlert is available
            if (typeof Swal === 'undefined') {
                // Fall back to normal form submission if SweetAlert is not available
                violationForm.submit();
                return;
            }
            
            // Show loading state
            Swal.fire({
                title: 'Saving Violation...',
                text: 'Please wait while we process your submission',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            // Submit the form using AJAX
            const formData = new FormData(violationForm);
            
            fetch(violationForm.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                
                // Check content type to determine how to parse the response
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    return response.json();
                } else {
                    throw new Error('Expected JSON response but received: ' + contentType);
                }
            })
            .then(data => {
                // Check if this is a duplicate submission response
                if (data.status === 'duplicate') {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Duplicate Submission',
                        text: data.message || 'This form has already been processed. Please refresh the page to continue.',
                        confirmButtonText: 'OK'
                    });
                    return;
                }
                
                // Save was successful here - data contains the saved violation information
                console.log('Violation saved successfully with data:', data);
                
                // Store violation ID for later use
                const savedViolationId = data.id || data.violation_id || 'N/A';
                
                // Show success message with print option
                Swal.fire({
                    icon: 'success',
                    title: 'Violation Saved Successfully!',
                    text: 'The NCAP violation has been recorded in the system.',
                    footer: `<span class="text-success">Violation ID: ${savedViolationId}</span>`,
                    confirmButtonText: 'Go to Violations List',
                    showDenyButton: true,
                    denyButtonText: 'Print Form',
                    denyButtonColor: '#3085d6',
                    confirmButtonColor: '#28a745'
                }).then((result) => {
                    if (result.isDenied) {
                        // Print the form using our dedicated print template
                        if (savedViolationId && savedViolationId !== 'N/A') {
                            printViolationForm(savedViolationId);
                        } else {
                            // If no ID is available, print the current window
                            console.log('No violation ID found in response data:', data);
                            Swal.fire({
                                title: 'Printing current form...',
                                text: 'Since no violation ID was returned, we will print the current form.',
                                icon: 'info',
                                timer: 2000,
                                showConfirmButton: false
                            }).then(() => {
                                window.print();
                                // Show success message after printing
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Print Successful',
                                    text: 'The current form has been printed successfully!',
                                    toast: true,
                                    position: 'top-end',
                                    showConfirmButton: false,
                                    timer: 3000,
                                    timerProgressBar: true
                                });
                            });
                        }
                    } else if (result.isConfirmed) {
                        // Show toast notification before redirecting
                        Swal.fire({
                            icon: 'success',
                            title: 'Redirecting...',
                            text: 'Taking you to the NCAP violations list',
                            toast: true,
                            position: 'top-end',
                            showConfirmButton: false,
                            timer: 1500,
                            timerProgressBar: true
                        }).then(() => {
                            // Redirect to the NCAP violations list with success parameter and violation ID
                            window.location.href = '/ncap-violations/?success=true&id=' + (savedViolationId !== 'N/A' ? savedViolationId : '');
                        });
                    }
                });
            })
            .catch(error => {
                console.error('Error:', error);
                
                // Determine the type of error and show appropriate message
                let errorMessage = 'There was a problem submitting the form. Please try again.';
                
                if (error.message.includes('Network response was not ok')) {
                    errorMessage = 'The server returned an error. Please check your form data and try again.';
                } else if (error.message.includes('Expected JSON response')) {
                    errorMessage = 'The server returned an unexpected response format. Please contact support.';
                } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    errorMessage = 'Network connection issue. Please check your internet connection and try again.';
                } else if (error.message.includes('timeout')) {
                    errorMessage = 'The request timed out. Please try again or contact support if the issue persists.';
                }
                
                // Show error message
                Swal.fire({
                    icon: 'error',
                    title: 'Submission Error',
                    text: errorMessage,
                    confirmButtonText: 'OK'
                });
            });
        });
    }
    
    // Initialize other DOM-dependent functions here
    // (Add any other initialization that was previously in separate DOMContentLoaded listeners)
    
    // Ensure vehicle type selectors are initialized only once
    const vehicleTypeSelector = document.getElementById('vehicle_type');
    if (vehicleTypeSelector && !vehicleTypeSelector.hasAttribute('data-initialized')) {
        vehicleTypeSelector.setAttribute('data-initialized', 'true');
        vehicleTypeSelector.addEventListener('change', function() {
            updatePenaltyInfo();
        });
    }
    
    // Initialize the penalty info if needed
    if (typeof updatePenaltyInfo === 'function') {
        updatePenaltyInfo();
    }
});

// Function to handle printing
window.printViolationForm = function(violationId) {
    if (!violationId) {
        console.log('No violation ID provided to printViolationForm');
        // Print current window instead
        window.print();
        return;
    }
    
    // Open print page in a new window using the correct Django URL
    // Modified to ensure NCAP template is used
    const printUrl = "{% url 'print_violation_form' 999999 %}".replace('999999', violationId);
    console.log('Opening print URL:', printUrl);
    
    const printWindow = window.open(printUrl, '_blank');
    
    if (printWindow) {
        // Window opened successfully
        Swal.fire({
            icon: 'success',
            title: 'Print Window Opened',
            text: 'The print dialog should open automatically in the new window.',
            confirmButtonText: 'OK'
        }).then(() => {
            // Show success message after printing
            Swal.fire({
                icon: 'success',
                title: 'Print Successful',
                text: 'The NCAP violation form has been printed successfully!',
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true
            });
        });
    } else {
        // If popup is blocked, inform the user7
        Swal.fire({
            icon: 'warning',
            title: 'Print Window Blocked',
            text: 'Your browser blocked the print window. Please allow popups for this site and try again.',
            confirmButtonText: 'OK'
        });
    }
}

// Operator selection functionality - auto-populate PO number when operator is selected
document.addEventListener('DOMContentLoaded', function() {
    console.log('Initializing operator PO number auto-population');
    
    // Function to update PO number field when an operator is selected
    function updatePONumber(operator) {
        console.log('Operator selected:', operator);
        const operatorPdNumberField = document.getElementById('operator_pd_number');
        
        if (operatorPdNumberField && operator) {
            // Update the PO Number field with the operator's PO number
            operatorPdNumberField.value = operator.po_number || '';
            console.log('Updated operator_pd_number field with:', operator.po_number || '(empty)');
            
            // Dispatch events to trigger any listeners
            operatorPdNumberField.dispatchEvent(new Event('input', { bubbles: true }));
            operatorPdNumberField.dispatchEvent(new Event('change', { bubbles: true }));
            
            // Add visual feedback
            if (operator.po_number) {
                operatorPdNumberField.classList.add('is-valid');
                
                // Add a small check indicator next to the field
                const feedbackElement = document.createElement('div');
                feedbackElement.className = 'valid-feedback';
                feedbackElement.textContent = 'PO Number auto-populated';
                
                // Remove any existing feedback
                const existingFeedback = operatorPdNumberField.parentNode.querySelector('.valid-feedback');
                if (existingFeedback) {
                    existingFeedback.remove();
                }
                
                // Add the new feedback
                operatorPdNumberField.parentNode.appendChild(feedbackElement);
            }
        } else {
            console.warn('Could not find operator_pd_number field or operator data is missing');
        }
    }
    
    // Override the selectOperator function to also update PO number
    const originalSelectOperator = window.selectOperator;
    window.selectOperator = function(operator) {
        // Call the original function if it exists
        if (typeof originalSelectOperator === 'function') {
            originalSelectOperator(operator);
        }
        
        // Update the PO number field
        updatePONumber(operator);
    };
    
    // Hook into the existing operator selection code
    const operatorResults = document.getElementById('operatorResults');
    if (operatorResults) {
        console.log('Found operatorResults element, adding listener for PO number auto-population');
        
        // Use a mutation observer to watch for changes in the results container
        const observer = new MutationObserver(function(mutations) {
            // When the operator results are updated, add event listeners to results
            const resultItems = operatorResults.querySelectorAll('.search-result-item');
            resultItems.forEach(item => {
                // Only add listener if it doesn't already have one
                if (!item.hasAttribute('data-po-listener')) {
                    item.setAttribute('data-po-listener', 'true');
                    item.addEventListener('click', function() {
                        // There's a delay before operator data is populated, so wait briefly
                        setTimeout(() => {
                            const operatorPdNumberField = document.getElementById('operator_pd_number');
                            if (operatorPdNumberField && operatorPdNumberField.value === '') {
                                // Try to extract PO number from the result item itself
                                const poNumberMatch = item.innerHTML.match(/PO:\s*([^<]+)/);
                                if (poNumberMatch && poNumberMatch[1]) {
                                    operatorPdNumberField.value = poNumberMatch[1].trim();
                                    console.log('Extracted PO number from result item:', operatorPdNumberField.value);
                                    operatorPdNumberField.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                }
                        }, 100);
                    });
    }
            });
        });
        
        // Start observing the results container for changes
        observer.observe(operatorResults, { childList: true, subtree: true });
    }
});

</script>

{# Debug script for NCAP violation types - using a separate script tag for Django template tags #}
<script>
// Debug code to check if violation_types are properly loaded
document.addEventListener('DOMContentLoaded', function() {
    // Log the number of NCAP violation types
    {% if violation_types %}
    console.log("NCAP violation types found:", {{ violation_types|length }});
    {% for violation_type in violation_types %}
    console.log("Violation type: {{ violation_type.name }}, Amount: {{ violation_type.amount }}");
    {% endfor %}
    {% else %}
    console.log("WARNING: No NCAP violation types were loaded from the server");
    {% endif %}
    
    // Check if the violation selector is populated
    const violationSelector = document.getElementById('violation_selector');
    if (violationSelector) {
        console.log("Violation selector options count:", violationSelector.options.length);
        console.log("First option text:", violationSelector.options[0] ? violationSelector.options[0].text : "No options");
        if (violationSelector.options.length > 1) {
            console.log("Second option text:", violationSelector.options[1].text);
        } else {
            console.log("WARNING: Only the placeholder option exists in the dropdown!");
        }
    } else {
        console.log("ERROR: violation_selector element not found in the DOM");
    }
});
</script>
{% endblock %}